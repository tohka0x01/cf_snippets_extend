<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CF Snippets Extend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh
        }

        .login-box {
            background: #fff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
            width: 100%;
            max-width: 400px
        }

        .login-box h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px
        }

        .form-group {
            margin-bottom: 20px
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all .2s
        }

        .btn-primary {
            background: #667eea;
            color: #fff
        }

        .btn-primary:hover {
            background: #5568d3
        }

        .btn-success {
            background: #48c774;
            color: #fff
        }

        .btn-success:hover {
            background: #3abb67
        }

        .btn-warning {
            background: #ffdd57;
            color: #333
        }

        .btn-warning:hover {
            background: #ffd83d
        }

        .btn-info {
            background: #3298dc;
            color: #fff
        }

        .btn-info:hover {
            background: #2793da
        }

        .btn-danger {
            background: #f14668;
            color: #fff
        }

        .btn-danger:hover {
            background: #ef2e4a
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
            white-space: nowrap
        }

        .btn-full {
            width: 100%;
            padding: 12px
        }

        .hidden {
            display: none !important
        }

        .header {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-sizing: border-box
        }

        .header h1 {
            color: #667eea;
            font-size: 24px
        }

        .tabs {
            display: flex;
            gap: 10px;
            background: #fff;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .1);
            width: 100%;
            box-sizing: border-box
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            white-space: nowrap
        }

        .tab.active {
            background: #667eea;
            color: #fff
        }

        .panel {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .1);
            width: 100%;
            box-sizing: border-box
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px
        }

        .panel-header h2 {
            font-size: 18px;
            color: #333
        }

        .table {
            width: 100%;
            border-collapse: collapse
        }

        .table th,
        .table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
            font-size: 14px;
            vertical-align: middle
        }

        .table th {
            background: #f7f9fc;
            color: #333;
            font-weight: 600
        }

        .table th.sort-header {
            cursor: pointer;
            user-select: none;
            transition: background .2s
        }

        .table th.sort-header:hover {
            background: #eef1f5
        }

        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px
        }

        .badge-info {
            background: #e3f2fd;
            color: #1976d2
        }

        .actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: nowrap
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000
        }

        .modal-content {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 450px
        }

        .modal-content-large {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px
        }

        .modal-header h3 {
            font-size: 18px;
            color: #333
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32
        }

        .alert-error {
            background: #ffebee;
            color: #c62828
        }

        .result-box {
            background: #f7f9fc;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px
        }

        .result-box pre {
            background: #fff;
            padding: 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 150px;
            overflow: auto
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            border-radius: 22px
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: .3s
        }

        input:checked+.slider {
            background: #667eea
        }

        input:checked+.slider:before {
            transform: translateX(18px)
        }

        .addr-cell {
            max-width: 200px;
            word-break: break-all;
            cursor: help
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 16px
        }

        .outbound-card {
            background: #fff;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 12px;
            position: relative;
            transition: all .3s;
            min-width: 0;
            overflow: hidden
        }

        .outbound-card:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, .2)
        }

        .outbound-card.offline {
            border-color: #e1e8ed;
            background: #fff
        }

        .outbound-card.online {
            border-color: #e1e8ed;
            background: #fff
        }

        .outbound-card.tested-online {
            border-color: #48c774;
            background: #f0fdf4
        }

        .outbound-card.tested-offline {
            border-color: #f14668;
            background: #fff5f7
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            min-width: 0;
            overflow: hidden
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            min-width: 0
        }

        .card-checkbox {
            position: absolute;
            top: 10px;
            right: 10px
        }

        .card-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            margin-bottom: 6px
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block
        }

        .status-dot.online {
            background: #48c774
        }

        .status-dot.offline {
            background: #f14668
        }

        .status-dot.unknown {
            background: #999
        }

        .card-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.5;
            min-width: 0;
            overflow: hidden
        }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            overflow: hidden;
            min-width: 0
        }

        .card-info-row>span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            min-width: 0
        }

        .card-latency {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 8px 0;
            min-height: 28px
        }

        .card-latency.good {
            color: #48c774
        }

        .card-latency.medium {
            color: #ffdd57
        }

        .card-latency.bad {
            color: #f14668
        }

        .card-latency.unknown {
            color: #999;
            font-size: 13px
        }

        .card-actions {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
            margin-top: 10px
        }

        .card-actions .btn {
            flex: 0 0 auto;
            min-width: auto
        }

        .card-actions .card-latency {
            flex: 1;
            text-align: left;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            min-height: auto;
            display: flex;
            align-items: center
        }

        .exit-link {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            transition: all .2s
        }

        .exit-link:hover {
            color: #5568d3;
            text-decoration: underline;
            font-weight: 600
        }

        @media (max-width:768px) {
            .container {
                padding: 10px
            }

            .header {
                flex-direction: column;
                gap: 8px;
                align-items: stretch
            }

            .header h1 {
                font-size: 18px;
                text-align: center
            }

            .header>div {
                justify-content: center;
                flex-wrap: wrap;
                gap: 6px
            }

            #toggleGlobalViewBtn {
                display: none !important
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding: 8px 10px
            }

            .tab {
                flex-shrink: 0;
                font-size: 12px;
                padding: 6px 12px
            }

            .panel {
                padding: 12px;
                background: #fff;
                border-radius: 16px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, .1)
            }

            .panel-header {
                flex-direction: column;
                gap: 6px;
                align-items: stretch
            }

            .panel-header h2 {
                font-size: 14px;
                text-align: center;
                margin-bottom: 4px
            }

            .panel-header>div {
                display: flex !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                gap: 6px !important;
                padding: 4px 0 !important;
                justify-content: flex-start !important;
                scrollbar-width: thin;
                width: 100%
            }

            .panel-header>div::-webkit-scrollbar {
                height: 4px
            }

            .panel-header>div::-webkit-scrollbar-thumb {
                background: #667eea;
                border-radius: 2px
            }

            .panel-header .btn {
                font-size: 12px !important;
                padding: 6px 12px !important;
                white-space: nowrap !important;
                flex: 0 0 auto !important;
                min-width: fit-content !important
            }

            .panel>div[style*="background:#e8f0fe"] {
                font-size: 11px;
                padding: 8px;
                margin-bottom: 8px
            }

            #proxyipListView,
            #outboundListView,
            #cfipListView,
            #argoListView {
                display: none !important
            }

            #proxyipCardView,
            #outboundCardView,
            #cfipCardView,
            #argoCardView {
                display: grid !important
            }

            .card-grid {
                grid-template-columns: 1fr;
                gap: 10px
            }

            .outbound-card {
                padding: 10px
            }

            .card-title {
                font-size: 14px
            }

            .card-info {
                font-size: 11px;
                margin-bottom: 6px
            }

            .card-info-row {
                font-size: 11px;
                margin-bottom: 2px
            }

            .card-actions {
                gap: 8px;
                margin-top: 8px
            }

            .modal-content,
            .modal-content-large {
                width: 95%;
                max-width: 95%;
                margin: 10px;
                padding: 12px
            }

            .modal-header h3 {
                font-size: 16px
            }

            .form-group {
                margin-bottom: 12px
            }

            .form-group label {
                font-size: 13px
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 13px;
                padding: 8px
            }

            .login-box {
                padding: 20px;
                margin: 10px
            }

            .login-box h1 {
                font-size: 20px
            }

            .result-box {
                padding: 12px
            }

            .result-box pre {
                font-size: 10px;
                max-height: 100px;
                padding: 8px
            }

            .switch {
                width: 36px;
                height: 20px
            }

            .switch .slider:before {
                height: 14px;
                width: 14px;
                left: 3px;
                bottom: 3px
            }

            .switch input:checked+.slider:before {
                transform: translateX(16px)
            }
        }
    </style>
</head>

<body>
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1 style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">🔐 CF Snippets Extend</h1>
            <div id="loginAlert"></div>
            <div class="form-group"><label>API Key</label><input type="password" id="apiKeyInput"
                    placeholder="请输入 API Key"></div>
            <button class="btn btn-primary btn-full" onclick="login()">登录</button>
            <div style="text-align:center;margin-top:16px">
                <a href="https://github.com/assast/cf_snippets_extend" target="_blank"
                    style="display:inline-flex;align-items:center;gap:4px;color:#667eea;text-decoration:none;font-size:13px;transition:all .2s"
                    onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                    <svg height="14" width="14" viewBox="0 0 16 16" fill="currentColor">
                        <path
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                        </path>
                    </svg>
                    ⭐ Star on GitHub
                </a>
            </div>
        </div>
    </div>

    <div id="mainPage" class="container hidden">
        <div class="header">
            <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
                <h1 style="margin:0;white-space:nowrap">📡 CF Snippets Extend</h1>
                <a href="https://github.com/assast/cf_snippets_extend" target="_blank"
                    style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:#24292e;color:#fff;text-decoration:none;border-radius:4px;font-size:11px;transition:all .2s;white-space:nowrap"
                    onmouseover="this.style.background='#1a1e22'" onmouseout="this.style.background='#24292e'">
                    <svg height="12" width="12" viewBox="0 0 16 16" fill="currentColor">
                        <path
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                        </path>
                    </svg>
                    Star
                </a>
            </div>
            <div style="display:flex;gap:8px;flex-shrink:0;justify-content:flex-end"><button id="toggleGlobalViewBtn"
                    class="btn btn-primary btn-sm" data-icon="📋" onclick="toggleGlobalView()">📋 切换卡片</button><button
                    class="btn btn-success btn-sm" data-icon="📤" onclick="exportData()">📤 导出</button><button
                    class="btn btn-primary btn-sm" data-icon="📥" onclick="importData()">📥 导入</button><button
                    class="btn btn-danger btn-sm" data-icon="🚪" onclick="logout()">🚪 退出</button></div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('proxyip',this)">ProxyIP(反代IP)</button>
            <button class="tab" onclick="switchTab('outbound',this)">全局出站</button>
            <button class="tab" onclick="switchTab('cfip',this)">CFIP(优选域名)</button>
            <button class="tab" onclick="switchTab('vlSubscribe',this)">订阅生成V<span>LESS</span></button>
            <button class="tab" onclick="switchTab('ssSubscribe',this)">订阅生成SS</button>
            <button class="tab" onclick="switchTab('argo',this)">ARGO优选</button>
        </div>

        <div id="proxyipPanel" class="panel">
            <div class="panel-header">
                <h2>ProxyIP(反代IP) 管理</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn btn-primary btn-sm" data-icon="➕" onclick="showBatchModal('proxyip')">➕
                        添加</button>
                    <button class="btn btn-success btn-sm" data-icon="✓" onclick="batchEnable('proxyip',true)">✓
                        启用</button>
                    <button class="btn btn-warning btn-sm" data-icon="✗" onclick="batchEnable('proxyip',false)">✗
                        禁用</button>
                    <button class="btn btn-danger btn-sm" data-icon="🗑️" onclick="batchDelete('proxyip')">🗑️
                        删除</button>
                </div>
            </div>
            <div
                style="background:#e8f0fe;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px;color:#1967d2">
                <strong>💡 说明：</strong>ProxyIP(反代IP) 用于普通 IP/域名代理，不支持 SOCKS5/HTTP 协议。如需添加 SOCKS5/HTTP
                代理，请使用"全局出站"功能。<br>
                <strong>📊 节点数量计算：</strong>订阅节点数量 = (反代IP数量 + 全局出站数量) × 优选域名数量。<strong
                    style="color:#f14668">不添加反代IP的话，不会生成原生节点。</strong>
            </div>
            <div id="proxyipListView">
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="proxyipCheckAll" onchange="checkAll('proxyip',this.checked)">
                            </th>
                            <th>ID</th>
                            <th>地址</th>
                            <th>备注</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="proxyipTable"></tbody>
                </table>
            </div>
            <div id="proxyipCardView" class="card-grid hidden"></div>
        </div>

        <div id="outboundPanel" class="panel hidden">
            <div class="panel-header">
                <h2>全局出站管理</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button id="toggleMaskBtn" class="btn btn-warning btn-sm" data-icon="�️"
                        onclick="toggleAddressMask()">�️ 显示地址</button>
                    <button class="btn btn-primary btn-sm" data-icon="➕" onclick="showBatchModal('outbound')">➕
                        添加</button>
                    <button class="btn btn-success btn-sm" data-icon="✓" onclick="batchEnable('outbound',true)">✓
                        启用</button>
                    <button class="btn btn-warning btn-sm" data-icon="✗" onclick="batchEnable('outbound',false)">✗
                        禁用</button>
                    <button class="btn btn-success btn-sm" data-icon="🔍" onclick="testAllOutbounds()">🔍 全量测速</button>
                    <button class="btn btn-primary btn-sm" data-icon="🌍" onclick="checkAllExits()">🌍 出站检测</button>
                    <button class="btn btn-danger btn-sm" data-icon="🗑️" onclick="batchDelete('outbound')">🗑️
                        删除</button>
                </div>
            </div>
            <div
                style="background:#e8f0fe;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px;color:#1967d2">
                <strong>💡 测速说明：</strong><br>
                1、测速过程仅从CF的边缘节点发起连接，所以被墙的节点也可以测延迟，同时因为不会过墙，所以不会导致节点被墙；延迟仅代表CF边缘节点到socks5/http节点的延迟，用于判断节点是否连通，实际使用受优选IP/域名影响可能差异较大。<br>
                2、本地代理（127.0.0.1）无法从 CF 访问会显示离线。
            </div>
            <div id="outboundListView">
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="outboundCheckAll"
                                    onchange="checkAll('outbound',this.checked)"></th>
                            <th>ID</th>
                            <th>地址</th>
                            <th>类型</th>
                            <th>出站信息</th>
                            <th>备注</th>
                            <th>延迟</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="outboundTable"></tbody>
                </table>
            </div>
            <div id="outboundCardView" class="card-grid hidden"></div>
        </div>

        <div id="cfipPanel" class="panel hidden">
            <div class="panel-header" style="margin-bottom:12px">
                <h2>CFIP(优选域名) 管理</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center">
                    <button class="btn btn-primary btn-sm" data-icon="➕" onclick="showBatchModal('cfip')">➕ 添加</button>
                    <select id="cfipBatchStatus"
                        style="padding:4px 8px;border:1px solid #e1e8ed;border-radius:4px;font-size:12px">
                        <option value="enabled">启用</option>
                        <option value="disabled">禁用</option>
                        <option value="invalid">失效</option>
                    </select>
                    <button class="btn btn-info btn-sm" data-icon="✓" onclick="batchSetStatus('cfip')">设置状态</button>
                    <button class="btn btn-danger btn-sm" data-icon="🗑️" onclick="batchDelete('cfip')">🗑️ 删除</button>
                    <div style="position:relative">
                        <button class="btn btn-sm" style="background:#f0f0f0;border:1px solid #ddd"
                            onclick="toggleCFIPSettings(event)">⚙️ 设置</button>
                        <div id="cfipSettingsDropdown" class="hidden"
                            style="position:absolute;top:100%;right:0;margin-top:4px;background:#fff;border:1px solid #e1e8ed;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);padding:12px;z-index:100;min-width:180px">
                            <div
                                style="font-size:13px;font-weight:600;color:#333;margin-bottom:10px;border-bottom:1px solid #eee;padding-bottom:8px">
                                显示列设置</div>
                            <label
                                style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#555;margin-bottom:8px">
                                <input type="checkbox" id="cfipShowRemark" onchange="toggleCFIPColumn('remark')"> 备注
                                (Remark)
                            </label>
                            <label
                                style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#555;margin-bottom:8px">
                                <input type="checkbox" id="cfipShowFailCount" onchange="toggleCFIPColumn('fail_count')">
                                失败次数
                            </label>
                            <label
                                style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#555;margin-bottom:8px">
                                <input type="checkbox" id="cfipShowLatency" onchange="toggleCFIPColumn('latency')"> 延迟
                                (ms)
                            </label>
                            <label
                                style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#555">
                                <input type="checkbox" id="cfipShowSpeed" onchange="toggleCFIPColumn('speed')"> 下载速度
                                (MB/s)
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Pagination at top -->
            <div
                style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:10px;background:#f7f9fc;border-radius:8px">
                <button id="cfipPrevBtnTop" class="btn btn-primary btn-sm" onclick="changeCFIPPage(-1)">◀ 上一页</button>
                <span id="cfipPageInfoTop" style="font-size:13px;color:#666">Page 1 of 1 (Total 0)</span>
                <button id="cfipNextBtnTop" class="btn btn-primary btn-sm" onclick="changeCFIPPage(1)">下一页 ▶</button>
            </div>
            <div
                style="display:flex;gap:12px;margin-bottom:12px;align-items:center;background:#f7f9fc;padding:8px;border-radius:8px">
                <div style="flex:1">
                    <input type="text" placeholder="🔍 搜索 IP / 端口 / 备注..."
                        style="width:100%;padding:6px 10px;border:1px solid #e1e8ed;border-radius:6px;font-size:13px"
                        oninput="handleCFIPSearch(event)">
                </div>
                <div
                    style="display:flex;align-items:center;gap:12px;font-size:13px;color:#666;border-left:1px solid #e1e8ed;padding-left:12px">
                    <span>状态:</span>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox"
                            value="all" checked onchange="handleCFIPStatusChange(event)"> 全选</label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox"
                            class="cfip-status-check" value="enabled" checked onchange="handleCFIPStatusChange(event)">
                        启用</label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox"
                            class="cfip-status-check" value="disabled" checked onchange="handleCFIPStatusChange(event)">
                        禁用</label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox"
                            class="cfip-status-check" value="invalid" checked onchange="handleCFIPStatusChange(event)">
                        失效</label>
                </div>
                <div style="display:flex;align-items:center;gap:6px;font-size:13px;color:#666">
                    每页显示:
                    <select style="padding:4px 8px;border:1px solid #e1e8ed;border-radius:4px;font-size:13px"
                        onchange="handleCFIPPageSize(event)">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                        <option value="2000">2000</option>
                        <option value="5000">5000</option>
                    </select>
                </div>
            </div>
            <div
                style="background:#e8f0fe;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px;color:#1967d2">
                <strong>💡 说明：</strong>CFIP(优选域名) 用于配置 Cloudflare 优选 IP 或域名，作为节点的连接地址。<br>
                <strong>📊 节点数量计算：</strong>订阅节点数量 = (反代IP数量 + 全局出站数量) × 优选域名数量。
            </div>
            <div id="cfipListView">
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="cfipCheckAll" onchange="checkAll('cfip',this.checked)"></th>
                            <th class="sort-header" onclick="handleCFIPSort('id')">ID <span id="sort-icon-id"></span>
                            </th>
                            <th class="sort-header" onclick="handleCFIPSort('name')">别名 (Name) <span
                                    id="sort-icon-name"></span></th>
                            <th class="sort-header cfip-col-remark hidden" onclick="handleCFIPSort('remark')">备注
                                (Remark) <span id="sort-icon-remark"></span></th>
                            <th class="sort-header" onclick="handleCFIPSort('address')">地址 <span
                                    id="sort-icon-address"></span></th>
                            <th class="sort-header" onclick="handleCFIPSort('port')">端口 <span
                                    id="sort-icon-port"></span></th>
                            <th class="sort-header cfip-col-fail_count hidden" onclick="handleCFIPSort('fail_count')">
                                失败次数 <span id="sort-icon-fail_count"></span></th>
                            <th class="sort-header cfip-col-latency hidden" onclick="handleCFIPSort('latency')">延迟 <span
                                    id="sort-icon-latency"></span></th>
                            <th class="sort-header cfip-col-speed hidden" onclick="handleCFIPSort('speed')">速度 (MB/s)
                                <span id="sort-icon-speed"></span>
                            </th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="cfipTable"></tbody>
                </table>
            </div>
            <div id="cfipCardView" class="card-grid hidden"></div>

            <div
                style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding:10px;background:#f7f9fc;border-radius:8px">
                <button id="cfipPrevBtn" class="btn btn-primary btn-sm" onclick="changeCFIPPage(-1)">◀ 上一页</button>
                <span id="cfipPageInfo" style="font-size:13px;color:#666">Page 1 of 1 (Total 0)</span>
                <button id="cfipNextBtn" class="btn btn-primary btn-sm" onclick="changeCFIPPage(1)">下一页 ▶</button>
            </div>
        </div>

        <div id="vlSubscribePanel" class="panel hidden">
            <div class="panel-header">
                <h2>V<span>LESS</span> 订阅配置</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn btn-primary btn-sm" data-icon="➕" onclick="showSubscribeModal('vl' + 'ess')">➕
                        添加配置</button>
                </div>
            </div>

            <div id="vlAlert"></div>

            <div
                style="background:#fff3cd;border-left:4px solid #ffc107;padding:12px;border-radius:6px;margin-bottom:16px;font-size:13px;color:#856404">
                <strong>💡 高级用法：指定ID生成订阅</strong><br>
                在订阅URL后添加参数可以生成指定节点的订阅：<br>
                • <code>?proxyip=1,2,3</code> - 指定ProxyIP的ID（多个用逗号分隔）<br>
                • <code>?outbound=1,2</code> - 指定全局出站的ID<br>
                • <code>?cfip=1,2,3</code> - 指定CFIP的ID<br>
                • <code>?proxyip=1&outbound=2&cfip=1,2</code> - 组合使用<br>
                <strong style="color:#d9534f">⚠️ 指定ID时不检查启用状态</strong>，即使被禁用也会包含在订阅中。
            </div>

            <div id="vlConfigList"></div>
        </div>

        <div id="ssSubscribePanel" class="panel hidden">
            <div class="panel-header">
                <h2>Shadowsocks 订阅配置</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn btn-primary btn-sm" data-icon="➕" onclick="showSubscribeModal('ss')">➕
                        添加配置</button>
                </div>
            </div>

            <div id="ssAlert"></div>

            <div
                style="background:#fff3cd;border-left:4px solid #ffc107;padding:12px;border-radius:6px;margin-bottom:16px;font-size:13px;color:#856404">
                <strong>💡 高级用法：指定ID生成订阅</strong><br>
                在订阅URL后添加参数可以生成指定节点的订阅：<br>
                • <code>?proxyip=1,2,3</code> - 指定ProxyIP的ID（多个用逗号分隔）<br>
                • <code>?outbound=1,2</code> - 指定全局出站的ID<br>
                • <code>?cfip=1,2,3</code> - 指定CFIP的ID<br>
                • <code>?proxyip=1&outbound=2&cfip=1,2</code> - 组合使用<br>
                <strong style="color:#d9534f">⚠️ 指定ID时不检查启用状态</strong>，即使被禁用也会包含在订阅中。
            </div>

            <div id="ssConfigList"></div>
        </div>

        <div id="argoPanel" class="panel hidden">
            <div class="panel-header">
                <h2>ARGO 优选订阅管理</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn btn-primary btn-sm" data-icon="➕" onclick="showBatchModal('argo')">➕
                        添加配置</button>
                </div>
            </div>

            <div
                style="background:#e8f0fe;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px;color:#1967d2">
                <strong>💡 说明：</strong><br>
                1、ARGO 优选订阅用于管理 V<span>LESS</span>/V<span>Mess</span> 模板链接，系统会自动将模板中的"优选域名/IP:端口"替换为所有启用的
                CFIP，生成多个优化节点。<br>
                2、支持 V<span>LESS</span> 和 V<span>Mess</span> 两种协议。<br>
                3、节点数量：每个模板会生成 N 个节点（N = 启用的 CFIP 数量）。
            </div>

            <div id="argoConfigList"></div>
        </div>
    </div>

    <div id="addModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">添加</h3><button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
            <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="submitModal()">确定</button>
        </div>
    </div>

    <div id="batchModal" class="modal hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="modal-header">
                <h3 id="batchModalTitle">批量添加</h3><button class="close-btn" onclick="closeBatchModal()">&times;</button>
            </div>
            <div id="batchAlert"></div>
            <div id="batchHelp"
                style="background:#f7f9fc;padding:10px;border-radius:6px;margin-bottom:12px;font-size:12px;color:#666">
            </div>
            <div class="form-group"><label>批量数据（每行一条）</label><textarea id="batchInput" rows="10"
                    style="width:100%;padding:12px;border:2px solid #e1e8ed;border-radius:8px;font-size:14px;font-family:monospace"></textarea>
            </div>
            <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="submitBatch()">批量添加</button>
        </div>
    </div>

    <div id="loadingOverlay" class="loading hidden">
        <div class="loading-spinner"></div>
    </div>

    <input type="file" id="importFileInput" accept=".json" style="display:none"
        onchange="handleImportFileSelect(event)">

    <div id="importModeModal" class="modal hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h3>选择导入模式</h3><button class="close-btn" onclick="closeImportModeModal()">&times;</button>
            </div>
            <div style="margin-bottom:20px;font-size:14px;color:#666">
                <p style="margin-bottom:12px">请选择导入方式：</p>
            </div>
            <button class="btn btn-success" style="width:100%;margin-bottom:12px;padding:16px;text-align:left"
                onclick="confirmImportMode('append')">
                <div style="font-size:16px;font-weight:bold;margin-bottom:4px">📥 作为新数据导入</div>
                <div style="font-size:12px;opacity:0.9">将导入的数据添加到现有数据中，不会删除任何现有数据</div>
            </button>
            <button class="btn btn-danger" style="width:100%;padding:16px;text-align:left"
                onclick="confirmImportMode('replace')">
                <div style="font-size:16px;font-weight:bold;margin-bottom:4px">⚠️ 完全覆盖导入</div>
                <div style="font-size:12px;opacity:0.9">删除所有现有数据，然后导入新数据（危险操作）</div>
            </button>
        </div>
    </div>

    <div id="exitDetailModal" class="modal hidden" onclick="if(event.target===this)closeExitDetail()">
        <div class="modal-content-large">
            <div class="modal-header">
                <h3>出入站详细信息</h3><button class="close-btn" onclick="closeExitDetail()">&times;</button>
            </div>
            <div id="exitDetailBody" style="font-size:14px;line-height:1.8"></div>
        </div>
    </div>

    <div id="clashSettingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Clash 订阅设置</h3>
                <button class="close-btn" onclick="closeClashSettings()">&times;</button>
            </div>
            <div class="form-group">
                <label>排除节点 (正则表达式)</label>
                <input type="text" id="clashExclude" placeholder="例如: 流量|官网">
            </div>
            <div class="form-group">
                <label>包含节点 (正则表达式)</label>
                <input type="text" id="clashInclude" placeholder="例如: 香港|日本">
            </div>
            <div class="form-group" style="display:flex;align-items:center;justify-content:space-between">
                <label style="margin:0">启用 Emoji</label>
                <label class="switch">
                    <input type="checkbox" id="clashEmoji" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="alert alert-info" style="font-size:12px;margin-top:12px;background:#e3f2fd;color:#0d47a1">
                设置将保存在本地，并应用于生成的 Clash 订阅链接。
            </div>
            <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="saveClashSettings()">保存设置</button>
        </div>
    </div>

    <script>
        const API = '/api';
        let apiKey = localStorage.getItem('apiKey'), modalType = '', editId = null;
        let showFullAddress = false; // 是否显示完整地址
        let globalViewMode = localStorage.getItem('globalViewMode') || 'list'; // 全局视图模式：list 或 card

        // Global state for CFIP pagination and search
        let cfipSearchText = '';
        let cfipStatusFilter = ['enabled', 'disabled', 'invalid'];
        let cfipPageSize = 20;
        let cfipCurrentPage = 1;
        // Column visibility settings (default: hide optional columns)
        // Load from localStorage if available
        let cfipColumnSettings = (function () {
            const saved = localStorage.getItem('cfipColumnSettings');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to parse cfipColumnSettings from localStorage', e);
                }
            }
            return {
                remark: false,
                fail_count: false,
                latency: false,
                speed: false
            };
        })();

        // 全局缓存数据用于查重
        let cachedProxyIPs = [];
        let cachedOutbounds = [];
        let cachedCFIPs = [];
        let cachedArgoList = [];
        let cachedVlConfigs = [];
        let cachedSSConfigs = [];

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden') }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden') }

        function toggleGlobalView() {
            globalViewMode = globalViewMode === 'list' ? 'card' : 'list';
            localStorage.setItem('globalViewMode', globalViewMode);
            const btn = document.getElementById('toggleGlobalViewBtn');
            if (globalViewMode === 'card') {
                btn.textContent = '📋 切换列表';
                btn.setAttribute('data-icon', '📋');
            } else {
                btn.textContent = '📋 切换卡片';
                btn.setAttribute('data-icon', '📋');
            }
            loadProxyIPs();
            loadOutbounds();
            loadCFIPs();
            loadArgoSubscribes();
        }

        function toggleAddressMask() {
            showFullAddress = !showFullAddress;
            const btn = document.getElementById('toggleMaskBtn');
            if (showFullAddress) {
                btn.textContent = '🔒 隐藏地址';
                btn.setAttribute('data-icon', '🔒');
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
            } else {
                btn.textContent = '👁️ 显示地址';
                btn.setAttribute('data-icon', '👁️');
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }
            loadOutbounds();
        }

        function maskAddress(addr) {
            if (!addr) return '-';
            // 如果选择显示完整地址，直接返回
            if (showFullAddress) return addr;
            // 只处理 socks5:// 和 http:// 开头的地址
            if (addr.includes('://')) {
                // 完全隐藏地址，只显示 ***
                return '***';
            }
            // 其他地址不处理
            return addr;
        }

        document.addEventListener('DOMContentLoaded', () => { if (apiKey) checkSession() });
        document.getElementById('apiKeyInput').onkeypress = e => { if (e.key === 'Enter') login() };

        async function checkSession() {
            showLoading();
            try { const r = await fetch(API + '/proxyip', { headers: { 'X-API-Key': apiKey } }); if (r.ok) { showMain(); load() } else logout() } catch (e) { logout() }
            finally { hideLoading() }
        }

        async function login() {
            const k = document.getElementById('apiKeyInput').value.trim();
            if (!k) return alert('请输入API Key');
            showLoading();
            try {
                const r = await fetch(API + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ apiKey: k }) });
                const d = await r.json();
                if (d.success) { apiKey = d.apiKey; localStorage.setItem('apiKey', apiKey); showMain(); load() }
                else alert(d.error || '登录失败');
            } catch (e) { alert('网络错误') }
            finally { hideLoading() }
        }

        function logout() { apiKey = null; localStorage.removeItem('apiKey'); document.getElementById('loginPage').classList.remove('hidden'); document.getElementById('mainPage').classList.add('hidden') }
        function showMain() { document.getElementById('loginPage').classList.add('hidden'); document.getElementById('mainPage').classList.remove('hidden') }

        function switchTab(t, el) {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(x => x.classList.add('hidden'));
            el.classList.add('active'); document.getElementById(t + 'Panel').classList.remove('hidden');
        }

        async function api(path, method = 'GET', body = null) {
            const opt = { method, headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey } };
            if (body) opt.body = JSON.stringify(body);
            return (await fetch(API + path, opt)).json();
        }

        async function load() {
            showLoading();
            try {
                await Promise.all([loadProxyIPs(), loadOutbounds(), loadCFIPs(), loadVlConfig(), loadSSConfig(), loadArgoSubscribes()]);
                // 更新全局视图切换按钮文本
                const btn = document.getElementById('toggleGlobalViewBtn');
                if (btn) {
                    if (globalViewMode === 'card') {
                        btn.textContent = '📋 切换列表';
                        btn.setAttribute('data-icon', '📋');
                    } else {
                        btn.textContent = '📋 切换卡片';
                        btn.setAttribute('data-icon', '📋');
                    }
                }
            } finally {
                hideLoading();
            }
        }

        function showClashSettings() {
            const settings = JSON.parse(localStorage.getItem('clashSettings') || '{}');
            document.getElementById('clashExclude').value = settings.exclude || '';
            document.getElementById('clashInclude').value = settings.include || '';
            document.getElementById('clashEmoji').checked = settings.emoji !== false;
            document.getElementById('clashSettingsModal').classList.remove('hidden');
        }

        function closeClashSettings() {
            document.getElementById('clashSettingsModal').classList.add('hidden');
        }

        function saveClashSettings() {
            const settings = {
                exclude: document.getElementById('clashExclude').value.trim(),
                include: document.getElementById('clashInclude').value.trim(),
                emoji: document.getElementById('clashEmoji').checked
            };
            localStorage.setItem('clashSettings', JSON.stringify(settings));
            closeClashSettings();
            loadVlConfig();
            loadSSConfig();
            alert('设置已保存');
        }

        function getClashUrl(subUrl) {
            const settings = JSON.parse(localStorage.getItem('clashSettings') || '{}');
            let url = `${location.origin}/sub/clash?url=${encodeURIComponent(subUrl)}`;
            if (settings.exclude) url += `&exclude=${encodeURIComponent(settings.exclude)}`;
            if (settings.include) url += `&include=${encodeURIComponent(settings.include)}`;
            if (settings.emoji === false) url += `&emoji=false`;
            return url;
        }

        function copyClashSub(subUrl) {
            const url = getClashUrl(subUrl);
            copyText(url);
        }

        async function loadVlConfig() {
            const d = await api('/subscribe/config?type=' + 'vl' + 'ess');
            if (!d.success) return;
            cachedVlConfigs = d.data; // 更新缓存

            const list = document.getElementById('vlConfigList');
            if (d.data.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">暂无配置，点击"添加配置"开始</div>';
                return;
            }

            list.innerHTML = d.data.map(item => {
                const subUrl = `${location.origin}/sub/token/${item.token}`;
                const statusClass = item.enabled ? 'online' : 'offline';
                const statusText = item.enabled ? '已启用' : '已禁用';
                return `
<div class="outbound-card ${statusClass}" style="margin-bottom:16px">
<div class="card-header">
<div style="flex:1">
<div class="card-title">${item.remark || 'V<span>LESS</span>订阅-' + item.id}</div>
<div style="font-size:11px;color:#999;margin-top:4px">Token: ${item.token} | UUID: ${item.uuid}</div>
</div>
<span class="badge badge-${item.enabled ? 'success' : 'secondary'}">${statusText}</span>
</div>
<div class="card-info">
<div class="card-info-row"><strong>域名:</strong> ${item.snippets_domain}</div>
<div class="card-info-row"><strong>路径:</strong> ${item.proxy_path || '/?ed=2560'}</div>
<div class="card-info-row">
<strong>订阅地址:</strong>
<code style="font-size:11px;word-break:break-all;display:block;margin-top:4px;padding:6px;background:#f5f5f5;border-radius:4px">${subUrl}</code>
</div>
</div>
<div class="card-actions">
<button class="btn btn-success btn-sm" onclick="copyText('${subUrl}')">📋 复制订阅</button>
<button class="btn btn-success btn-sm" onclick="copyClashSub('${subUrl}')">📋 复制Clash订阅</button>
<button class="btn btn-info btn-sm" onclick="showClashSettings()">⚙️ 转换设置</button>
<button class="btn btn-warning btn-sm" onclick="editSubscribeConfig('vl',${item.id})">✏️ 编辑</button>
<button class="btn btn-info btn-sm" onclick="resetSubscribeToken(${item.id})">🔄 重置Token</button>
<button class="btn btn-${item.enabled ? 'secondary' : 'success'} btn-sm" onclick="toggleSubscribeEnable(${item.id},${!item.enabled})">${item.enabled ? '禁用' : '启用'}</button>
<button class="btn btn-danger btn-sm" onclick="deleteSubscribeConfig(${item.id})">🗑️ 删除</button>
</div>
</div>
`;
            }).join('');
        }

        async function loadSSConfig() {
            const d = await api('/subscribe/config?type=ss');
            if (!d.success) return;
            cachedSSConfigs = d.data; // 更新缓存

            const list = document.getElementById('ssConfigList');
            if (d.data.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">暂无配置，点击"添加配置"开始</div>';
                return;
            }

            list.innerHTML = d.data.map(item => {
                const subUrl = `${location.origin}/sub/token/${item.token}`;
                const statusClass = item.enabled ? 'online' : 'offline';
                const statusText = item.enabled ? '已启用' : '已禁用';
                return `
<div class="outbound-card ${statusClass}" style="margin-bottom:16px">
<div class="card-header">
<div style="flex:1">
<div class="card-title">${item.remark || 'SS订阅-' + item.id}</div>
<div style="font-size:11px;color:#999;margin-top:4px">Token: ${item.token} | 密码: ${item.uuid}</div>
</div>
<span class="badge badge-${item.enabled ? 'success' : 'secondary'}">${statusText}</span>
</div>
<div class="card-info">
<div class="card-info-row"><strong>域名:</strong> ${item.snippets_domain}</div>
<div class="card-info-row"><strong>路径:</strong> ${item.proxy_path || '/' + item.uuid}</div>
<div class="card-info-row">
<strong>订阅地址:</strong>
<code style="font-size:11px;word-break:break-all;display:block;margin-top:4px;padding:6px;background:#f5f5f5;border-radius:4px">${subUrl}</code>
</div>
</div>
<div class="card-actions">
<button class="btn btn-success btn-sm" onclick="copyText('${subUrl}')">📋 复制订阅</button>
<button class="btn btn-success btn-sm" onclick="copyClashSub('${subUrl}')">📋 复制Clash订阅</button>
<button class="btn btn-info btn-sm" onclick="showClashSettings()">⚙️ 转换设置</button>
<button class="btn btn-warning btn-sm" onclick="editSubscribeConfig('ss',${item.id})">✏️ 编辑</button>
<button class="btn btn-info btn-sm" onclick="resetSubscribeToken(${item.id})">🔄 重置Token</button>
<button class="btn btn-${item.enabled ? 'secondary' : 'success'} btn-sm" onclick="toggleSubscribeEnable(${item.id},${!item.enabled})">${item.enabled ? '禁用' : '启用'}</button>
<button class="btn btn-danger btn-sm" onclick="deleteSubscribeConfig(${item.id})">🗑️ 删除</button>
</div>
</div>
`;
            }).join('');
        }

        async function loadArgoSubscribes() {
            const d = await api('/argo');
            if (!d.success) return;
            cachedArgoList = d.data; // 更新缓存

            const list = document.getElementById('argoConfigList');
            if (d.data.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">暂无配置，点击"添加"开始</div>';
                return;
            }

            list.innerHTML = d.data.map(item => {
                const subUrl = `${location.origin}/sub/argo/${item.token}`;
                const statusClass = item.enabled ? 'online' : 'offline';
                const statusText = item.enabled ? '已启用' : '已禁用';
                const protocol = item.template_link.startsWith('vl' + 'ess://') ? 'V<span>LESS</span>' : (item.template_link.startsWith('vm' + 'ess://') ? 'V<span>Mess</span>' : '未知');

                return `
<div class="outbound-card ${statusClass}" style="margin-bottom:16px">
<div class="card-header">
<div style="flex:1">
<div class="card-title">${item.remark || 'ARGO-' + item.id}</div>
<div style="font-size:11px;color:#999;margin-top:4px">ID: ${item.id} | 协议: <span class="badge badge-info">${protocol}</span></div>
</div>
<span class="badge badge-${item.enabled ? 'success' : 'secondary'}">${statusText}</span>
</div>
<div class="card-info">
<div class="card-info-row">
<span style="color:#999;min-width:60px">模板链接</span>
<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0;font-size:11px">${item.template_link}</span>
</div>
<div class="card-info-row">
<strong>订阅地址:</strong>
<code style="font-size:11px;word-break:break-all;display:block;margin-top:4px;padding:6px;background:#f5f5f5;border-radius:4px">${subUrl}</code>
</div>
</div>
<div class="card-actions">
<button class="btn btn-success btn-sm" onclick="copyText('${subUrl}')">📋 复制订阅</button>
<button class="btn btn-success btn-sm" onclick="copyClashSub('${subUrl}')">📋 复制Clash订阅</button>
<button class="btn btn-info btn-sm" onclick="showClashSettings()">⚙️ 转换设置</button>
<button class="btn btn-warning btn-sm" onclick="editArgo(${item.id})">✏️ 编辑</button>
<button class="btn btn-info btn-sm" onclick="resetArgoToken(${item.id})">🔄 重置Token</button>
<button class="btn btn-${item.enabled ? 'secondary' : 'success'} btn-sm" onclick="toggleArgoEnable(${item.id},${!item.enabled})">${item.enabled ? '禁用' : '启用'}</button>
<button class="btn btn-danger btn-sm" onclick="deleteArgo(${item.id})">🗑️ 删除</button>
</div>
</div>
`;
            }).join('');
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('✅ 已复制到剪贴板');
            }).catch(err => {
                alert('❌ 复制失败：' + err.message);
            });
        }

        async function toggleArgoEnable(id, enabled) {
            await api('/argo/' + id, 'PUT', { enabled: enabled ? 1 : 0 });
            loadArgoSubscribes();
        }

        async function editArgo(id) {
            const item = await api('/argo');
            const argo = item.data.find(i => i.id === id);
            if (!argo) return;

            const newTemplate = prompt('修改模板链接：', argo.template_link);
            if (!newTemplate) return;

            const newRemark = prompt('修改备注：', argo.remark || '');

            await api('/argo/' + id, 'PUT', { template_link: newTemplate, remark: newRemark, enabled: argo.enabled });
            loadArgoSubscribes();
        }

        async function deleteArgo(id) {
            if (!confirm('确定删除该ARGO订阅吗？')) return;
            await api('/argo/' + id, 'DELETE');
            loadArgoSubscribes();
        }

        async function resetArgoToken(id) {
            if (!confirm('确定重置此订阅的 Token？\\n\\n重置后旧的订阅地址将失效，需要使用新的订阅地址。')) return;
            showLoading();
            try {
                const d = await api(`/argo/${id}/reset-token`, 'POST');
                if (d.success) {
                    await loadArgoSubscribes();
                    alert(`Token 已重置\\n\\n新 Token: ${d.data.token}`);
                } else alert(d.error);
            } finally { hideLoading() }
        }

        async function loadProxyIPs() {
            const d = await api('/proxyip');
            if (d.success) {
                cachedProxyIPs = d.data; // 更新缓存
                // 列表视图
                document.getElementById('proxyipTable').innerHTML = d.data.map(i => `<tr id="proxy-${i.id}">
<td><input type="checkbox" class="proxyip-check" value="${i.id}"></td>
<td>${i.id}</td>
<td class="addr-cell">${i.address}</td>
<td>${i.remark || '-'}</td>
<td><label class="switch"><input type="checkbox" ${i.enabled ? 'checked' : ''} onchange="toggle('proxyip',${i.id},this.checked)"><span class="slider"></span></label></td>
<td class="actions">
<button class="btn btn-warning btn-sm" data-icon="✏️" onclick="editItem('proxyip',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}')">✏️ 编辑</button>
</td></tr>`).join('');
                document.getElementById('proxyipCheckAll').checked = false;

                // 卡片视图
                document.getElementById('proxyipCardView').innerHTML = d.data.map(i => {
                    const statusClass = i.enabled ? 'online' : 'offline';
                    const statusText = i.enabled ? '已启用' : '已禁用';
                    return `<div class="outbound-card ${statusClass}" id="proxyip-card-${i.id}">
<input type="checkbox" class="card-checkbox proxyip-check" value="${i.id}">
<div class="card-header">
<div style="flex:1;padding-right:30px;min-width:0;overflow:hidden">
<div class="card-title">${i.remark || 'ProxyIP-' + i.id}</div>
</div>
</div>
<div class="card-info">
<div class="card-info-row">
<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0">${i.address}</span>
</div>
</div>
<div class="card-actions">
<div style="flex:1"></div>
<span onclick="editItem('proxyip',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}')" style="color:#667eea;cursor:pointer;font-size:13px;user-select:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">✏️ 编辑</span>
<label class="switch" style="margin:0;margin-left:12px">
<input type="checkbox" ${i.enabled ? 'checked' : ''} onchange="toggle('proxyip',${i.id},this.checked)">
<span class="slider"></span>
</label>
</div>
</div>`;
                }).join('');

                // 根据当前视图模式显示对应的视图
                if (globalViewMode === 'card') {
                    document.getElementById('proxyipListView').classList.add('hidden');
                    document.getElementById('proxyipCardView').classList.remove('hidden');
                } else {
                    document.getElementById('proxyipListView').classList.remove('hidden');
                    document.getElementById('proxyipCardView').classList.add('hidden');
                }
            }
        }

        async function loadOutbounds() {
            const d = await api('/outbound');
            if (d.success) {
                cachedOutbounds = d.data; // 更新缓存
                // 列表视图
                document.getElementById('outboundTable').innerHTML = d.data.map(i => {
                    let exitInfo = '-';
                    if (i.exit_country || i.exit_city) {
                        const country = i.exit_country || '';
                        const city = i.exit_city || '';
                        exitInfo = country && city ? country + '-' + city : (country || city);
                        if (i.checked_at) {
                            const checkTime = new Date(i.checked_at).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                            exitInfo += ` <span style="font-size:11px;color:#999">(${checkTime})</span>`;
                        }
                    }
                    return `<tr id="outbound-${i.id}">
<td data-label="选择"><input type="checkbox" class="outbound-check" value="${i.id}"></td>
<td data-label="ID">${i.id}</td>
<td data-label="地址" class="addr-cell" title="${i.address}">${maskAddress(i.address)}</td>
<td data-label="类型"><span class="badge badge-info">${i.type}</span></td>
<td data-label="出站" id="exit-${i.id}" class="exit-link" onclick="showExitDetail(${i.id})" title="点击查看详情">${exitInfo}</td>
<td data-label="备注">${i.remark || '-'}</td>
<td data-label="延迟" id="out-lat-${i.id}" style="color:#999">-</td>
<td data-label="状态"><label class="switch"><input type="checkbox" ${i.enabled ? 'checked' : ''} onchange="toggle('outbound',${i.id},this.checked)"><span class="slider"></span></label></td>
<td data-label="操作" class="actions">
<button class="btn btn-success btn-sm" data-icon="⚡" onclick="testSingleOutbound(${i.id})">⚡ 测速</button>
<button class="btn btn-warning btn-sm" data-icon="✏️" onclick="editItem('outbound',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}')">✏️ 编辑</button>
</td></tr>`;
                }).join('');
                document.getElementById('outboundCheckAll').checked = false;

                // 卡片视图
                document.getElementById('outboundCardView').innerHTML = d.data.map(i => {
                    let exitInfo = '未检测';
                    let exitClass = 'unknown';
                    if (i.exit_country || i.exit_city) {
                        const country = i.exit_country || '';
                        const city = i.exit_city || '';
                        exitInfo = country && city ? country + '-' + city : (country || city);
                        exitClass = 'online';
                    }
                    const statusClass = i.enabled ? 'online' : 'offline';
                    const statusText = i.enabled ? '已启用' : '已禁用';
                    return `<div class="outbound-card ${statusClass}" id="outbound-card-${i.id}">
<input type="checkbox" class="card-checkbox outbound-check" value="${i.id}">
<div class="card-header">
<div style="flex:1;padding-right:30px;min-width:0;overflow:hidden">
<div class="card-title">${i.remark || '节点-' + i.id}</div>
</div>
</div>
<div class="card-info">
<div class="card-info-row">
<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0">${maskAddress(i.address)}</span>
</div>
<div class="card-info-row">
<span id="exit-card-${i.id}" class="exit-link" onclick="showExitDetail(${i.id})" title="点击查看详情" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0">${exitInfo}</span>
</div>
</div>
<div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
<div class="card-latency unknown" id="out-lat-card-${i.id}" onclick="testSingleOutbound(${i.id})" style="margin:0;font-size:24px;cursor:pointer;user-select:none;line-height:1" title="点击测速">⚡</div>
<div style="display:flex;gap:12px;align-items:center">
<span onclick="editItem('outbound',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}')" style="color:#667eea;cursor:pointer;font-size:13px;user-select:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">✏️ 编辑</span>
<label class="switch" style="margin:0">
<input type="checkbox" ${i.enabled ? 'checked' : ''} onchange="toggle('outbound',${i.id},this.checked)">
<span class="slider"></span>
</label>
</div>
</div>
</div>`;
                }).join('');

                // 根据当前视图模式显示对应的视图
                if (globalViewMode === 'card') {
                    document.getElementById('outboundListView').classList.add('hidden');
                    document.getElementById('outboundCardView').classList.remove('hidden');
                } else {
                    document.getElementById('outboundListView').classList.remove('hidden');
                    document.getElementById('outboundCardView').classList.add('hidden');
                }
            }
        }

        async function loadCFIPs() {
            const d = await api('/cfip');
            if (d.success) {
                cachedCFIPs = d.data; // 更新缓存
                renderCFIPs();
            }
        }

        function renderCFIPs() {
            if (!cachedCFIPs) return;

            // Filter
            let filteredData = [...cachedCFIPs];

            // Sort
            if (cfipSortColumn) {
                filteredData.sort((a, b) => {
                    let valA = a[cfipSortColumn];
                    let valB = b[cfipSortColumn];

                    if (cfipSortColumn === 'id' || cfipSortColumn === 'port' || cfipSortColumn === 'fail_count') {
                        valA = parseInt(valA) || 0;
                        valB = parseInt(valB) || 0;
                    } else {
                        valA = (valA || '').toString().toLowerCase();
                        valB = (valB || '').toString().toLowerCase();
                    }

                    if (valA < valB) return cfipSortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return cfipSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Status Filter
            if (cfipStatusFilter.length < 3) { // If not all selected
                filteredData = filteredData.filter(item => {
                    const status = item.status || 'enabled';
                    return cfipStatusFilter.includes(status);
                });
            }

            if (cfipSearchText) {
                filteredData = filteredData.filter(item => {
                    const searchStr = (item.address + ' ' + item.port + ' ' + (item.remark || '') + ' ' + (item.name || '')).toLowerCase();
                    return searchStr.includes(cfipSearchText);
                });
            }

            // Pagination
            const startIndex = (cfipCurrentPage - 1) * cfipPageSize;
            const endIndex = startIndex + cfipPageSize;
            const pageData = filteredData.slice(startIndex, endIndex);

            if (true) {
                // 列表视图
                document.getElementById('cfipTable').innerHTML = pageData.map(i => {
                    const status = i.status || 'enabled';
                    let statusColor = '#999';
                    if (status === 'enabled') statusColor = '#48c774';
                    else if (status === 'disabled') statusColor = '#b5b5b5';
                    else if (status === 'invalid') statusColor = '#f14668';

                    return `<tr>
<td><input type="checkbox" class="cfip-check" value="${i.id}"></td>
<td>${i.id}</td>
<td style="font-weight:bold">${i.name || '-'}</td>
<td class="cfip-col-remark">${i.remark || '-'}</td>
<td>${i.address}</td>
<td>${i.port}</td>
<td class="cfip-col-fail_count">${i.fail_count || 0}</td>
<td class="cfip-col-latency">${i.latency ? i.latency + 'ms' : '-'}</td>
<td class="cfip-col-speed">${i.speed ? (i.speed / 1024).toFixed(2) : '-'}</td>
<td>
    <select onchange="updateStatus('cfip', ${i.id}, this.value)" style="padding:2px 4px;border:1px solid #ddd;border-radius:4px;font-size:12px;color:${statusColor};border-color:${statusColor}">
        <option value="enabled" ${status === 'enabled' ? 'selected' : ''}>启用</option>
        <option value="disabled" ${status === 'disabled' ? 'selected' : ''}>禁用</option>
        <option value="invalid" ${status === 'invalid' ? 'selected' : ''}>失效</option>
    </select>
</td>
<td class="actions">
<button class="btn btn-warning btn-sm" data-icon="✏️" onclick="editItem('cfip',${i.id},'${i.address.replace(/'/g, "\\\\'")}', '${(i.remark || '').replace(/'/g, "\\\\'")}', ${i.port}, '${(i.name || '').replace(/'/g, "\\\\'")}')">✏️ 编辑</button>
</td></tr>`;
                }).join('');
                document.getElementById('cfipCheckAll').checked = false;

                // 卡片视图
                document.getElementById('cfipCardView').innerHTML = pageData.map(i => {
                    const status = i.status || 'enabled';
                    const statusClass = status === 'enabled' ? 'online' : (status === 'invalid' ? 'bad' : 'offline');

                    return `<div class="outbound-card ${statusClass}" id="cfip-card-${i.id}">
<input type="checkbox" class="card-checkbox cfip-check" value="${i.id}">
<div class="card-header">
<div style="flex:1;padding-right:30px;min-width:0;overflow:hidden">
<div class="card-title">${i.name || i.remark || 'CFIP-' + i.id}</div>
<div style="font-size:11px;color:#999;margin-top:2px">${i.remark || ''}</div>
</div>
</div>
<div class="card-info">
<div class="card-info-row">
<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0">${i.address}:${i.port}</span>
</div>
<div class="card-info-row" style="margin-top:4px;font-size:11px;color:#666">
<span>失败: ${i.fail_count || 0}</span>
<span style="margin-left:8px">状态: ${status}</span>
</div>
</div>
<div class="card-actions">
<div style="flex:1"></div>
<span onclick="editItem('cfip',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}',${i.port},'${(i.name || '').replace(/'/g, "\\\\'")}')" style="color:#667eea;cursor:pointer;font-size:13px;user-select:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">✏️ 编辑</span>
</div>
</div>`;
                }).join('');

                // Update pagination controls
                updateCFIPPaginationControls(filteredData.length);

                // 根据当前视图模式显示对应的视图
                if (globalViewMode === 'card') {
                    document.getElementById('cfipListView').classList.add('hidden');
                    document.getElementById('cfipCardView').classList.remove('hidden');
                } else {
                    document.getElementById('cfipListView').classList.remove('hidden');
                    document.getElementById('cfipCardView').classList.add('hidden');
                }

                // Apply column visibility settings
                applyCFIPColumnVisibility();
            }
        }



        let cfipSortColumn = 'id';
        let cfipSortDirection = 'asc';

        function handleCFIPSort(column) {
            if (cfipSortColumn === column) {
                cfipSortDirection = cfipSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                cfipSortColumn = column;
                cfipSortDirection = 'asc';
            }
            renderCFIPs();
            updateSortIcons();
        }

        function updateSortIcons() {
            const columns = ['id', 'name', 'remark', 'address', 'port', 'fail_count', 'latency', 'speed'];
            columns.forEach(col => {
                const icon = document.getElementById('sort-icon-' + col);
                if (icon) {
                    if (cfipSortColumn === col) {
                        icon.textContent = cfipSortDirection === 'asc' ? '↑' : '↓';
                    } else {
                        icon.textContent = '';
                    }
                }
            });
        }

        function handleCFIPSearch(e) {
            cfipSearchText = e.target.value.trim().toLowerCase();
            cfipCurrentPage = 1;
            renderCFIPs();
        }

        function handleCFIPStatusChange(e) {
            const val = e.target.value;
            const isChecked = e.target.checked;

            if (val === 'all') {
                // Select/Deselect All
                const checks = document.querySelectorAll('.cfip-status-check');
                checks.forEach(c => c.checked = isChecked);
                if (isChecked) {
                    cfipStatusFilter = ['enabled', 'disabled', 'invalid'];
                } else {
                    cfipStatusFilter = [];
                }
            } else {
                // Individual check
                if (isChecked) {
                    if (!cfipStatusFilter.includes(val)) cfipStatusFilter.push(val);
                } else {
                    cfipStatusFilter = cfipStatusFilter.filter(s => s !== val);
                }

                // Sync "Select All" checkbox
                const allCheck = document.querySelector('input[value="all"]');
                const checks = document.querySelectorAll('.cfip-status-check');
                const allChecked = Array.from(checks).every(c => c.checked);
                if (allCheck) allCheck.checked = allChecked;
            }
            cfipCurrentPage = 1;
            renderCFIPs();
        }

        function handleCFIPPageSize(e) {
            cfipPageSize = parseInt(e.target.value);
            cfipCurrentPage = 1;
            renderCFIPs();
        }

        function changeCFIPPage(delta) {
            cfipCurrentPage += delta;
            renderCFIPs();
        }

        function updateCFIPPaginationControls(totalItems) {
            const totalPages = Math.ceil(totalItems / cfipPageSize) || 1;

            // Adjust current page if out of bounds
            if (cfipCurrentPage < 1) cfipCurrentPage = 1;
            if (cfipCurrentPage > totalPages) cfipCurrentPage = totalPages;

            const pageText = `Page ${cfipCurrentPage} of ${totalPages} (Total ${totalItems})`;
            const isFirstPage = cfipCurrentPage <= 1;
            const isLastPage = cfipCurrentPage >= totalPages;

            // Update bottom pagination
            document.getElementById('cfipPageInfo').textContent = pageText;
            document.getElementById('cfipPrevBtn').disabled = isFirstPage;
            document.getElementById('cfipNextBtn').disabled = isLastPage;

            // Update top pagination
            document.getElementById('cfipPageInfoTop').textContent = pageText;
            document.getElementById('cfipPrevBtnTop').disabled = isFirstPage;
            document.getElementById('cfipNextBtnTop').disabled = isLastPage;
        }

        // Toggle settings dropdown
        function toggleCFIPSettings(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('cfipSettingsDropdown');
            dropdown.classList.toggle('hidden');

            // Close dropdown when clicking outside
            if (!dropdown.classList.contains('hidden')) {
                const closeDropdown = (e) => {
                    if (!dropdown.contains(e.target) && e.target !== event.currentTarget) {
                        dropdown.classList.add('hidden');
                        document.removeEventListener('click', closeDropdown);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeDropdown), 0);
            }
        }

        // Toggle column visibility
        function toggleCFIPColumn(column) {
            cfipColumnSettings[column] = !cfipColumnSettings[column];
            // Save to localStorage
            localStorage.setItem('cfipColumnSettings', JSON.stringify(cfipColumnSettings));
            applyCFIPColumnVisibility();
        }

        // Apply column visibility based on settings
        function applyCFIPColumnVisibility() {
            const columns = ['remark', 'fail_count', 'latency', 'speed'];
            columns.forEach(col => {
                const isVisible = cfipColumnSettings[col];
                // Update header visibility
                document.querySelectorAll(`.cfip-col-${col}`).forEach(el => {
                    if (isVisible) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });
                // Update checkbox state
                const checkboxMap = {
                    'remark': 'cfipShowRemark',
                    'fail_count': 'cfipShowFailCount',
                    'latency': 'cfipShowLatency',
                    'speed': 'cfipShowSpeed'
                };
                const checkbox = document.getElementById(checkboxMap[col]);
                if (checkbox) checkbox.checked = isVisible;
            });
        }


        // 查重函数
        function checkDuplicate(type, data) {
            if (type === 'proxyip') {
                return cachedProxyIPs.some(i => i.address === data.address);
            } else if (type === 'outbound') {
                return cachedOutbounds.some(i => i.address === data.address);
            } else if (type === 'cfip') {
                return cachedCFIPs.some(i => i.address === data.address && i.port === data.port);
            } else if (type === 'argo') {
                return cachedArgoList.some(i => i.template_link === data.template_link);
            } else if (type === 'vl' + 'ess') {
                // vless 使用域名查重
                const domain = data.snippetsDomain || data.snippets_domain;
                return cachedVlConfigs.some(i => i.snippets_domain === domain);
            } else if (type === 'ss') {
                // ss 使用域名查重
                const domain = data.snippetsDomain || data.snippets_domain;
                return cachedSSConfigs.some(i => i.snippets_domain === domain);
            }
            return false;
        }

        async function testSingleSocks5(id) {
            const latCell = document.getElementById('lat-' + id);
            if (!latCell) return;
            latCell.textContent = '测试中...';
            latCell.style.color = '#999';
            try {
                const d = await api('/test-socks5', 'POST', { id });
                console.log('单个测速结果:', d);
                if (d.success && d.results && d.results.length > 0) {
                    const result = d.results[0];
                    if (result.status === 'online') {
                        latCell.textContent = result.latency + 'ms';
                        latCell.style.color = result.latency < 200 ? '#48c774' : result.latency < 500 ? '#ffdd57' : '#f14668';
                    } else {
                        latCell.textContent = '离线';
                        latCell.style.color = '#f14668';
                        latCell.title = result.error || '连接失败';
                        console.error('SOCKS5离线:', result);
                    }
                } else {
                    latCell.textContent = '失败';
                    latCell.style.color = '#f14668';
                    console.error('API返回错误:', d);
                }
            } catch (e) {
                latCell.textContent = '错误';
                latCell.style.color = '#f14668';
                console.error('测速异常:', e);
            }
        }

        async function testAllSocks5() {
            const rows = document.querySelectorAll('[id^="proxy-"]');
            const socks5Rows = Array.from(rows).filter(row => {
                const badge = row.querySelector('.badge-info');
                return badge && badge.textContent === 'socks5';
            });
            if (socks5Rows.length === 0) return alert('没有 SOCKS5 类型的 ProxyIP');
            socks5Rows.forEach(row => {
                const latCell = row.querySelector('[id^="lat-"]');
                if (latCell) {
                    latCell.textContent = '等待...';
                    latCell.style.color = '#999';
                }
            });
            try {
                const d = await api('/test-socks5', 'POST', {});
                console.log('批量测速结果:', d);
                if (d.success && d.results) {
                    d.results.forEach(result => {
                        const latCell = document.getElementById('lat-' + result.id);
                        if (latCell) {
                            if (result.status === 'online') {
                                latCell.textContent = result.latency + 'ms';
                                latCell.style.color = result.latency < 200 ? '#48c774' : result.latency < 500 ? '#ffdd57' : '#f14668';
                            } else {
                                latCell.textContent = '离线';
                                latCell.style.color = '#f14668';
                                latCell.title = result.error || '连接失败';
                                console.error('ProxyIP ' + result.id + ' 离线:', result.error);
                            }
                        }
                    });
                }
            } catch (e) {
                alert('测速失败: ' + e.message);
                console.error('批量测速异常:', e);
            }
        }

        async function testSingleOutbound(id) {
            const latCell = document.getElementById('out-lat-' + id);
            const latCardCell = document.getElementById('out-lat-card-' + id);
            const card = document.getElementById('outbound-card-' + id);
            if (!latCell && !latCardCell) return;

            // 更新列表视图
            if (latCell) {
                latCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                latCell.style.color = '#667eea';
            }
            // 更新卡片视图
            if (latCardCell) {
                latCardCell.innerHTML = '<span style="display:inline-block;width:16px;height:16px;border:3px solid #667eea;border-top:3px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                latCardCell.className = 'card-latency unknown';
                latCardCell.style.cursor = 'pointer';
            }

            try {
                const d = await api('/test-outbound', 'POST', { id });
                if (d.success && d.results && d.results.length > 0) {
                    const result = d.results[0];
                    if (result.status === 'online') {
                        const latency = result.latency;
                        const color = latency < 200 ? '#48c774' : latency < 500 ? '#ffdd57' : '#f14668';
                        const cardClass = latency < 200 ? 'good' : latency < 500 ? 'medium' : 'bad';
                        // 更新列表视图
                        if (latCell) {
                            latCell.textContent = latency + 'ms';
                            latCell.style.color = color;
                        }
                        // 更新卡片视图
                        if (latCardCell) {
                            latCardCell.textContent = latency + 'ms';
                            latCardCell.className = 'card-latency ' + cardClass;
                            latCardCell.style.cursor = 'pointer';
                            latCardCell.title = '点击重新测速';
                        }
                        // 更新卡片边框颜色为绿色（通）
                        if (card) {
                            card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-online';
                        }
                    } else {
                        // 更新列表视图
                        if (latCell) {
                            latCell.textContent = '离线';
                            latCell.style.color = '#f14668';
                            latCell.title = result.error || '连接失败';
                        }
                        // 更新卡片视图
                        if (latCardCell) {
                            latCardCell.textContent = '离线';
                            latCardCell.className = 'card-latency bad';
                            latCardCell.style.cursor = 'pointer';
                            latCardCell.title = '点击重新测速';
                        }
                        // 更新卡片边框颜色为红色（不通）
                        if (card) {
                            card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-offline';
                        }
                    }
                } else {
                    if (latCell) {
                        latCell.textContent = '失败';
                        latCell.style.color = '#f14668';
                    }
                    if (latCardCell) {
                        latCardCell.textContent = '失败';
                        latCardCell.className = 'card-latency bad';
                        latCardCell.style.cursor = 'pointer';
                        latCardCell.title = '点击重新测速';
                    }
                    // 更新卡片边框颜色为红色（不通）
                    if (card) {
                        card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-offline';
                    }
                }
            } catch (e) {
                if (latCell) {
                    latCell.textContent = '错误';
                    latCell.style.color = '#f14668';
                }
                if (latCardCell) {
                    latCardCell.textContent = '错误';
                    latCardCell.className = 'card-latency bad';
                    latCardCell.style.cursor = 'pointer';
                    latCardCell.title = '点击重新测速';
                }
                // 更新卡片边框颜色为红色（不通）
                if (card) {
                    card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-offline';
                }
            }
        }

        async function testAllOutbounds() {
            const rows = document.querySelectorAll('[id^="outbound-"]');
            const cards = document.querySelectorAll('[id^="outbound-card-"]');
            if (rows.length === 0 && cards.length === 0) return alert('没有出站代理');

            // 更新列表视图的加载状态
            rows.forEach(row => {
                const latCell = row.querySelector('[id^="out-lat-"]');
                if (latCell) {
                    latCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                    latCell.style.color = '#667eea';
                }
            });

            // 更新卡片视图的加载状态
            cards.forEach(card => {
                const latCell = card.querySelector('[id^="out-lat-card-"]');
                if (latCell) {
                    latCell.innerHTML = '<span style="display:inline-block;width:16px;height:16px;border:3px solid #667eea;border-top:3px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                    latCell.className = 'card-latency unknown';
                }
            });

            try {
                const d = await api('/test-outbound', 'POST', {});
                if (d.success && d.results) {
                    d.results.forEach(result => {
                        const latCell = document.getElementById('out-lat-' + result.id);
                        const latCardCell = document.getElementById('out-lat-card-' + result.id);
                        const card = document.getElementById('outbound-card-' + result.id);
                        const latency = result.latency;
                        const color = latency < 200 ? '#48c774' : latency < 500 ? '#ffdd57' : '#f14668';
                        const cardClass = latency < 200 ? 'good' : latency < 500 ? 'medium' : 'bad';

                        if (result.status === 'online') {
                            // 更新列表视图
                            if (latCell) {
                                latCell.textContent = latency + 'ms';
                                latCell.style.color = color;
                            }
                            // 更新卡片视图
                            if (latCardCell) {
                                latCardCell.textContent = latency + 'ms';
                                latCardCell.className = 'card-latency ' + cardClass;
                            }
                            // 更新卡片边框颜色为绿色（通）
                            if (card) {
                                card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-online';
                            }
                        } else {
                            // 更新列表视图
                            if (latCell) {
                                latCell.textContent = '离线';
                                latCell.style.color = '#f14668';
                                latCell.title = result.error || '连接失败';
                            }
                            // 更新卡片视图
                            if (latCardCell) {
                                latCardCell.textContent = '离线';
                                latCardCell.className = 'card-latency bad';
                            }
                            // 更新卡片边框颜色为红色（不通）
                            if (card) {
                                card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-offline';
                            }
                        }
                    });
                }
            } catch (e) {
                alert('测速失败: ' + e.message);
                // 恢复所有延迟显示
                rows.forEach(row => {
                    const latCell = row.querySelector('[id^="out-lat-"]');
                    if (latCell && latCell.innerHTML.includes('spin')) {
                        latCell.textContent = '-';
                        latCell.style.color = '#999';
                    }
                });
                cards.forEach(card => {
                    const latCell = card.querySelector('[id^="out-lat-card-"]');
                    if (latCell && latCell.innerHTML.includes('spin')) {
                        latCell.textContent = '未测速';
                        latCell.className = 'card-latency unknown';
                    }
                });
            }
        }

        async function updateStatus(type, id, status) {
            showLoading();
            try {
                if (type === 'cfip') {
                    // For cfip, only update status, no enabled field
                    await api('/' + type + '/' + id, 'PUT', { status });
                } else {
                    // For other types, keep backward compatibility
                    const enabled = status === 'enabled';
                    await api('/' + type + '/' + id, 'PUT', { status, enabled });
                }
                if (type === 'proxyip') await loadProxyIPs();
                else if (type === 'outbound') await loadOutbounds();
                else await loadCFIPs();
            } finally {
                hideLoading();
            }
        }

        async function toggle(type, id, enabled) {
            showLoading();
            try {
                await api('/' + type + '/' + id, 'PUT', { enabled });
                if (type === 'proxyip') await loadProxyIPs();
                else if (type === 'outbound') await loadOutbounds();
                else await loadCFIPs();
            } finally {
                hideLoading();
            }
        }

        async function del(type, id) {
            if (!confirm('确定删除?')) return;
            showLoading();
            try {
                await api('/' + type + '/' + id, 'DELETE');
                if (type === 'proxyip') await loadProxyIPs();
                else if (type === 'outbound') await loadOutbounds();
                else await loadCFIPs();
            } finally {
                hideLoading();
            }
        }

        function showModal(type, id = null, addr = '', remark = '', port = 443, name = '') {
            modalType = type;
            editId = id;
            const isEdit = id !== null;
            const titles = { 'proxyip': 'ProxyIP(反代IP)', 'outbound': '全局出站', 'cfip': 'CFIP(优选域名)' };
            document.getElementById('modalTitle').textContent = (isEdit ? '编辑' : '添加') + titles[type];
            if (type === 'proxyip') {
                document.getElementById('modalBody').innerHTML = `<div class="form-group"><label>地址</label><input type="text" id="mAddr" value="${addr}" placeholder="IP/域名"></div>
<div class="form-group"><label>备注</label><input type="text" id="mRemark" value="${remark}"></div>`;
            } else if (type === 'outbound') {
                document.getElementById('modalBody').innerHTML = `<div class="form-group"><label>地址</label><input type="text" id="mAddr" value="${addr}" placeholder="socks5://host:port 或 http://host:port"></div>
<div class="form-group"><label>备注</label><input type="text" id="mRemark" value="${remark}"></div>`;
            } else {
                document.getElementById('modalBody').innerHTML = `<div class="form-group"><label>别名 (Name)</label><input type="text" id="mName" value="${name}" placeholder="可选，用于订阅节点名称"></div>
<div class="form-group"><label>地址</label><input type="text" id="mAddr" value="${addr}" placeholder="优选域名或IP"></div>
<div class="form-group"><label>端口</label><input type="number" id="mPort" value="${port}"></div>
<div class="form-group"><label>备注</label><input type="text" id="mRemark" value="${remark}"></div>`;
            }
            document.getElementById('addModal').classList.remove('hidden');
        }

        function editItem(type, id, addr, remark, port, name) {
            showModal(type, id, addr, remark, port || 443, name || '');
        }

        function closeModal() { document.getElementById('addModal').classList.add('hidden'); editId = null }

        async function submitModal() {
            if (modalType === 'subscribe') {
                const type = document.getElementById('subscribeType').value;
                const uuid = document.getElementById('subUuid').value.trim();
                const domain = document.getElementById('subDomain').value.trim();
                const remark = document.getElementById('subRemark').value.trim();

                if (!uuid || !domain) return alert('请填写必填项');

                // 处理 Path 逻辑
                // VL 默认 /?ed=2560
                // SS 默认 /uuid
                const path = type === 'ss' ? '/' + uuid : '/?ed=2560';

                const body = { type, uuid, snippetsDomain: domain, proxyPath: path, remark: remark || undefined };
                const method = editId ? 'PUT' : 'POST';
                const apiPath = editId ? `/subscribe/config/${editId}` : '/subscribe/config';

                // 查重逻辑 (仅限新增)
                if (!editId) {
                    // 对于 VLESS/SS，使用域名查重
                    const checkData = { snippets_domain: domain };

                    if (checkDuplicate(type, checkData)) {
                        return alert('重复添加：该域名已存在');
                    }
                }

                showLoading();
                try {
                    const d = await api(apiPath, method, body);
                    if (d.success) {
                        closeModal();
                        await loadVlConfig();
                        await loadSSConfig();
                    } else {
                        alert(d.error || '操作失败');
                    }
                } finally {
                    hideLoading();
                }
                return;
            }

            const addr = document.getElementById('mAddr').value.trim();
            const remark = document.getElementById('mRemark').value.trim();
            if (!addr) return alert('请输入地址');

            let body = { address: addr, remark: remark || undefined };
            if (modalType === 'cfip') {
                body.port = parseInt(document.getElementById('mPort').value) || 443;
                body.name = document.getElementById('mName').value.trim() || undefined;
            }

            const method = editId ? 'PUT' : 'POST';
            const path = editId ? '/' + modalType + '/' + editId : '/' + modalType;

            // 查重逻辑 (仅限新增)
            if (!editId) {
                if (checkDuplicate(modalType, body)) {
                    return alert('重复添加：该数据已存在');
                }
            }

            showLoading();
            try {
                const d = await api(path, method, body);
                if (d.success) {
                    closeModal();
                    if (modalType === 'proxyip') await loadProxyIPs();
                    else if (modalType === 'outbound') await loadOutbounds();
                    else await loadCFIPs();
                } else {
                    alert(d.error || '操作失败');
                }
            } finally {
                hideLoading();
            }
        }

        // 订阅配置操作函数
        function showSubscribeModal(type) {
            modalType = 'subscribe';
            editId = null;
            document.getElementById('modalTitle').textContent = `添加${type === 'vl' ? 'V<span>LESS</span>' : type.toUpperCase()}订阅配置`;
            const label = type === 'vl' ? 'UUID' : '密码';
            document.getElementById('modalBody').innerHTML = `
<input type="hidden" id="subscribeType" value="${type === 'vl' ? 'vl' + 'ess' : type}">
<div class="form-group"><label>备注</label><input type="text" id="subRemark" placeholder="例如：美国节点"></div>
<div class="form-group"><label>${label}</label><input type="text" id="subUuid" placeholder="${type === 'vl' ? '12cbf86b-22bb-45b6-aadb-cb622a538d6a' : 'your-password'}"></div>
<div class="form-group"><label>Snippets/Worker 域名</label><input type="text" id="subDomain" placeholder="your-worker.workers.dev"></div>
`;
            document.getElementById('addModal').classList.remove('hidden');
        }

        async function editSubscribeConfig(type, id) {
            const cfg = type === 'vl' ? 'vl' + 'ess' : type;
            const d = await api(`/subscribe/config?type=${cfg}`);
            if (!d.success) return;
            const item = d.data.find(x => x.id === id);
            if (!item) return alert('配置不存在');

            modalType = 'subscribe';
            editId = id;
            document.getElementById('modalTitle').textContent = `编辑${type === 'vl' ? 'V<span>LESS</span>' : type.toUpperCase()}订阅配置`;
            const label = type === 'vl' ? 'UUID' : '密码';
            document.getElementById('modalBody').innerHTML = `
<input type="hidden" id="subscribeType" value="${cfg}">
<div class="form-group"><label>备注</label><input type="text" id="subRemark" value="${item.remark || ''}"></div>
<div class="form-group"><label>${label}</label><input type="text" id="subUuid" value="${item.uuid}"></div>
<div class="form-group"><label>Snippets/Worker 域名</label><input type="text" id="subDomain" value="${item.snippets_domain}"></div>
`;
            document.getElementById('addModal').classList.remove('hidden');
        }

        async function toggleSubscribeEnable(id, enabled) {
            showLoading();
            try {
                const d = await api(`/subscribe/config/${id}`, 'PUT', { enabled });
                if (d.success) {
                    await loadVlConfig();
                    await loadSSConfig();
                } else alert(d.error);
            } finally { hideLoading() }
        }

        async function deleteSubscribeConfig(id) {
            if (!confirm('确定删除此订阅配置？')) return;
            showLoading();
            try {
                const d = await api(`/subscribe/config/${id}`, 'DELETE');
                if (d.success) {
                    await loadVlConfig();
                    await loadSSConfig();
                } else alert(d.error);
            } finally { hideLoading() }
        }

        async function resetSubscribeToken(id) {
            if (!confirm('确定重置此订阅的 Token？\n\n重置后旧的订阅地址将失效，需要使用新的订阅地址。')) return;
            showLoading();
            try {
                const d = await api(`/subscribe/config/${id}/reset-token`, 'POST');
                if (d.success) {
                    await loadVlConfig();
                    await loadSSConfig();
                    alert(`Token 已重置\n\n新 Token: ${d.data.token}`);
                } else alert(d.error);
            } finally { hideLoading() }
        }

        async function generateSS() {
            const password = document.getElementById('ssPasswordInput').value.trim();
            const domain = document.getElementById('ssDomainInput').value.trim();
            let path = document.getElementById('ssPathInput').value.trim();
            if (!path) path = '/' + password;
            if (!password || !domain) return alert('请填写密码和域名');

            showLoading();
            try {
                const d = await api('/subscribe/ss/generate', 'POST', { password, snippetsDomain: domain, proxyPath: path });
                if (d.success) {
                    const subUrl = location.origin + '/sub/ss/' + password;
                    // Clash订阅地址已暂时注释，如需使用请取消注释
                    // const clashUrl='https://sublink.eooce.com/clash?config='+encodeURIComponent(subUrl);
                    document.getElementById('ssSubUrl').textContent = subUrl;
                    // document.getElementById('ssClashUrl').textContent=clashUrl;
                    document.getElementById('ssResult').classList.remove('hidden');
                    document.getElementById('ssAlert').innerHTML = '<div class="alert alert-success">保存成功，共' + d.data.count + '条节点</div>';
                } else { document.getElementById('ssAlert').innerHTML = '<div class="alert alert-error">' + d.error + '</div>' }
            } finally {
                hideLoading();
            }
        }

        function copy(id) { navigator.clipboard.writeText(document.getElementById(id).textContent).then(() => alert('已复制')) }

        function closeExitDetail() { document.getElementById('exitDetailModal').classList.add('hidden') }

        async function showExitDetail(id) {
            showLoading();
            try {
                const d = await api('/outbound');
                if (!d.success) return;
                const outbound = d.data.find(i => i.id === id);
                if (!outbound || (!outbound.entry_info_json && !outbound.exit_info_json)) {
                    alert('暂无出入站信息，请先进行检测');
                    return;
                }
                const entryInfo = outbound.entry_info_json ? JSON.parse(outbound.entry_info_json) : null;
                const exitInfo = outbound.exit_info_json ? JSON.parse(outbound.exit_info_json) : null;

                // 辅助函数：显示是/否标签
                const yesNo = (val) => val ? '<span style="background:#48c774;color:#fff;padding:3px 10px;border-radius:4px;font-size:12px">否</span>' : '<span style="background:#f14668;color:#fff;padding:3px 10px;border-radius:4px;font-size:12px">是</span>';
                // 辅助函数：显示百分比标签
                const percent = (val) => {
                    const v = parseFloat(val) || 0;
                    const color = v < 10 ? '#48c774' : v < 30 ? '#ffdd57' : '#f14668';
                    return `<span style="background:${color};color:${v < 30 ? '#333' : '#fff'};padding:3px 10px;border-radius:4px;font-size:12px;font-weight:bold">${v.toFixed(2)}%</span>`;
                };

                const html = `
<div style="display:flex;gap:20px">
<div style="flex:1;background:#e8f5e9;padding:20px;border-radius:8px">
<h3 style="color:#2e7d32;margin:0 0 16px 0;text-align:center;font-size:18px">入口信息</h3>
<div style="line-height:2.4;font-size:14px">
<p><strong>IP地址：</strong>${entryInfo && entryInfo.ip || '-'}</p>
<p><strong>网络爬虫：</strong>${entryInfo && entryInfo.is_crawler !== undefined ? yesNo(entryInfo.is_crawler) : '-'}</p>
<p><strong>数据中心：</strong>${entryInfo && entryInfo.is_datacenter !== undefined ? yesNo(entryInfo.is_datacenter) : '-'}</p>
<p><strong>Tor网络：</strong>${entryInfo && entryInfo.is_tor !== undefined ? yesNo(entryInfo.is_tor) : '-'}</p>
<p><strong>代理：</strong>${entryInfo && entryInfo.is_proxy !== undefined ? yesNo(entryInfo.is_proxy) : '-'}</p>
<p><strong>VPN：</strong>${entryInfo && entryInfo.is_vpn !== undefined ? yesNo(entryInfo.is_vpn) : '-'}</p>
<p><strong>滥用行为：</strong>${entryInfo && entryInfo.is_abuser !== undefined ? yesNo(entryInfo.is_abuser) : '-'}</p>
<p><strong>滥用风险评分：</strong>${entryInfo && entryInfo.abuse_score !== undefined ? percent(entryInfo.abuse_score) : '-'}</p>
<p><strong>自治系统编号：</strong>${entryInfo && entryInfo.asn && entryInfo.asn.asn ? 'AS' + entryInfo.asn.asn : '-'}</p>
<p><strong>所属组织：</strong>${entryInfo && entryInfo.asn && entryInfo.asn.org || '-'}</p>
<p><strong>国家：</strong>${entryInfo && entryInfo.location && entryInfo.location.country || '-'}</p>
<p><strong>城市：</strong>${entryInfo && entryInfo.location && entryInfo.location.city || '-'}</p>
</div>
</div>
<div style="flex:1;background:#e3f2fd;padding:20px;border-radius:8px">
<h3 style="color:#1976d2;margin:0 0 16px 0;text-align:center;font-size:18px">出口信息</h3>
<div style="line-height:2.4;font-size:14px">
<p><strong>IP地址：</strong>${exitInfo && exitInfo.ip || '-'}</p>
<p><strong>网络爬虫：</strong>${exitInfo && exitInfo.is_crawler !== undefined ? yesNo(exitInfo.is_crawler) : '-'}</p>
<p><strong>数据中心：</strong>${exitInfo && exitInfo.is_datacenter !== undefined ? yesNo(exitInfo.is_datacenter) : '-'}</p>
<p><strong>Tor网络：</strong>${exitInfo && exitInfo.is_tor !== undefined ? yesNo(exitInfo.is_tor) : '-'}</p>
<p><strong>代理：</strong>${exitInfo && exitInfo.is_proxy !== undefined ? yesNo(exitInfo.is_proxy) : '-'}</p>
<p><strong>VPN：</strong>${exitInfo && exitInfo.is_vpn !== undefined ? yesNo(exitInfo.is_vpn) : '-'}</p>
<p><strong>滥用行为：</strong>${exitInfo && exitInfo.is_abuser !== undefined ? yesNo(exitInfo.is_abuser) : '-'}</p>
<p><strong>滥用风险评分：</strong>${exitInfo && exitInfo.abuse_score !== undefined ? percent(exitInfo.abuse_score) : '-'}</p>
<p><strong>自治系统编号：</strong>${exitInfo && exitInfo.asn && exitInfo.asn.asn ? 'AS' + exitInfo.asn.asn : '-'}</p>
<p><strong>所属组织：</strong>${exitInfo && exitInfo.asn && exitInfo.asn.org || '-'}</p>
<p><strong>国家：</strong>${exitInfo && exitInfo.location && exitInfo.location.country || '-'}</p>
<p><strong>城市：</strong>${exitInfo && exitInfo.location && exitInfo.location.city || '-'}</p>
</div>
</div>
</div>
<div style="text-align:center;margin-top:16px;color:#999;font-size:13px">
检测时间：${outbound.checked_at ? new Date(outbound.checked_at).toLocaleString('zh-CN') : '-'}
</div>
`;
                document.getElementById('exitDetailBody').innerHTML = html;
                document.getElementById('exitDetailModal').classList.remove('hidden');
            } finally {
                hideLoading();
            }
        }

        async function checkSingleExit(id) {
            const exitCell = document.getElementById('exit-' + id);
            const exitCardCell = document.getElementById('exit-card-' + id);
            if (!exitCell && !exitCardCell) return;

            // 更新加载状态
            if (exitCell) {
                exitCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
            }
            if (exitCardCell) {
                exitCardCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
            }

            try {
                const d = await api('/check-exit', 'POST', { id });
                console.log('检测结果:', d);
                if (d.success && d.results && d.results.length > 0) {
                    const result = d.results[0];
                    console.log('单个结果:', result);
                    if (result.success) {
                        const country = result.country || '';
                        const city = result.city || '';
                        const exitInfo = country && city ? country + '-' + city : (country || city || '未知');
                        const checkTime = new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                        // 更新列表视图
                        if (exitCell) {
                            exitCell.innerHTML = `${exitInfo} <span style="font-size:11px;color:#999">(${checkTime})</span>`;
                            exitCell.className = 'exit-link';
                        }
                        // 更新卡片视图
                        if (exitCardCell) {
                            exitCardCell.textContent = exitInfo;
                            exitCardCell.className = 'exit-link';
                        }
                    } else {
                        // 更新列表视图
                        if (exitCell) {
                            exitCell.textContent = '检测失败';
                            exitCell.style.color = '#f14668';
                            exitCell.className = '';
                            exitCell.title = result.error || '未知错误';
                        }
                        // 更新卡片视图
                        if (exitCardCell) {
                            exitCardCell.textContent = '检测失败';
                            exitCardCell.style.color = '#f14668';
                            exitCardCell.className = '';
                        }
                        console.error('检测失败:', result.error);
                    }
                } else {
                    if (exitCell) {
                        exitCell.textContent = '检测失败';
                        exitCell.style.color = '#f14668';
                        exitCell.className = '';
                    }
                    if (exitCardCell) {
                        exitCardCell.textContent = '检测失败';
                        exitCardCell.style.color = '#f14668';
                        exitCardCell.className = '';
                    }
                    console.error('API返回错误:', d);
                }
            } catch (e) {
                if (exitCell) {
                    exitCell.textContent = '错误';
                    exitCell.style.color = '#f14668';
                    exitCell.className = '';
                }
                if (exitCardCell) {
                    exitCardCell.textContent = '错误';
                    exitCardCell.style.color = '#f14668';
                    exitCardCell.className = '';
                }
                console.error('检测异常:', e);
            }
        }

        async function checkAllExits() {
            // 获取所有勾选的checkbox（只选择可见的）
            const checkedBoxes = Array.from(document.querySelectorAll('.outbound-check:checked')).filter(cb => {
                let el = cb;
                while (el) {
                    if (el.classList && el.classList.contains('hidden')) return false;
                    el = el.parentElement;
                }
                return true;
            });
            if (checkedBoxes.length === 0) return alert('请先勾选要检测的出站代理');

            const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

            // 更新加载状态
            ids.forEach(id => {
                const exitCell = document.getElementById('exit-' + id);
                const exitCardCell = document.getElementById('exit-card-' + id);
                if (exitCell) {
                    exitCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                }
                if (exitCardCell) {
                    exitCardCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                }
            });

            try {
                const d = await api('/check-exit', 'POST', { ids });
                if (d.success && d.results) {
                    d.results.forEach(result => {
                        const exitCell = document.getElementById('exit-' + result.id);
                        const exitCardCell = document.getElementById('exit-card-' + result.id);
                        if (result.success) {
                            const country = result.country || '';
                            const city = result.city || '';
                            const exitInfo = country && city ? country + '-' + city : (country || city || '未知');
                            const checkTime = new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                            // 更新列表视图
                            if (exitCell) {
                                exitCell.innerHTML = `${exitInfo} <span style="font-size:11px;color:#999">(${checkTime})</span>`;
                                exitCell.className = 'exit-link';
                            }
                            // 更新卡片视图
                            if (exitCardCell) {
                                exitCardCell.textContent = exitInfo;
                                exitCardCell.className = 'exit-link';
                            }
                        } else {
                            // 更新列表视图
                            if (exitCell) {
                                exitCell.textContent = '检测失败';
                                exitCell.style.color = '#f14668';
                                exitCell.className = '';
                            }
                            // 更新卡片视图
                            if (exitCardCell) {
                                exitCardCell.textContent = '检测失败';
                                exitCardCell.style.color = '#f14668';
                                exitCardCell.className = '';
                            }
                        }
                    });
                }
            } catch (e) {
                alert('检测失败: ' + e.message);
                ids.forEach(id => {
                    const exitCell = document.getElementById('exit-' + id);
                    const exitCardCell = document.getElementById('exit-card-' + id);
                    if (exitCell && exitCell.innerHTML.includes('spin')) {
                        exitCell.textContent = '-';
                        exitCell.style.color = '#999';
                        exitCell.className = '';
                    }
                    if (exitCardCell && exitCardCell.innerHTML.includes('spin')) {
                        exitCardCell.textContent = '未检测';
                        exitCardCell.style.color = '#999';
                        exitCardCell.className = '';
                    }
                });
            }
        }

        function checkAll(type, checked) {
            const className = type === 'proxyip' ? 'proxyip-check' : type === 'outbound' ? 'outbound-check' : type === 'argo' ? 'argo-check' : 'cfip-check';
            document.querySelectorAll('.' + className).forEach(cb => cb.checked = checked);
        }

        let batchType = '';
        function showBatchModal(type) {
            batchType = type;
            const titles = { 'proxyip': 'ProxyIP(反代IP)', 'outbound': '全局出站', 'cfip': 'CFIP(优选域名)', 'argo': 'ARGO 订阅' };
            document.getElementById('batchModalTitle').textContent = '批量添加 ' + titles[type];
            document.getElementById('batchInput').value = '';
            document.getElementById('batchAlert').innerHTML = '';
            if (type === 'proxyip') {
                document.getElementById('batchHelp').innerHTML = '<b>格式说明：</b>每行一条，支持以下格式：<br>• IP/域名#备注<br>备注可选，没有备注则自动生成';
            } else if (type === 'outbound') {
                document.getElementById('batchHelp').innerHTML = '<b>格式说明：</b>每行一条，支持以下格式：<br>• socks://base64(user:pass)@host:port#备注<br>• socks5://host:port#备注<br>• socks5://user:pass@host:port#备注<br>• http://host:port#备注<br>• http://user:pass@host:port#备注<br>备注可选，没有备注则自动生成';
            } else if (type === 'argo') {
                document.getElementById('batchHelp').innerHTML = '<b>格式说明：</b>每行一条 V<span>LESS</span> 或 V<span>Mess</span> 模板链接<br><b>V<span>LESS</span>示例：</b><br><code>v' + 'less://12345678@example.com:443?encryption=none&security=tls&sni=argo.example.com&fp=firefox&type=ws&host=argo.example.com&path=%2Fvless-argo%3Fed%3D2560#美国节点</code><br><b>V<span>Mess</span>示例：</b><br><code>v' + 'mess://eyAidiI6ICIyIiwgInBzIjogIkFsdGFyZV9TRy1WdWx0ciIsICJhZGQiOiAiY25hbWUuanZ2di5kZSIsICJwb3J0IjogIjQ0MyIsICJpZCI6ICI1ZWZkMDQyMC1lM2MzLTQ1ZjMtYTMyNS00NmRlOTY1MjFhMzYiLCAiYWlkIjogIjAiLCAic2N5IjogIm5vbmUiLCAibmV0IjogIndzIiwgInR5cGUiOiAibm9uZSIsICJob3N0IjogInNlcnZlcjEubGVub2FzLmRlIiwgInBhdGgiOiAiL3ZtZXNzLWFyZ28/ZWQ9MjU2MCIsICJ0bHMiOiAidGxzIiwgInNuaSI6ICJzZXJ2ZXIxLmxlbm9hcy5kZSIsICJhbHBuIjogIiIsICJmcCI6ICJjaHJvbWUifQo=</code>';
            } else {
                document.getElementById('batchHelp').innerHTML = '<b>格式说明：</b>每行一条，格式为：<br>• IP/域名#名字#备注<br>• IP/域名:端口#名字#备注<br>名字和备注可选，名字不自动生成，备注默认为空';
            }
            document.getElementById('batchModal').classList.remove('hidden');
        }

        function closeBatchModal() {
            document.getElementById('batchModal').classList.add('hidden');
            batchType = '';
        }

        async function exportData() {
            showLoading();
            try {
                const [proxyips, outbounds, cfips, argo, vlConfig, ssConfig] = await Promise.all([
                    api('/proxyip'),
                    api('/outbound'),
                    api('/cfip'),
                    api('/argo'),
                    api('/subscribe/v' + 'less/config'),
                    api('/subscribe/ss/config')
                ]);
                const exportData = {
                    version: '1.1',
                    timestamp: new Date().toISOString(),
                    proxyips: proxyips.success ? proxyips.data : [],
                    outbounds: outbounds.success ? outbounds.data : [],
                    cfips: cfips.success ? cfips.data : [],
                    argo: argo.success ? argo.data : [],
                    vlConfig: vlConfig.success ? vlConfig.data : {},
                    ssConfig: ssConfig.success ? ssConfig.data : {}
                };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cf-snippets-extend-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('导出成功');
            } catch (e) {
                alert('导出失败: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        function importData() {
            // 直接显示模式选择模态框
            document.getElementById('importModeModal').classList.remove('hidden');
        }

        let importFileData = null;
        let importMode = 'append';

        function closeImportModeModal() {
            document.getElementById('importModeModal').classList.add('hidden');
            document.getElementById('importFileInput').value = '';
            importFileData = null;
        }

        async function confirmImportMode(mode) {
            importMode = mode;
            closeImportModeModal();
            // 选择模式后，触发文件选择
            document.getElementById('importFileInput').click();
        }

        function handleImportFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (importMode === 'replace') {
                if (!confirm('警告：完全覆盖导入将删除所有现有数据！\\n\\n此操作不可撤销，确定继续吗？')) {
                    event.target.value = '';
                    return;
                }
            }

            showLoading();
            file.text().then(text => {
                try {
                    const data = JSON.parse(text);
                    if (!data.version || !data.proxyips || !data.outbounds || !data.cfips) {
                        throw new Error('无效的导入文件格式');
                    }
                    executeImport(data, importMode);
                } catch (e) {
                    hideLoading();
                    alert('文件格式错误: ' + e.message);
                    event.target.value = '';
                }
            }).catch(e => {
                hideLoading();
                alert('读取文件失败: ' + e.message);
                event.target.value = '';
            });
        }

        async function executeImport(data, mode) {
            showLoading();
            try {
                if (mode === 'replace') {
                    // 完全覆盖模式：先删除所有现有数据
                    const [existingProxyips, existingOutbounds, existingCfips, existingArgo] = await Promise.all([
                        api('/proxyip'),
                        api('/outbound'),
                        api('/cfip'),
                        api('/argo')
                    ]);

                    const deletePromises = [];
                    if (existingProxyips.success) {
                        deletePromises.push(...existingProxyips.data.map(item => api('/proxyip/' + item.id, 'DELETE')));
                    }
                    if (existingOutbounds.success) {
                        deletePromises.push(...existingOutbounds.data.map(item => api('/outbound/' + item.id, 'DELETE')));
                    }
                    if (existingCfips.success) {
                        deletePromises.push(...existingCfips.data.map(item => api('/cfip/' + item.id, 'DELETE')));
                    }
                    if (existingArgo.success) {
                        deletePromises.push(...existingArgo.data.map(item => api('/argo/' + item.id, 'DELETE')));
                    }
                    await Promise.all(deletePromises);
                }

                // 导入新数据（两种模式都执行）
                const results = await Promise.all([
                    ...data.proxyips.map(item => api('/proxyip', 'POST', { address: item.address, remark: item.remark, enabled: item.enabled })),
                    ...data.outbounds.map(item => api('/outbound', 'POST', { address: item.address, remark: item.remark, enabled: item.enabled })),
                    ...data.cfips.map(item => api('/cfip', 'POST', { address: item.address, port: item.port, remark: item.remark, name: item.name, fail_count: item.fail_count, status: item.status || 'enabled' })),
                    ...(data.argo || []).map(item => api('/argo', 'POST', { template_link: item.template_link, remark: item.remark, enabled: item.enabled }))
                ]);

                // 更新 V<span>LESS</span> 配置
                if (data.vlConfig && data.vlConfig.uuid) {
                    await api('/subscribe/v' + 'less/generate', 'POST', { uuid: data.vlConfig.uuid, snippetsDomain: data.vlConfig.snippets_domain, proxyPath: data.vlConfig.proxy_path });
                }

                // 更新 SS 配置
                if (data.ssConfig && data.ssConfig.password) {
                    await api('/subscribe/ss/generate', 'POST', { password: data.ssConfig.password, snippetsDomain: data.ssConfig.snippets_domain, proxyPath: data.ssConfig.proxy_path });
                }

                // 兼容旧版本导出格式（config 字段）
                if (data.config && data.config.uuid && !data.vlConfig) {
                    await api('/subscribe/v' + 'less/generate', 'POST', { uuid: data.config.uuid, snippetsDomain: data.config.snippets_domain, proxyPath: data.config.proxy_path });
                }

                await load();
                const modeText = mode === 'replace' ? '覆盖导入' : '新增导入';
                alert(modeText + '成功！');
            } catch (e) {
                alert('导入失败: ' + e.message);
            } finally {
                hideLoading();
                document.getElementById('importFileInput').value = '';
            }
        }


        async function submitBatch() {
            const input = document.getElementById('batchInput').value.trim();
            if (!input) return alert('请输入数据');

            const lines = input.split(/\r?\n/).filter(l => l.trim());
            if (lines.length === 0) return alert('没有有效数据');

            const items = [];
            const errors = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const lineNum = i + 1;

                try {
                    if (batchType === 'proxyip') {
                        // ProxyIP 格式：地址#备注（不允许 socks5/http）
                        const parts = line.split('#');
                        const address = parts[0].trim();
                        const remark = parts[1] ? parts[1].trim() : '';
                        if (!address) throw new Error('地址不能为空');
                        if (address.startsWith('socks') || address.startsWith('http')) throw new Error('SOCKS5/HTTP 请添加到全局出站');
                        items.push({ address, remark: remark || undefined });
                    } else if (batchType === 'outbound') {
                        // Outbound 格式：socks5://... 或 http://...#备注
                        const parts = line.split('#');
                        let address = parts[0].trim();
                        const remark = parts[1] ? parts[1].trim() : '';
                        if (!address) throw new Error('地址不能为空');
                        if (!address.startsWith('socks') && !address.startsWith('http')) throw new Error('必须是 socks5:// 或 http:// 格式');

                        // 处理 socks:// 格式（base64 user info）
                        if (address.startsWith('socks://')) {
                            try {
                                const urlStr = address.replace(/^socks:\/\//, 'socks5://');
                                const url = new URL(urlStr);
                                let username = url.username ? decodeURIComponent(url.username) : '';
                                let password = url.password ? decodeURIComponent(url.password) : '';

                                if (username && !password) {
                                    try {
                                        const decoded = atob(username);
                                        if (decoded.includes(':')) {
                                            const parts = decoded.split(':');
                                            username = parts[0];
                                            password = parts.slice(1).join(':');
                                            // 重构为 socks5://user:pass@host:port
                                            address = `socks5://${encodeURIComponent(username)}:${encodeURIComponent(password)}@${url.hostname}:${url.port}`;
                                        }
                                    } catch (e) {
                                        // ignore conversion error
                                    }
                                } else {
                                    // 如果标准 socks:// 但没有 base64 转换需求，也转为 socks5:// 以便后端统一处理
                                    address = urlStr;
                                }
                            } catch (e) {
                                // ignore URL parse error
                            }
                        }

                        items.push({ address, remark: remark || undefined });
                    } else if (batchType === 'argo') {
                        // ARGO 格式：vl://... 或 vm://...
                        const remarkMatch = line.match(/#(.+)$/);
                        let remark = '';
                        if (line.startsWith('vl' + 'ess://')) {
                            remark = remarkMatch ? decodeURIComponent(remarkMatch[1]) : '';
                        } else if (line.startsWith('vm' + 'ess://')) {
                            // VM格式，从base64解码中提取备注
                            try {
                                const base64Data = line.substring(8);
                                const jsonStr = atob(base64Data);
                                const vmConfig = JSON.parse(jsonStr);
                                remark = vmConfig.ps || '';
                            } catch (e) {
                                remark = '';
                            }
                        } else {
                            throw new Error('必须是 vl' + 'ess:// 或 vm' + 'ess:// 格式');
                        }
                        items.push({ template_link: line, remark: remark || undefined });
                    } else {
                        // CFIP 格式：地址#名字#备注
                        // 或 地址:端口#名字#备注 (但端口目前主要通过 input 控制，这里简化处理)

                        const parts = line.split('#');
                        let address = parts[0].trim();
                        let name = parts[1] ? parts[1].trim() : undefined;
                        let remark = parts[2] ? parts[2].trim() : undefined;

                        if (!address) throw new Error('地址不能为空');

                        let port = 443;
                        if (address.includes(':')) {
                            const ap = address.split(':');
                            address = ap[0].trim();
                            port = parseInt(ap[1]) || 443;
                        }

                        items.push({ address, port, name, remark });
                    }
                } catch (e) {
                    errors.push(`第${lineNum}行: ${e.message}`);
                }
            }

            // 批量查重
            const uniqueItems = [];
            // 用于检查本次批量中的重复项
            const currentBatchKeys = new Set();

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                let isDup = false;
                let key = '';

                if (batchType === 'proxyip') {
                    key = item.address;
                } else if (batchType === 'outbound') {
                    key = item.address;
                } else if (batchType === 'cfip') {
                    key = item.address + ':' + item.port;
                } else if (batchType === 'argo') {
                    key = item.template_link;
                }

                if (checkDuplicate(batchType, item)) {
                    errors.push(`重复数据已跳过: ${key}`);
                    isDup = true;
                } else if (currentBatchKeys.has(key)) {
                    errors.push(`本次批量重复已跳过: ${key}`);
                    isDup = true;
                }

                if (!isDup) {
                    uniqueItems.push(item);
                    currentBatchKeys.add(key);
                }
            }

            // 如果只有重复错误，且没有有效数据，则停止
            if (uniqueItems.length === 0 && errors.length > 0) {
                document.getElementById('batchAlert').innerHTML = '<div class="alert alert-error">所有数据均为重复或格式错误<br>' + errors.join('<br>') + '</div>';
                return;
            }

            // 如果有部分错误（格式错误或重复），但也有有效数据，显示错误提示但继续执行
            if (errors.length > 0) {
                document.getElementById('batchAlert').innerHTML = '<div class="alert alert-warning">以下数据存在问题被跳过，将继续添加剩余数据：<br>' + errors.join('<br>') + '</div>';
            }

            // 批量添加
            showLoading();
            let success = 0, failed = 0;
            for (const item of uniqueItems) {
                try {
                    const d = await api('/' + batchType, 'POST', item);
                    if (d.success) success++; else failed++;
                } catch (e) {
                    failed++;
                }
            }
            hideLoading();

            document.getElementById('batchAlert').innerHTML = `<div class="alert alert-success">成功添加 ${success} 条${failed > 0 ? '，失败 ' + failed + ' 条' : ''}</div>`;
            if (batchType === 'proxyip') await loadProxyIPs();
            else if (batchType === 'outbound') await loadOutbounds();
            else if (batchType === 'argo') await loadArgoSubscribes();
            else await loadCFIPs();

            if (failed === 0) {
                setTimeout(() => closeBatchModal(), 1500);
            }
        }

        async function batchEnable(type, enabled) {
            const className = type === 'proxyip' ? 'proxyip-check' : type === 'outbound' ? 'outbound-check' : type === 'argo' ? 'argo-check' : 'cfip-check';
            // 只选择可见的复选框（排除隐藏的视图）
            const checks = Array.from(document.querySelectorAll('.' + className + ':checked')).filter(cb => {
                let el = cb;
                while (el) {
                    if (el.classList && el.classList.contains('hidden')) return false;
                    el = el.parentElement;
                }
                return true;
            });
            if (checks.length === 0) return alert('请先选择要修改的项');

            if (!confirm(`确定${enabled ? '启用' : '禁用'}选中的 ${checks.length} 项？`)) return;

            showLoading();
            let success = 0, failed = 0;
            for (const cb of checks) {
                try {
                    const d = await api('/' + type + '/' + cb.value, 'PUT', { enabled });
                    if (d.success) success++; else failed++;
                } catch (e) {
                    failed++;
                }
            }
            hideLoading();

            alert(`操作完成：成功 ${success} 条${failed > 0 ? '，失败 ' + failed + ' 条' : ''}`);
            if (type === 'proxyip') await loadProxyIPs();
            else if (type === 'outbound') await loadOutbounds();
            else if (type === 'argo') await loadArgoSubscribes();
            else await loadCFIPs();
        }

        async function batchSetStatus(type) {
            const statusSelect = document.getElementById(type + 'BatchStatus');
            const status = statusSelect ? statusSelect.value : 'enabled';
            const className = type === 'proxyip' ? 'proxyip-check' : type === 'outbound' ? 'outbound-check' : type === 'argo' ? 'argo-check' : 'cfip-check';

            // 只选择可见的复选框（排除隐藏的视图）
            const checks = Array.from(document.querySelectorAll('.' + className + ':checked')).filter(cb => {
                let el = cb;
                while (el) {
                    if (el.classList && el.classList.contains('hidden')) return false;
                    el = el.parentElement;
                }
                return true;
            });
            if (checks.length === 0) return alert('请先选择要修改的项');

            const statusNames = { enabled: '启用', disabled: '禁用', invalid: '失效' };
            if (!confirm(`确定将选中的 ${checks.length} 项设置为"${statusNames[status]}"状态？`)) return;

            showLoading();
            let success = 0, failed = 0;
            for (const cb of checks) {
                try {
                    const data = type === 'cfip' ? { status } : { status, enabled: status === 'enabled' };
                    const d = await api('/' + type + '/' + cb.value, 'PUT', data);
                    if (d.success) success++; else failed++;
                } catch (e) {
                    failed++;
                }
            }
            hideLoading();

            alert(`操作完成：成功 ${success} 条${failed > 0 ? '，失败 ' + failed + ' 条' : ''}`);
            if (type === 'proxyip') await loadProxyIPs();
            else if (type === 'outbound') await loadOutbounds();
            else if (type === 'argo') await loadArgoSubscribes();
            else await loadCFIPs();
        }

        async function batchDelete(type) {
            const className = type === 'proxyip' ? 'proxyip-check' : type === 'outbound' ? 'outbound-check' : type === 'argo' ? 'argo-check' : 'cfip-check';
            // 只选择可见的复选框（排除隐藏的视图）
            const checks = Array.from(document.querySelectorAll('.' + className + ':checked')).filter(cb => {
                let el = cb;
                while (el) {
                    if (el.classList && el.classList.contains('hidden')) return false;
                    el = el.parentElement;
                }
                return true;
            });
            if (checks.length === 0) return alert('请先选择要删除的项');

            if (!confirm(`确定删除选中的 ${checks.length} 项？`)) return;

            showLoading();
            let success = 0, failed = 0;
            for (const cb of checks) {
                try {
                    const d = await api('/' + type + '/' + cb.value, 'DELETE');
                    if (d.success) success++; else failed++;
                } catch (e) {
                    failed++;
                }
            }
            hideLoading();

            alert(`删除完成：成功 ${success} 条${failed > 0 ? '，失败 ' + failed + ' 条' : ''}`);
            if (type === 'proxyip') await loadProxyIPs();
            else if (type === 'outbound') await loadOutbounds();
            else if (type === 'argo') await loadArgoSubscribes();
            else await loadCFIPs();
        }
    </script>
</body>

</html>