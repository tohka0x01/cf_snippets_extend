<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CF Snippets Extend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh
        }

        .login-box {
            background: #fff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
            width: 100%;
            max-width: 400px
        }

        .login-box h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px
        }

        .form-group {
            margin-bottom: 20px
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all .2s
        }

        .btn-primary {
            background: #667eea;
            color: #fff
        }

        .btn-primary:hover {
            background: #5568d3
        }

        .btn-success {
            background: #48c774;
            color: #fff
        }

        .btn-success:hover {
            background: #3abb67
        }

        .btn-warning {
            background: #ffdd57;
            color: #333
        }

        .btn-warning:hover {
            background: #ffd83d
        }

        .btn-info {
            background: #3298dc;
            color: #fff
        }

        .btn-info:hover {
            background: #2793da
        }

        .btn-danger {
            background: #f14668;
            color: #fff
        }

        .btn-danger:hover {
            background: #ef2e4a
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
            white-space: nowrap
        }

        .btn-full {
            width: 100%;
            padding: 12px
        }

        .hidden {
            display: none !important
        }

        .header {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-sizing: border-box
        }

        .header h1 {
            color: #667eea;
            font-size: 24px
        }

        .tabs {
            display: flex;
            gap: 10px;
            background: #fff;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .1);
            width: 100%;
            box-sizing: border-box
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            white-space: nowrap
        }

        .tab.active {
            background: #667eea;
            color: #fff
        }

        .panel {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .1);
            width: 100%;
            box-sizing: border-box
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px
        }

        .panel-header h2 {
            font-size: 18px;
            color: #333
        }

        .table {
            width: 100%;
            border-collapse: collapse
        }

        .table th,
        .table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
            font-size: 14px;
            vertical-align: middle
        }

        .table th {
            background: #f7f9fc;
            color: #333;
            font-weight: 600
        }

        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px
        }

        .badge-info {
            background: #e3f2fd;
            color: #1976d2
        }

        .actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: nowrap
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000
        }

        .modal-content {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 450px
        }

        .modal-content-large {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px
        }

        .modal-header h3 {
            font-size: 18px;
            color: #333
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32
        }

        .alert-error {
            background: #ffebee;
            color: #c62828
        }

        .result-box {
            background: #f7f9fc;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px
        }

        .result-box pre {
            background: #fff;
            padding: 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 150px;
            overflow: auto
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            border-radius: 22px
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: .3s
        }

        input:checked+.slider {
            background: #667eea
        }

        input:checked+.slider:before {
            transform: translateX(18px)
        }

        .addr-cell {
            max-width: 200px;
            word-break: break-all;
            cursor: help
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 16px
        }

        .outbound-card {
            background: #fff;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 12px;
            position: relative;
            transition: all .3s;
            min-width: 0;
            overflow: hidden
        }

        .outbound-card:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, .2)
        }

        .outbound-card.offline {
            border-color: #e1e8ed;
            background: #fff
        }

        .outbound-card.online {
            border-color: #e1e8ed;
            background: #fff
        }

        .outbound-card.tested-online {
            border-color: #48c774;
            background: #f0fdf4
        }

        .outbound-card.tested-offline {
            border-color: #f14668;
            background: #fff5f7
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            min-width: 0;
            overflow: hidden
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            min-width: 0
        }

        .card-checkbox {
            position: absolute;
            top: 10px;
            right: 10px
        }

        .card-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            margin-bottom: 6px
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block
        }

        .status-dot.online {
            background: #48c774
        }

        .status-dot.offline {
            background: #f14668
        }

        .status-dot.unknown {
            background: #999
        }

        .card-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.5;
            min-width: 0;
            overflow: hidden
        }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            overflow: hidden;
            min-width: 0
        }

        .card-info-row>span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            min-width: 0
        }

        .card-latency {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 8px 0;
            min-height: 28px
        }

        .card-latency.good {
            color: #48c774
        }

        .card-latency.medium {
            color: #ffdd57
        }

        .card-latency.bad {
            color: #f14668
        }

        .card-latency.unknown {
            color: #999;
            font-size: 13px
        }

        .card-actions {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
            margin-top: 10px
        }

        .card-actions .btn {
            flex: 0 0 auto;
            min-width: auto
        }

        .card-actions .card-latency {
            flex: 1;
            text-align: left;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            min-height: auto;
            display: flex;
            align-items: center
        }

        .exit-link {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            transition: all .2s
        }

        .exit-link:hover {
            color: #5568d3;
            text-decoration: underline;
            font-weight: 600
        }

        @media (max-width:768px) {
            .container {
                padding: 10px
            }

            .header {
                flex-direction: column;
                gap: 8px;
                align-items: stretch
            }

            .header h1 {
                font-size: 18px;
                text-align: center
            }

            .header>div {
                justify-content: center;
                flex-wrap: wrap;
                gap: 6px
            }

            #toggleGlobalViewBtn {
                display: none !important
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding: 8px 10px
            }

            .tab {
                flex-shrink: 0;
                font-size: 12px;
                padding: 6px 12px
            }

            .panel {
                padding: 12px;
                background: #fff;
                border-radius: 16px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, .1)
            }

            .panel-header {
                flex-direction: column;
                gap: 6px;
                align-items: stretch
            }

            .panel-header h2 {
                font-size: 14px;
                text-align: center;
                margin-bottom: 4px
            }

            .panel-header>div {
                display: flex !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                gap: 6px !important;
                padding: 4px 0 !important;
                justify-content: flex-start !important;
                scrollbar-width: thin;
                width: 100%
            }

            .panel-header>div::-webkit-scrollbar {
                height: 4px
            }

            .panel-header>div::-webkit-scrollbar-thumb {
                background: #667eea;
                border-radius: 2px
            }

            .panel-header .btn {
                font-size: 12px !important;
                padding: 6px 12px !important;
                white-space: nowrap !important;
                flex: 0 0 auto !important;
                min-width: fit-content !important
            }

            .panel>div[style*="background:#e8f0fe"] {
                font-size: 11px;
                padding: 8px;
                margin-bottom: 8px
            }

            #proxyipListView,
            #outboundListView,
            #cfipListView,
            #argoListView {
                display: none !important
            }

            #proxyipCardView,
            #outboundCardView,
            #cfipCardView,
            #argoCardView {
                display: grid !important
            }

            .card-grid {
                grid-template-columns: 1fr;
                gap: 10px
            }

            .outbound-card {
                padding: 10px
            }

            .card-title {
                font-size: 14px
            }

            .card-info {
                font-size: 11px;
                margin-bottom: 6px
            }

            .card-info-row {
                font-size: 11px;
                margin-bottom: 2px
            }

            .card-actions {
                gap: 8px;
                margin-top: 8px
            }

            .modal-content,
            .modal-content-large {
                width: 95%;
                max-width: 95%;
                margin: 10px;
                padding: 12px
            }

            .modal-header h3 {
                font-size: 16px
            }

            .form-group {
                margin-bottom: 12px
            }

            .form-group label {
                font-size: 13px
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 13px;
                padding: 8px
            }

            .login-box {
                padding: 20px;
                margin: 10px
            }

            .login-box h1 {
                font-size: 20px
            }

            .result-box {
                padding: 12px
            }

            .result-box pre {
                font-size: 10px;
                max-height: 100px;
                padding: 8px
            }

            .switch {
                width: 36px;
                height: 20px
            }

            .switch .slider:before {
                height: 14px;
                width: 14px;
                left: 3px;
                bottom: 3px
            }

            .switch input:checked+.slider:before {
                transform: translateX(16px)
            }
        }
    </style>
</head>

<body>
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1 style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">ğŸ” CF Snippets Extend</h1>
            <div id="loginAlert"></div>
            <div class="form-group"><label>API Key</label><input type="password" id="apiKeyInput"
                    placeholder="è¯·è¾“å…¥ API Key"></div>
            <button class="btn btn-primary btn-full" onclick="login()">ç™»å½•</button>
            <div style="text-align:center;margin-top:16px">
                <a href="https://github.com/assast/cf_snippets_extend" target="_blank"
                    style="display:inline-flex;align-items:center;gap:4px;color:#667eea;text-decoration:none;font-size:13px;transition:all .2s"
                    onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                    <svg height="14" width="14" viewBox="0 0 16 16" fill="currentColor">
                        <path
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                        </path>
                    </svg>
                    â­ Star on GitHub
                </a>
            </div>
        </div>
    </div>

    <div id="mainPage" class="container hidden">
        <div class="header">
            <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
                <h1 style="margin:0;white-space:nowrap">ğŸ“¡ CF Snippets Extend</h1>
                <a href="https://github.com/assast/cf_snippets_extend" target="_blank"
                    style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:#24292e;color:#fff;text-decoration:none;border-radius:4px;font-size:11px;transition:all .2s;white-space:nowrap"
                    onmouseover="this.style.background='#1a1e22'" onmouseout="this.style.background='#24292e'">
                    <svg height="12" width="12" viewBox="0 0 16 16" fill="currentColor">
                        <path
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                        </path>
                    </svg>
                    Star
                </a>
            </div>
            <div style="display:flex;gap:8px;flex-shrink:0;justify-content:flex-end"><button id="toggleGlobalViewBtn"
                    class="btn btn-primary btn-sm" data-icon="ğŸ“‹" onclick="toggleGlobalView()">ğŸ“‹ åˆ‡æ¢å¡ç‰‡</button><button
                    class="btn btn-success btn-sm" data-icon="ğŸ“¤" onclick="exportData()">ğŸ“¤ å¯¼å‡º</button><button
                    class="btn btn-primary btn-sm" data-icon="ğŸ“¥" onclick="importData()">ğŸ“¥ å¯¼å…¥</button><button
                    class="btn btn-danger btn-sm" data-icon="ğŸšª" onclick="logout()">ğŸšª é€€å‡º</button></div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('proxyip',this)">ProxyIP(åä»£IP)</button>
            <button class="tab" onclick="switchTab('outbound',this)">å…¨å±€å‡ºç«™</button>
            <button class="tab" onclick="switchTab('cfip',this)">CFIP(ä¼˜é€‰åŸŸå)</button>
            <button class="tab" onclick="switchTab('vlSubscribe',this)">è®¢é˜…ç”ŸæˆV<span>LESS</span></button>
            <button class="tab" onclick="switchTab('ssSubscribe',this)">è®¢é˜…ç”ŸæˆSS</button>
            <button class="tab" onclick="switchTab('argo',this)">ARGOä¼˜é€‰</button>
        </div>

        <div id="proxyipPanel" class="panel">
            <div class="panel-header">
                <h2>ProxyIP(åä»£IP) ç®¡ç†</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn btn-primary btn-sm" data-icon="â•" onclick="showBatchModal('proxyip')">â•
                        æ·»åŠ </button>
                    <button class="btn btn-success btn-sm" data-icon="âœ“" onclick="batchEnable('proxyip',true)">âœ“
                        å¯ç”¨</button>
                    <button class="btn btn-warning btn-sm" data-icon="âœ—" onclick="batchEnable('proxyip',false)">âœ—
                        ç¦ç”¨</button>
                    <button class="btn btn-danger btn-sm" data-icon="ğŸ—‘ï¸" onclick="batchDelete('proxyip')">ğŸ—‘ï¸
                        åˆ é™¤</button>
                </div>
            </div>
            <div
                style="background:#e8f0fe;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px;color:#1967d2">
                <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>ProxyIP(åä»£IP) ç”¨äºæ™®é€š IP/åŸŸåä»£ç†ï¼Œä¸æ”¯æŒ SOCKS5/HTTP åè®®ã€‚å¦‚éœ€æ·»åŠ  SOCKS5/HTTP
                ä»£ç†ï¼Œè¯·ä½¿ç”¨"å…¨å±€å‡ºç«™"åŠŸèƒ½ã€‚<br>
                <strong>ğŸ“Š èŠ‚ç‚¹æ•°é‡è®¡ç®—ï¼š</strong>è®¢é˜…èŠ‚ç‚¹æ•°é‡ = (åä»£IPæ•°é‡ + å…¨å±€å‡ºç«™æ•°é‡) Ã— ä¼˜é€‰åŸŸåæ•°é‡ã€‚<strong
                    style="color:#f14668">ä¸æ·»åŠ åä»£IPçš„è¯ï¼Œä¸ä¼šç”ŸæˆåŸç”ŸèŠ‚ç‚¹ã€‚</strong>
            </div>
            <div id="proxyipListView">
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="proxyipCheckAll" onchange="checkAll('proxyip',this.checked)">
                            </th>
                            <th>ID</th>
                            <th>åœ°å€</th>
                            <th>å¤‡æ³¨</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="proxyipTable"></tbody>
                </table>
            </div>
            <div id="proxyipCardView" class="card-grid hidden"></div>
        </div>

        <div id="outboundPanel" class="panel hidden">
            <div class="panel-header">
                <h2>å…¨å±€å‡ºç«™ç®¡ç†</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button id="toggleMaskBtn" class="btn btn-warning btn-sm" data-icon="ï¿½ï¸"
                        onclick="toggleAddressMask()">ï¿½ï¸ æ˜¾ç¤ºåœ°å€</button>
                    <button class="btn btn-primary btn-sm" data-icon="â•" onclick="showBatchModal('outbound')">â•
                        æ·»åŠ </button>
                    <button class="btn btn-success btn-sm" data-icon="âœ“" onclick="batchEnable('outbound',true)">âœ“
                        å¯ç”¨</button>
                    <button class="btn btn-warning btn-sm" data-icon="âœ—" onclick="batchEnable('outbound',false)">âœ—
                        ç¦ç”¨</button>
                    <button class="btn btn-success btn-sm" data-icon="ğŸ”" onclick="testAllOutbounds()">ğŸ” å…¨é‡æµ‹é€Ÿ</button>
                    <button class="btn btn-primary btn-sm" data-icon="ğŸŒ" onclick="checkAllExits()">ğŸŒ å‡ºç«™æ£€æµ‹</button>
                    <button class="btn btn-danger btn-sm" data-icon="ğŸ—‘ï¸" onclick="batchDelete('outbound')">ğŸ—‘ï¸
                        åˆ é™¤</button>
                </div>
            </div>
            <div
                style="background:#e8f0fe;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px;color:#1967d2">
                <strong>ğŸ’¡ æµ‹é€Ÿè¯´æ˜ï¼š</strong><br>
                1ã€æµ‹é€Ÿè¿‡ç¨‹ä»…ä»CFçš„è¾¹ç¼˜èŠ‚ç‚¹å‘èµ·è¿æ¥ï¼Œæ‰€ä»¥è¢«å¢™çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥æµ‹å»¶è¿Ÿï¼ŒåŒæ—¶å› ä¸ºä¸ä¼šè¿‡å¢™ï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´èŠ‚ç‚¹è¢«å¢™ï¼›å»¶è¿Ÿä»…ä»£è¡¨CFè¾¹ç¼˜èŠ‚ç‚¹åˆ°socks5/httpèŠ‚ç‚¹çš„å»¶è¿Ÿï¼Œç”¨äºåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è¿é€šï¼Œå®é™…ä½¿ç”¨å—ä¼˜é€‰IP/åŸŸåå½±å“å¯èƒ½å·®å¼‚è¾ƒå¤§ã€‚<br>
                2ã€æœ¬åœ°ä»£ç†ï¼ˆ127.0.0.1ï¼‰æ— æ³•ä» CF è®¿é—®ä¼šæ˜¾ç¤ºç¦»çº¿ã€‚
            </div>
            <div id="outboundListView">
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="outboundCheckAll"
                                    onchange="checkAll('outbound',this.checked)"></th>
                            <th>ID</th>
                            <th>åœ°å€</th>
                            <th>ç±»å‹</th>
                            <th>å‡ºç«™ä¿¡æ¯</th>
                            <th>å¤‡æ³¨</th>
                            <th>å»¶è¿Ÿ</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="outboundTable"></tbody>
                </table>
            </div>
            <div id="outboundCardView" class="card-grid hidden"></div>
        </div>

        <div id="cfipPanel" class="panel hidden">
            <div class="panel-header" style="margin-bottom:12px">
                <h2>CFIP(ä¼˜é€‰åŸŸå) ç®¡ç†</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn btn-primary btn-sm" data-icon="â•" onclick="showBatchModal('cfip')">â• æ·»åŠ </button>
                    <select id="cfipBatchStatus"
                        style="padding:4px 8px;border:1px solid #e1e8ed;border-radius:4px;font-size:12px">
                        <option value="enabled">å¯ç”¨</option>
                        <option value="disabled">ç¦ç”¨</option>
                        <option value="invalid">å¤±æ•ˆ</option>
                    </select>
                    <button class="btn btn-info btn-sm" data-icon="âœ“" onclick="batchSetStatus('cfip')">è®¾ç½®çŠ¶æ€</button>
                    <button class="btn btn-danger btn-sm" data-icon="ğŸ—‘ï¸" onclick="batchDelete('cfip')">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
            </div>
            <div
                style="display:flex;gap:12px;margin-bottom:12px;align-items:center;background:#f7f9fc;padding:8px;border-radius:8px">
                <div style="flex:1">
                    <input type="text" placeholder="ğŸ” æœç´¢ IP / ç«¯å£ / å¤‡æ³¨..."
                        style="width:100%;padding:6px 10px;border:1px solid #e1e8ed;border-radius:6px;font-size:13px"
                        oninput="handleCFIPSearch(event)">
                </div>
                <div
                    style="display:flex;align-items:center;gap:12px;font-size:13px;color:#666;border-left:1px solid #e1e8ed;padding-left:12px">
                    <span>çŠ¶æ€:</span>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox"
                            value="all" checked onchange="handleCFIPStatusChange(event)"> å…¨é€‰</label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox"
                            class="cfip-status-check" value="enabled" checked onchange="handleCFIPStatusChange(event)">
                        å¯ç”¨</label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox"
                            class="cfip-status-check" value="disabled" checked onchange="handleCFIPStatusChange(event)">
                        ç¦ç”¨</label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox"
                            class="cfip-status-check" value="invalid" checked onchange="handleCFIPStatusChange(event)">
                        å¤±æ•ˆ</label>
                </div>
                <div style="display:flex;align-items:center;gap:6px;font-size:13px;color:#666">
                    æ¯é¡µæ˜¾ç¤º:
                    <select style="padding:4px 8px;border:1px solid #e1e8ed;border-radius:4px;font-size:13px"
                        onchange="handleCFIPPageSize(event)">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
            </div>
            <div
                style="background:#e8f0fe;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px;color:#1967d2">
                <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>CFIP(ä¼˜é€‰åŸŸå) ç”¨äºé…ç½® Cloudflare ä¼˜é€‰ IP æˆ–åŸŸåï¼Œä½œä¸ºèŠ‚ç‚¹çš„è¿æ¥åœ°å€ã€‚<br>
                <strong>ğŸ“Š èŠ‚ç‚¹æ•°é‡è®¡ç®—ï¼š</strong>è®¢é˜…èŠ‚ç‚¹æ•°é‡ = (åä»£IPæ•°é‡ + å…¨å±€å‡ºç«™æ•°é‡) Ã— ä¼˜é€‰åŸŸåæ•°é‡ã€‚
            </div>
            <div id="cfipListView">
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="cfipCheckAll" onchange="checkAll('cfip',this.checked)"></th>
                            <th class="sort-header" onclick="handleCFIPSort('id')">ID <span id="sort-icon-id"></span>
                            </th>
                            <th class="sort-header" onclick="handleCFIPSort('name')">åˆ«å (Name) <span
                                    id="sort-icon-name"></span></th>
                            <th class="sort-header" onclick="handleCFIPSort('remark')">å¤‡æ³¨ (Remark) <span
                                    id="sort-icon-remark"></span></th>
                            <th class="sort-header" onclick="handleCFIPSort('address')">åœ°å€ <span
                                    id="sort-icon-address"></span></th>
                            <th class="sort-header" onclick="handleCFIPSort('port')">ç«¯å£ <span
                                    id="sort-icon-port"></span></th>
                            <th class="sort-header" onclick="handleCFIPSort('fail_count')">å¤±è´¥æ¬¡æ•° <span
                                    id="sort-icon-fail_count"></span></th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="cfipTable"></tbody>
                </table>
            </div>
            <div id="cfipCardView" class="card-grid hidden"></div>

            <div
                style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding:10px;background:#f7f9fc;border-radius:8px">
                <button id="cfipPrevBtn" class="btn btn-primary btn-sm" onclick="changeCFIPPage(-1)">â—€ ä¸Šä¸€é¡µ</button>
                <span id="cfipPageInfo" style="font-size:13px;color:#666">Page 1 of 1 (Total 0)</span>
                <button id="cfipNextBtn" class="btn btn-primary btn-sm" onclick="changeCFIPPage(1)">ä¸‹ä¸€é¡µ â–¶</button>
            </div>
        </div>

        <div id="vlSubscribePanel" class="panel hidden">
            <div class="panel-header">
                <h2>V<span>LESS</span> è®¢é˜…é…ç½®</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn btn-primary btn-sm" data-icon="â•" onclick="showSubscribeModal('vl' + 'ess')">â•
                        æ·»åŠ é…ç½®</button>
                </div>
            </div>

            <div id="vlAlert"></div>

            <div
                style="background:#fff3cd;border-left:4px solid #ffc107;padding:12px;border-radius:6px;margin-bottom:16px;font-size:13px;color:#856404">
                <strong>ğŸ’¡ é«˜çº§ç”¨æ³•ï¼šæŒ‡å®šIDç”Ÿæˆè®¢é˜…</strong><br>
                åœ¨è®¢é˜…URLåæ·»åŠ å‚æ•°å¯ä»¥ç”ŸæˆæŒ‡å®šèŠ‚ç‚¹çš„è®¢é˜…ï¼š<br>
                â€¢ <code>?proxyip=1,2,3</code> - æŒ‡å®šProxyIPçš„IDï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰<br>
                â€¢ <code>?outbound=1,2</code> - æŒ‡å®šå…¨å±€å‡ºç«™çš„ID<br>
                â€¢ <code>?cfip=1,2,3</code> - æŒ‡å®šCFIPçš„ID<br>
                â€¢ <code>?proxyip=1&outbound=2&cfip=1,2</code> - ç»„åˆä½¿ç”¨<br>
                <strong style="color:#d9534f">âš ï¸ æŒ‡å®šIDæ—¶ä¸æ£€æŸ¥å¯ç”¨çŠ¶æ€</strong>ï¼Œå³ä½¿è¢«ç¦ç”¨ä¹Ÿä¼šåŒ…å«åœ¨è®¢é˜…ä¸­ã€‚
            </div>

            <div id="vlConfigList"></div>
        </div>

        <div id="ssSubscribePanel" class="panel hidden">
            <div class="panel-header">
                <h2>Shadowsocks è®¢é˜…é…ç½®</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn btn-primary btn-sm" data-icon="â•" onclick="showSubscribeModal('ss')">â•
                        æ·»åŠ é…ç½®</button>
                </div>
            </div>

            <div id="ssAlert"></div>

            <div
                style="background:#fff3cd;border-left:4px solid #ffc107;padding:12px;border-radius:6px;margin-bottom:16px;font-size:13px;color:#856404">
                <strong>ğŸ’¡ é«˜çº§ç”¨æ³•ï¼šæŒ‡å®šIDç”Ÿæˆè®¢é˜…</strong><br>
                åœ¨è®¢é˜…URLåæ·»åŠ å‚æ•°å¯ä»¥ç”ŸæˆæŒ‡å®šèŠ‚ç‚¹çš„è®¢é˜…ï¼š<br>
                â€¢ <code>?proxyip=1,2,3</code> - æŒ‡å®šProxyIPçš„IDï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰<br>
                â€¢ <code>?outbound=1,2</code> - æŒ‡å®šå…¨å±€å‡ºç«™çš„ID<br>
                â€¢ <code>?cfip=1,2,3</code> - æŒ‡å®šCFIPçš„ID<br>
                â€¢ <code>?proxyip=1&outbound=2&cfip=1,2</code> - ç»„åˆä½¿ç”¨<br>
                <strong style="color:#d9534f">âš ï¸ æŒ‡å®šIDæ—¶ä¸æ£€æŸ¥å¯ç”¨çŠ¶æ€</strong>ï¼Œå³ä½¿è¢«ç¦ç”¨ä¹Ÿä¼šåŒ…å«åœ¨è®¢é˜…ä¸­ã€‚
            </div>

            <div id="ssConfigList"></div>
        </div>

        <div id="argoPanel" class="panel hidden">
            <div class="panel-header">
                <h2>ARGO ä¼˜é€‰è®¢é˜…ç®¡ç†</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn btn-primary btn-sm" data-icon="â•" onclick="showBatchModal('argo')">â•
                        æ·»åŠ é…ç½®</button>
                </div>
            </div>

            <div
                style="background:#e8f0fe;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px;color:#1967d2">
                <strong>ğŸ’¡ è¯´æ˜ï¼š</strong><br>
                1ã€ARGO ä¼˜é€‰è®¢é˜…ç”¨äºç®¡ç† V<span>LESS</span>/V<span>Mess</span> æ¨¡æ¿é“¾æ¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†æ¨¡æ¿ä¸­çš„"ä¼˜é€‰åŸŸå/IP:ç«¯å£"æ›¿æ¢ä¸ºæ‰€æœ‰å¯ç”¨çš„
                CFIPï¼Œç”Ÿæˆå¤šä¸ªä¼˜åŒ–èŠ‚ç‚¹ã€‚<br>
                2ã€æ”¯æŒ V<span>LESS</span> å’Œ V<span>Mess</span> ä¸¤ç§åè®®ã€‚<br>
                3ã€èŠ‚ç‚¹æ•°é‡ï¼šæ¯ä¸ªæ¨¡æ¿ä¼šç”Ÿæˆ N ä¸ªèŠ‚ç‚¹ï¼ˆN = å¯ç”¨çš„ CFIP æ•°é‡ï¼‰ã€‚
            </div>

            <div id="argoConfigList"></div>
        </div>
    </div>

    <div id="addModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ </h3><button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
            <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="submitModal()">ç¡®å®š</button>
        </div>
    </div>

    <div id="batchModal" class="modal hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="modal-header">
                <h3 id="batchModalTitle">æ‰¹é‡æ·»åŠ </h3><button class="close-btn" onclick="closeBatchModal()">&times;</button>
            </div>
            <div id="batchAlert"></div>
            <div id="batchHelp"
                style="background:#f7f9fc;padding:10px;border-radius:6px;margin-bottom:12px;font-size:12px;color:#666">
            </div>
            <div class="form-group"><label>æ‰¹é‡æ•°æ®ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</label><textarea id="batchInput" rows="10"
                    style="width:100%;padding:12px;border:2px solid #e1e8ed;border-radius:8px;font-size:14px;font-family:monospace"></textarea>
            </div>
            <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="submitBatch()">æ‰¹é‡æ·»åŠ </button>
        </div>
    </div>

    <div id="loadingOverlay" class="loading hidden">
        <div class="loading-spinner"></div>
    </div>

    <input type="file" id="importFileInput" accept=".json" style="display:none"
        onchange="handleImportFileSelect(event)">

    <div id="importModeModal" class="modal hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h3>é€‰æ‹©å¯¼å…¥æ¨¡å¼</h3><button class="close-btn" onclick="closeImportModeModal()">&times;</button>
            </div>
            <div style="margin-bottom:20px;font-size:14px;color:#666">
                <p style="margin-bottom:12px">è¯·é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š</p>
            </div>
            <button class="btn btn-success" style="width:100%;margin-bottom:12px;padding:16px;text-align:left"
                onclick="confirmImportMode('append')">
                <div style="font-size:16px;font-weight:bold;margin-bottom:4px">ğŸ“¥ ä½œä¸ºæ–°æ•°æ®å¯¼å…¥</div>
                <div style="font-size:12px;opacity:0.9">å°†å¯¼å…¥çš„æ•°æ®æ·»åŠ åˆ°ç°æœ‰æ•°æ®ä¸­ï¼Œä¸ä¼šåˆ é™¤ä»»ä½•ç°æœ‰æ•°æ®</div>
            </button>
            <button class="btn btn-danger" style="width:100%;padding:16px;text-align:left"
                onclick="confirmImportMode('replace')">
                <div style="font-size:16px;font-weight:bold;margin-bottom:4px">âš ï¸ å®Œå…¨è¦†ç›–å¯¼å…¥</div>
                <div style="font-size:12px;opacity:0.9">åˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®ï¼Œç„¶åå¯¼å…¥æ–°æ•°æ®ï¼ˆå±é™©æ“ä½œï¼‰</div>
            </button>
        </div>
    </div>

    <div id="exitDetailModal" class="modal hidden" onclick="if(event.target===this)closeExitDetail()">
        <div class="modal-content-large">
            <div class="modal-header">
                <h3>å‡ºå…¥ç«™è¯¦ç»†ä¿¡æ¯</h3><button class="close-btn" onclick="closeExitDetail()">&times;</button>
            </div>
            <div id="exitDetailBody" style="font-size:14px;line-height:1.8"></div>
        </div>
    </div>

    <div id="clashSettingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Clash è®¢é˜…è®¾ç½®</h3>
                <button class="close-btn" onclick="closeClashSettings()">&times;</button>
            </div>
            <div class="form-group">
                <label>æ’é™¤èŠ‚ç‚¹ (æ­£åˆ™è¡¨è¾¾å¼)</label>
                <input type="text" id="clashExclude" placeholder="ä¾‹å¦‚: æµé‡|å®˜ç½‘">
            </div>
            <div class="form-group">
                <label>åŒ…å«èŠ‚ç‚¹ (æ­£åˆ™è¡¨è¾¾å¼)</label>
                <input type="text" id="clashInclude" placeholder="ä¾‹å¦‚: é¦™æ¸¯|æ—¥æœ¬">
            </div>
            <div class="form-group" style="display:flex;align-items:center;justify-content:space-between">
                <label style="margin:0">å¯ç”¨ Emoji</label>
                <label class="switch">
                    <input type="checkbox" id="clashEmoji" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="alert alert-info" style="font-size:12px;margin-top:12px;background:#e3f2fd;color:#0d47a1">
                è®¾ç½®å°†ä¿å­˜åœ¨æœ¬åœ°ï¼Œå¹¶åº”ç”¨äºç”Ÿæˆçš„ Clash è®¢é˜…é“¾æ¥ã€‚
            </div>
            <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="saveClashSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <script>
        const API = '/api';
        let apiKey = localStorage.getItem('apiKey'), modalType = '', editId = null;
        let showFullAddress = false; // æ˜¯å¦æ˜¾ç¤ºå®Œæ•´åœ°å€
        let globalViewMode = localStorage.getItem('globalViewMode') || 'list'; // å…¨å±€è§†å›¾æ¨¡å¼ï¼šlist æˆ– card

        // Global state for CFIP pagination and search
        let cfipSearchText = '';
        let cfipStatusFilter = ['enabled', 'disabled', 'invalid'];
        let cfipPageSize = 20;
        let cfipCurrentPage = 1;

        // å…¨å±€ç¼“å­˜æ•°æ®ç”¨äºæŸ¥é‡
        let cachedProxyIPs = [];
        let cachedOutbounds = [];
        let cachedCFIPs = [];
        let cachedArgoList = [];
        let cachedVlConfigs = [];
        let cachedSSConfigs = [];

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden') }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden') }

        function toggleGlobalView() {
            globalViewMode = globalViewMode === 'list' ? 'card' : 'list';
            localStorage.setItem('globalViewMode', globalViewMode);
            const btn = document.getElementById('toggleGlobalViewBtn');
            if (globalViewMode === 'card') {
                btn.textContent = 'ğŸ“‹ åˆ‡æ¢åˆ—è¡¨';
                btn.setAttribute('data-icon', 'ğŸ“‹');
            } else {
                btn.textContent = 'ğŸ“‹ åˆ‡æ¢å¡ç‰‡';
                btn.setAttribute('data-icon', 'ğŸ“‹');
            }
            loadProxyIPs();
            loadOutbounds();
            loadCFIPs();
            loadArgoSubscribes();
        }

        function toggleAddressMask() {
            showFullAddress = !showFullAddress;
            const btn = document.getElementById('toggleMaskBtn');
            if (showFullAddress) {
                btn.textContent = 'ğŸ”’ éšè—åœ°å€';
                btn.setAttribute('data-icon', 'ğŸ”’');
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
            } else {
                btn.textContent = 'ğŸ‘ï¸ æ˜¾ç¤ºåœ°å€';
                btn.setAttribute('data-icon', 'ğŸ‘ï¸');
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }
            loadOutbounds();
        }

        function maskAddress(addr) {
            if (!addr) return '-';
            // å¦‚æœé€‰æ‹©æ˜¾ç¤ºå®Œæ•´åœ°å€ï¼Œç›´æ¥è¿”å›
            if (showFullAddress) return addr;
            // åªå¤„ç† socks5:// å’Œ http:// å¼€å¤´çš„åœ°å€
            if (addr.includes('://')) {
                // å®Œå…¨éšè—åœ°å€ï¼Œåªæ˜¾ç¤º ***
                return '***';
            }
            // å…¶ä»–åœ°å€ä¸å¤„ç†
            return addr;
        }

        document.addEventListener('DOMContentLoaded', () => { if (apiKey) checkSession() });
        document.getElementById('apiKeyInput').onkeypress = e => { if (e.key === 'Enter') login() };

        async function checkSession() {
            showLoading();
            try { const r = await fetch(API + '/proxyip', { headers: { 'X-API-Key': apiKey } }); if (r.ok) { showMain(); load() } else logout() } catch (e) { logout() }
            finally { hideLoading() }
        }

        async function login() {
            const k = document.getElementById('apiKeyInput').value.trim();
            if (!k) return alert('è¯·è¾“å…¥API Key');
            showLoading();
            try {
                const r = await fetch(API + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ apiKey: k }) });
                const d = await r.json();
                if (d.success) { apiKey = d.apiKey; localStorage.setItem('apiKey', apiKey); showMain(); load() }
                else alert(d.error || 'ç™»å½•å¤±è´¥');
            } catch (e) { alert('ç½‘ç»œé”™è¯¯') }
            finally { hideLoading() }
        }

        function logout() { apiKey = null; localStorage.removeItem('apiKey'); document.getElementById('loginPage').classList.remove('hidden'); document.getElementById('mainPage').classList.add('hidden') }
        function showMain() { document.getElementById('loginPage').classList.add('hidden'); document.getElementById('mainPage').classList.remove('hidden') }

        function switchTab(t, el) {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(x => x.classList.add('hidden'));
            el.classList.add('active'); document.getElementById(t + 'Panel').classList.remove('hidden');
        }

        async function api(path, method = 'GET', body = null) {
            const opt = { method, headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey } };
            if (body) opt.body = JSON.stringify(body);
            return (await fetch(API + path, opt)).json();
        }

        async function load() {
            showLoading();
            try {
                await Promise.all([loadProxyIPs(), loadOutbounds(), loadCFIPs(), loadVlConfig(), loadSSConfig(), loadArgoSubscribes()]);
                // æ›´æ–°å…¨å±€è§†å›¾åˆ‡æ¢æŒ‰é’®æ–‡æœ¬
                const btn = document.getElementById('toggleGlobalViewBtn');
                if (btn) {
                    if (globalViewMode === 'card') {
                        btn.textContent = 'ğŸ“‹ åˆ‡æ¢åˆ—è¡¨';
                        btn.setAttribute('data-icon', 'ğŸ“‹');
                    } else {
                        btn.textContent = 'ğŸ“‹ åˆ‡æ¢å¡ç‰‡';
                        btn.setAttribute('data-icon', 'ğŸ“‹');
                    }
                }
            } finally {
                hideLoading();
            }
        }

        function showClashSettings() {
            const settings = JSON.parse(localStorage.getItem('clashSettings') || '{}');
            document.getElementById('clashExclude').value = settings.exclude || '';
            document.getElementById('clashInclude').value = settings.include || '';
            document.getElementById('clashEmoji').checked = settings.emoji !== false;
            document.getElementById('clashSettingsModal').classList.remove('hidden');
        }

        function closeClashSettings() {
            document.getElementById('clashSettingsModal').classList.add('hidden');
        }

        function saveClashSettings() {
            const settings = {
                exclude: document.getElementById('clashExclude').value.trim(),
                include: document.getElementById('clashInclude').value.trim(),
                emoji: document.getElementById('clashEmoji').checked
            };
            localStorage.setItem('clashSettings', JSON.stringify(settings));
            closeClashSettings();
            loadVlConfig();
            loadSSConfig();
            alert('è®¾ç½®å·²ä¿å­˜');
        }

        function getClashUrl(subUrl) {
            const settings = JSON.parse(localStorage.getItem('clashSettings') || '{}');
            let url = `${location.origin}/sub/clash?url=${encodeURIComponent(subUrl)}`;
            if (settings.exclude) url += `&exclude=${encodeURIComponent(settings.exclude)}`;
            if (settings.include) url += `&include=${encodeURIComponent(settings.include)}`;
            if (settings.emoji === false) url += `&emoji=false`;
            return url;
        }

        function copyClashSub(subUrl) {
            const url = getClashUrl(subUrl);
            copyText(url);
        }

        async function loadVlConfig() {
            const d = await api('/subscribe/config?type=' + 'vl' + 'ess');
            if (!d.success) return;
            cachedVlConfigs = d.data; // æ›´æ–°ç¼“å­˜

            const list = document.getElementById('vlConfigList');
            if (d.data.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">æš‚æ— é…ç½®ï¼Œç‚¹å‡»"æ·»åŠ é…ç½®"å¼€å§‹</div>';
                return;
            }

            list.innerHTML = d.data.map(item => {
                const subUrl = `${location.origin}/sub/token/${item.token}`;
                const statusClass = item.enabled ? 'online' : 'offline';
                const statusText = item.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                return `
<div class="outbound-card ${statusClass}" style="margin-bottom:16px">
<div class="card-header">
<div style="flex:1">
<div class="card-title">${item.remark || 'V<span>LESS</span>è®¢é˜…-' + item.id}</div>
<div style="font-size:11px;color:#999;margin-top:4px">Token: ${item.token} | UUID: ${item.uuid}</div>
</div>
<span class="badge badge-${item.enabled ? 'success' : 'secondary'}">${statusText}</span>
</div>
<div class="card-info">
<div class="card-info-row"><strong>åŸŸå:</strong> ${item.snippets_domain}</div>
<div class="card-info-row"><strong>è·¯å¾„:</strong> ${item.proxy_path || '/?ed=2560'}</div>
<div class="card-info-row">
<strong>è®¢é˜…åœ°å€:</strong>
<code style="font-size:11px;word-break:break-all;display:block;margin-top:4px;padding:6px;background:#f5f5f5;border-radius:4px">${subUrl}</code>
</div>
</div>
<div class="card-actions">
<button class="btn btn-success btn-sm" onclick="copyText('${subUrl}')">ğŸ“‹ å¤åˆ¶è®¢é˜…</button>
<button class="btn btn-success btn-sm" onclick="copyClashSub('${subUrl}')">ğŸ“‹ å¤åˆ¶Clashè®¢é˜…</button>
<button class="btn btn-info btn-sm" onclick="showClashSettings()">âš™ï¸ è½¬æ¢è®¾ç½®</button>
<button class="btn btn-warning btn-sm" onclick="editSubscribeConfig('vl',${item.id})">âœï¸ ç¼–è¾‘</button>
<button class="btn btn-info btn-sm" onclick="resetSubscribeToken(${item.id})">ğŸ”„ é‡ç½®Token</button>
<button class="btn btn-${item.enabled ? 'secondary' : 'success'} btn-sm" onclick="toggleSubscribeEnable(${item.id},${!item.enabled})">${item.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
<button class="btn btn-danger btn-sm" onclick="deleteSubscribeConfig(${item.id})">ğŸ—‘ï¸ åˆ é™¤</button>
</div>
</div>
`;
            }).join('');
        }

        async function loadSSConfig() {
            const d = await api('/subscribe/config?type=ss');
            if (!d.success) return;
            cachedSSConfigs = d.data; // æ›´æ–°ç¼“å­˜

            const list = document.getElementById('ssConfigList');
            if (d.data.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">æš‚æ— é…ç½®ï¼Œç‚¹å‡»"æ·»åŠ é…ç½®"å¼€å§‹</div>';
                return;
            }

            list.innerHTML = d.data.map(item => {
                const subUrl = `${location.origin}/sub/token/${item.token}`;
                const statusClass = item.enabled ? 'online' : 'offline';
                const statusText = item.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                return `
<div class="outbound-card ${statusClass}" style="margin-bottom:16px">
<div class="card-header">
<div style="flex:1">
<div class="card-title">${item.remark || 'SSè®¢é˜…-' + item.id}</div>
<div style="font-size:11px;color:#999;margin-top:4px">Token: ${item.token} | å¯†ç : ${item.uuid}</div>
</div>
<span class="badge badge-${item.enabled ? 'success' : 'secondary'}">${statusText}</span>
</div>
<div class="card-info">
<div class="card-info-row"><strong>åŸŸå:</strong> ${item.snippets_domain}</div>
<div class="card-info-row"><strong>è·¯å¾„:</strong> ${item.proxy_path || '/' + item.uuid}</div>
<div class="card-info-row">
<strong>è®¢é˜…åœ°å€:</strong>
<code style="font-size:11px;word-break:break-all;display:block;margin-top:4px;padding:6px;background:#f5f5f5;border-radius:4px">${subUrl}</code>
</div>
</div>
<div class="card-actions">
<button class="btn btn-success btn-sm" onclick="copyText('${subUrl}')">ğŸ“‹ å¤åˆ¶è®¢é˜…</button>
<button class="btn btn-success btn-sm" onclick="copyClashSub('${subUrl}')">ğŸ“‹ å¤åˆ¶Clashè®¢é˜…</button>
<button class="btn btn-info btn-sm" onclick="showClashSettings()">âš™ï¸ è½¬æ¢è®¾ç½®</button>
<button class="btn btn-warning btn-sm" onclick="editSubscribeConfig('ss',${item.id})">âœï¸ ç¼–è¾‘</button>
<button class="btn btn-info btn-sm" onclick="resetSubscribeToken(${item.id})">ğŸ”„ é‡ç½®Token</button>
<button class="btn btn-${item.enabled ? 'secondary' : 'success'} btn-sm" onclick="toggleSubscribeEnable(${item.id},${!item.enabled})">${item.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
<button class="btn btn-danger btn-sm" onclick="deleteSubscribeConfig(${item.id})">ğŸ—‘ï¸ åˆ é™¤</button>
</div>
</div>
`;
            }).join('');
        }

        async function loadArgoSubscribes() {
            const d = await api('/argo');
            if (!d.success) return;
            cachedArgoList = d.data; // æ›´æ–°ç¼“å­˜

            const list = document.getElementById('argoConfigList');
            if (d.data.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:40px;color:#999">æš‚æ— é…ç½®ï¼Œç‚¹å‡»"æ·»åŠ "å¼€å§‹</div>';
                return;
            }

            list.innerHTML = d.data.map(item => {
                const subUrl = `${location.origin}/sub/argo/${item.token}`;
                const statusClass = item.enabled ? 'online' : 'offline';
                const statusText = item.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                const protocol = item.template_link.startsWith('vl' + 'ess://') ? 'V<span>LESS</span>' : (item.template_link.startsWith('vm' + 'ess://') ? 'V<span>Mess</span>' : 'æœªçŸ¥');

                return `
<div class="outbound-card ${statusClass}" style="margin-bottom:16px">
<div class="card-header">
<div style="flex:1">
<div class="card-title">${item.remark || 'ARGO-' + item.id}</div>
<div style="font-size:11px;color:#999;margin-top:4px">ID: ${item.id} | åè®®: <span class="badge badge-info">${protocol}</span></div>
</div>
<span class="badge badge-${item.enabled ? 'success' : 'secondary'}">${statusText}</span>
</div>
<div class="card-info">
<div class="card-info-row">
<span style="color:#999;min-width:60px">æ¨¡æ¿é“¾æ¥</span>
<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0;font-size:11px">${item.template_link}</span>
</div>
<div class="card-info-row">
<strong>è®¢é˜…åœ°å€:</strong>
<code style="font-size:11px;word-break:break-all;display:block;margin-top:4px;padding:6px;background:#f5f5f5;border-radius:4px">${subUrl}</code>
</div>
</div>
<div class="card-actions">
<button class="btn btn-success btn-sm" onclick="copyText('${subUrl}')">ğŸ“‹ å¤åˆ¶è®¢é˜…</button>
<button class="btn btn-success btn-sm" onclick="copyClashSub('${subUrl}')">ğŸ“‹ å¤åˆ¶Clashè®¢é˜…</button>
<button class="btn btn-info btn-sm" onclick="showClashSettings()">âš™ï¸ è½¬æ¢è®¾ç½®</button>
<button class="btn btn-warning btn-sm" onclick="editArgo(${item.id})">âœï¸ ç¼–è¾‘</button>
<button class="btn btn-info btn-sm" onclick="resetArgoToken(${item.id})">ğŸ”„ é‡ç½®Token</button>
<button class="btn btn-${item.enabled ? 'secondary' : 'success'} btn-sm" onclick="toggleArgoEnable(${item.id},${!item.enabled})">${item.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
<button class="btn btn-danger btn-sm" onclick="deleteArgo(${item.id})">ğŸ—‘ï¸ åˆ é™¤</button>
</div>
</div>
`;
            }).join('');
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼š' + err.message);
            });
        }

        async function toggleArgoEnable(id, enabled) {
            await api('/argo/' + id, 'PUT', { enabled: enabled ? 1 : 0 });
            loadArgoSubscribes();
        }

        async function editArgo(id) {
            const item = await api('/argo');
            const argo = item.data.find(i => i.id === id);
            if (!argo) return;

            const newTemplate = prompt('ä¿®æ”¹æ¨¡æ¿é“¾æ¥ï¼š', argo.template_link);
            if (!newTemplate) return;

            const newRemark = prompt('ä¿®æ”¹å¤‡æ³¨ï¼š', argo.remark || '');

            await api('/argo/' + id, 'PUT', { template_link: newTemplate, remark: newRemark, enabled: argo.enabled });
            loadArgoSubscribes();
        }

        async function deleteArgo(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ARGOè®¢é˜…å—ï¼Ÿ')) return;
            await api('/argo/' + id, 'DELETE');
            loadArgoSubscribes();
        }

        async function resetArgoToken(id) {
            if (!confirm('ç¡®å®šé‡ç½®æ­¤è®¢é˜…çš„ Tokenï¼Ÿ\\n\\né‡ç½®åæ—§çš„è®¢é˜…åœ°å€å°†å¤±æ•ˆï¼Œéœ€è¦ä½¿ç”¨æ–°çš„è®¢é˜…åœ°å€ã€‚')) return;
            showLoading();
            try {
                const d = await api(`/argo/${id}/reset-token`, 'POST');
                if (d.success) {
                    await loadArgoSubscribes();
                    alert(`Token å·²é‡ç½®\\n\\næ–° Token: ${d.data.token}`);
                } else alert(d.error);
            } finally { hideLoading() }
        }

        async function loadProxyIPs() {
            const d = await api('/proxyip');
            if (d.success) {
                cachedProxyIPs = d.data; // æ›´æ–°ç¼“å­˜
                // åˆ—è¡¨è§†å›¾
                document.getElementById('proxyipTable').innerHTML = d.data.map(i => `<tr id="proxy-${i.id}">
<td><input type="checkbox" class="proxyip-check" value="${i.id}"></td>
<td>${i.id}</td>
<td class="addr-cell">${i.address}</td>
<td>${i.remark || '-'}</td>
<td><label class="switch"><input type="checkbox" ${i.enabled ? 'checked' : ''} onchange="toggle('proxyip',${i.id},this.checked)"><span class="slider"></span></label></td>
<td class="actions">
<button class="btn btn-warning btn-sm" data-icon="âœï¸" onclick="editItem('proxyip',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}')">âœï¸ ç¼–è¾‘</button>
</td></tr>`).join('');
                document.getElementById('proxyipCheckAll').checked = false;

                // å¡ç‰‡è§†å›¾
                document.getElementById('proxyipCardView').innerHTML = d.data.map(i => {
                    const statusClass = i.enabled ? 'online' : 'offline';
                    const statusText = i.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                    return `<div class="outbound-card ${statusClass}" id="proxyip-card-${i.id}">
<input type="checkbox" class="card-checkbox proxyip-check" value="${i.id}">
<div class="card-header">
<div style="flex:1;padding-right:30px;min-width:0;overflow:hidden">
<div class="card-title">${i.remark || 'ProxyIP-' + i.id}</div>
</div>
</div>
<div class="card-info">
<div class="card-info-row">
<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0">${i.address}</span>
</div>
</div>
<div class="card-actions">
<div style="flex:1"></div>
<span onclick="editItem('proxyip',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}')" style="color:#667eea;cursor:pointer;font-size:13px;user-select:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">âœï¸ ç¼–è¾‘</span>
<label class="switch" style="margin:0;margin-left:12px">
<input type="checkbox" ${i.enabled ? 'checked' : ''} onchange="toggle('proxyip',${i.id},this.checked)">
<span class="slider"></span>
</label>
</div>
</div>`;
                }).join('');

                // æ ¹æ®å½“å‰è§†å›¾æ¨¡å¼æ˜¾ç¤ºå¯¹åº”çš„è§†å›¾
                if (globalViewMode === 'card') {
                    document.getElementById('proxyipListView').classList.add('hidden');
                    document.getElementById('proxyipCardView').classList.remove('hidden');
                } else {
                    document.getElementById('proxyipListView').classList.remove('hidden');
                    document.getElementById('proxyipCardView').classList.add('hidden');
                }
            }
        }

        async function loadOutbounds() {
            const d = await api('/outbound');
            if (d.success) {
                cachedOutbounds = d.data; // æ›´æ–°ç¼“å­˜
                // åˆ—è¡¨è§†å›¾
                document.getElementById('outboundTable').innerHTML = d.data.map(i => {
                    let exitInfo = '-';
                    if (i.exit_country || i.exit_city) {
                        const country = i.exit_country || '';
                        const city = i.exit_city || '';
                        exitInfo = country && city ? country + '-' + city : (country || city);
                        if (i.checked_at) {
                            const checkTime = new Date(i.checked_at).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                            exitInfo += ` <span style="font-size:11px;color:#999">(${checkTime})</span>`;
                        }
                    }
                    return `<tr id="outbound-${i.id}">
<td data-label="é€‰æ‹©"><input type="checkbox" class="outbound-check" value="${i.id}"></td>
<td data-label="ID">${i.id}</td>
<td data-label="åœ°å€" class="addr-cell" title="${i.address}">${maskAddress(i.address)}</td>
<td data-label="ç±»å‹"><span class="badge badge-info">${i.type}</span></td>
<td data-label="å‡ºç«™" id="exit-${i.id}" class="exit-link" onclick="showExitDetail(${i.id})" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…">${exitInfo}</td>
<td data-label="å¤‡æ³¨">${i.remark || '-'}</td>
<td data-label="å»¶è¿Ÿ" id="out-lat-${i.id}" style="color:#999">-</td>
<td data-label="çŠ¶æ€"><label class="switch"><input type="checkbox" ${i.enabled ? 'checked' : ''} onchange="toggle('outbound',${i.id},this.checked)"><span class="slider"></span></label></td>
<td data-label="æ“ä½œ" class="actions">
<button class="btn btn-success btn-sm" data-icon="âš¡" onclick="testSingleOutbound(${i.id})">âš¡ æµ‹é€Ÿ</button>
<button class="btn btn-warning btn-sm" data-icon="âœï¸" onclick="editItem('outbound',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}')">âœï¸ ç¼–è¾‘</button>
</td></tr>`;
                }).join('');
                document.getElementById('outboundCheckAll').checked = false;

                // å¡ç‰‡è§†å›¾
                document.getElementById('outboundCardView').innerHTML = d.data.map(i => {
                    let exitInfo = 'æœªæ£€æµ‹';
                    let exitClass = 'unknown';
                    if (i.exit_country || i.exit_city) {
                        const country = i.exit_country || '';
                        const city = i.exit_city || '';
                        exitInfo = country && city ? country + '-' + city : (country || city);
                        exitClass = 'online';
                    }
                    const statusClass = i.enabled ? 'online' : 'offline';
                    const statusText = i.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                    return `<div class="outbound-card ${statusClass}" id="outbound-card-${i.id}">
<input type="checkbox" class="card-checkbox outbound-check" value="${i.id}">
<div class="card-header">
<div style="flex:1;padding-right:30px;min-width:0;overflow:hidden">
<div class="card-title">${i.remark || 'èŠ‚ç‚¹-' + i.id}</div>
</div>
</div>
<div class="card-info">
<div class="card-info-row">
<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0">${maskAddress(i.address)}</span>
</div>
<div class="card-info-row">
<span id="exit-card-${i.id}" class="exit-link" onclick="showExitDetail(${i.id})" title="ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0">${exitInfo}</span>
</div>
</div>
<div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
<div class="card-latency unknown" id="out-lat-card-${i.id}" onclick="testSingleOutbound(${i.id})" style="margin:0;font-size:24px;cursor:pointer;user-select:none;line-height:1" title="ç‚¹å‡»æµ‹é€Ÿ">âš¡</div>
<div style="display:flex;gap:12px;align-items:center">
<span onclick="editItem('outbound',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}')" style="color:#667eea;cursor:pointer;font-size:13px;user-select:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">âœï¸ ç¼–è¾‘</span>
<label class="switch" style="margin:0">
<input type="checkbox" ${i.enabled ? 'checked' : ''} onchange="toggle('outbound',${i.id},this.checked)">
<span class="slider"></span>
</label>
</div>
</div>
</div>`;
                }).join('');

                // æ ¹æ®å½“å‰è§†å›¾æ¨¡å¼æ˜¾ç¤ºå¯¹åº”çš„è§†å›¾
                if (globalViewMode === 'card') {
                    document.getElementById('outboundListView').classList.add('hidden');
                    document.getElementById('outboundCardView').classList.remove('hidden');
                } else {
                    document.getElementById('outboundListView').classList.remove('hidden');
                    document.getElementById('outboundCardView').classList.add('hidden');
                }
            }
        }

        async function loadCFIPs() {
            const d = await api('/cfip');
            if (d.success) {
                cachedCFIPs = d.data; // æ›´æ–°ç¼“å­˜
                renderCFIPs();
            }
        }

        function renderCFIPs() {
            if (!cachedCFIPs) return;

            // Filter
            let filteredData = [...cachedCFIPs];

            // Sort
            if (cfipSortColumn) {
                filteredData.sort((a, b) => {
                    let valA = a[cfipSortColumn];
                    let valB = b[cfipSortColumn];

                    if (cfipSortColumn === 'id' || cfipSortColumn === 'port' || cfipSortColumn === 'fail_count') {
                        valA = parseInt(valA) || 0;
                        valB = parseInt(valB) || 0;
                    } else {
                        valA = (valA || '').toString().toLowerCase();
                        valB = (valB || '').toString().toLowerCase();
                    }

                    if (valA < valB) return cfipSortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return cfipSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Status Filter
            if (cfipStatusFilter.length < 3) { // If not all selected
                filteredData = filteredData.filter(item => {
                    const status = item.status || (item.enabled ? 'enabled' : 'disabled');
                    return cfipStatusFilter.includes(status);
                });
            }

            if (cfipSearchText) {
                filteredData = filteredData.filter(item => {
                    const searchStr = (item.address + ' ' + item.port + ' ' + (item.remark || '') + ' ' + (item.name || '')).toLowerCase();
                    return searchStr.includes(cfipSearchText);
                });
            }

            // Pagination
            const startIndex = (cfipCurrentPage - 1) * cfipPageSize;
            const endIndex = startIndex + cfipPageSize;
            const pageData = filteredData.slice(startIndex, endIndex);

            if (true) {
                // åˆ—è¡¨è§†å›¾
                document.getElementById('cfipTable').innerHTML = pageData.map(i => {
                    const status = i.status || (i.enabled ? 'enabled' : 'disabled');
                    let statusColor = '#999';
                    if (status === 'enabled') statusColor = '#48c774';
                    else if (status === 'disabled') statusColor = '#b5b5b5';
                    else if (status === 'invalid') statusColor = '#f14668';

                    return `<tr>
<td><input type="checkbox" class="cfip-check" value="${i.id}"></td>
<td>${i.id}</td>
<td style="font-weight:bold">${i.name || '-'}</td>
<td>${i.remark || '-'}</td>
<td>${i.address}</td>
<td>${i.port}</td>
<td>${i.fail_count || 0}</td>
<td>
    <select onchange="updateStatus('cfip', ${i.id}, this.value)" style="padding:2px 4px;border:1px solid #ddd;border-radius:4px;font-size:12px;color:${statusColor};border-color:${statusColor}">
        <option value="enabled" ${status === 'enabled' ? 'selected' : ''}>å¯ç”¨</option>
        <option value="disabled" ${status === 'disabled' ? 'selected' : ''}>ç¦ç”¨</option>
        <option value="invalid" ${status === 'invalid' ? 'selected' : ''}>å¤±æ•ˆ</option>
    </select>
</td>
<td class="actions">
<button class="btn btn-warning btn-sm" data-icon="âœï¸" onclick="editItem('cfip',${i.id},'${i.address.replace(/'/g, "\\\\'")}', '${(i.remark || '').replace(/'/g, "\\\\'")}', ${i.port}, '${(i.name || '').replace(/'/g, "\\\\'")}')">âœï¸ ç¼–è¾‘</button>
</td></tr>`;
                }).join('');
                document.getElementById('cfipCheckAll').checked = false;

                // å¡ç‰‡è§†å›¾
                document.getElementById('cfipCardView').innerHTML = pageData.map(i => {
                    const status = i.status || (i.enabled ? 'enabled' : 'disabled');
                    const statusClass = status === 'enabled' ? 'online' : (status === 'invalid' ? 'bad' : 'offline');

                    return `<div class="outbound-card ${statusClass}" id="cfip-card-${i.id}">
<input type="checkbox" class="card-checkbox cfip-check" value="${i.id}">
<div class="card-header">
<div style="flex:1;padding-right:30px;min-width:0;overflow:hidden">
<div class="card-title">${i.name || i.remark || 'CFIP-' + i.id}</div>
<div style="font-size:11px;color:#999;margin-top:2px">${i.remark || ''}</div>
</div>
</div>
<div class="card-info">
<div class="card-info-row">
<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0">${i.address}:${i.port}</span>
</div>
<div class="card-info-row" style="margin-top:4px;font-size:11px;color:#666">
<span>å¤±è´¥: ${i.fail_count || 0}</span>
<span style="margin-left:8px">çŠ¶æ€: ${status}</span>
</div>
</div>
<div class="card-actions">
<div style="flex:1"></div>
<span onclick="editItem('cfip',${i.id},'${i.address.replace(/'/g, "\\\\'")}','${(i.remark || '').replace(/'/g, "\\\\'")}',${i.port},'${(i.name || '').replace(/'/g, "\\\\'")}')" style="color:#667eea;cursor:pointer;font-size:13px;user-select:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">âœï¸ ç¼–è¾‘</span>
</div>
</div>`;
                }).join('');

                // Update pagination controls
                updateCFIPPaginationControls(filteredData.length);

                // æ ¹æ®å½“å‰è§†å›¾æ¨¡å¼æ˜¾ç¤ºå¯¹åº”çš„è§†å›¾
                if (globalViewMode === 'card') {
                    document.getElementById('cfipListView').classList.add('hidden');
                    document.getElementById('cfipCardView').classList.remove('hidden');
                } else {
                    document.getElementById('cfipListView').classList.remove('hidden');
                    document.getElementById('cfipCardView').classList.add('hidden');
                }
            }
        }



        let cfipSortColumn = 'id';
        let cfipSortDirection = 'asc';

        function handleCFIPSort(column) {
            if (cfipSortColumn === column) {
                cfipSortDirection = cfipSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                cfipSortColumn = column;
                cfipSortDirection = 'asc';
            }
            renderCFIPs();
            updateSortIcons();
        }

        function updateSortIcons() {
            const columns = ['id', 'name', 'remark', 'address', 'port', 'fail_count'];
            columns.forEach(col => {
                const icon = document.getElementById('sort-icon-' + col);
                if (icon) {
                    if (cfipSortColumn === col) {
                        icon.textContent = cfipSortDirection === 'asc' ? 'â†‘' : 'â†“';
                    } else {
                        icon.textContent = '';
                    }
                }
            });
        }

        function handleCFIPSearch(e) {
            cfipSearchText = e.target.value.trim().toLowerCase();
            cfipCurrentPage = 1;
            renderCFIPs();
        }

        function handleCFIPStatusChange(e) {
            const val = e.target.value;
            const isChecked = e.target.checked;

            if (val === 'all') {
                // Select/Deselect All
                const checks = document.querySelectorAll('.cfip-status-check');
                checks.forEach(c => c.checked = isChecked);
                if (isChecked) {
                    cfipStatusFilter = ['enabled', 'disabled', 'invalid'];
                } else {
                    cfipStatusFilter = [];
                }
            } else {
                // Individual check
                if (isChecked) {
                    if (!cfipStatusFilter.includes(val)) cfipStatusFilter.push(val);
                } else {
                    cfipStatusFilter = cfipStatusFilter.filter(s => s !== val);
                }

                // Sync "Select All" checkbox
                const allCheck = document.querySelector('input[value="all"]');
                const checks = document.querySelectorAll('.cfip-status-check');
                const allChecked = Array.from(checks).every(c => c.checked);
                if (allCheck) allCheck.checked = allChecked;
            }
            cfipCurrentPage = 1;
            renderCFIPs();
        }

        function handleCFIPPageSize(e) {
            cfipPageSize = parseInt(e.target.value);
            cfipCurrentPage = 1;
            renderCFIPs();
        }

        function changeCFIPPage(delta) {
            cfipCurrentPage += delta;
            renderCFIPs();
        }

        function updateCFIPPaginationControls(totalItems) {
            const totalPages = Math.ceil(totalItems / cfipPageSize) || 1;

            // Adjust current page if out of bounds
            if (cfipCurrentPage < 1) cfipCurrentPage = 1;
            if (cfipCurrentPage > totalPages) cfipCurrentPage = totalPages;

            document.getElementById('cfipPageInfo').textContent = `Page ${cfipCurrentPage} of ${totalPages} (Total ${totalItems})`;
            document.getElementById('cfipPrevBtn').disabled = cfipCurrentPage <= 1;
            document.getElementById('cfipNextBtn').disabled = cfipCurrentPage >= totalPages;
        }

        // æŸ¥é‡å‡½æ•°
        function checkDuplicate(type, data) {
            if (type === 'proxyip') {
                return cachedProxyIPs.some(i => i.address === data.address);
            } else if (type === 'outbound') {
                return cachedOutbounds.some(i => i.address === data.address);
            } else if (type === 'cfip') {
                return cachedCFIPs.some(i => i.address === data.address && i.port === data.port);
            } else if (type === 'argo') {
                return cachedArgoList.some(i => i.template_link === data.template_link);
            } else if (type === 'vl' + 'ess') {
                // vless ä½¿ç”¨åŸŸåæŸ¥é‡
                const domain = data.snippetsDomain || data.snippets_domain;
                return cachedVlConfigs.some(i => i.snippets_domain === domain);
            } else if (type === 'ss') {
                // ss ä½¿ç”¨åŸŸåæŸ¥é‡
                const domain = data.snippetsDomain || data.snippets_domain;
                return cachedSSConfigs.some(i => i.snippets_domain === domain);
            }
            return false;
        }

        async function testSingleSocks5(id) {
            const latCell = document.getElementById('lat-' + id);
            if (!latCell) return;
            latCell.textContent = 'æµ‹è¯•ä¸­...';
            latCell.style.color = '#999';
            try {
                const d = await api('/test-socks5', 'POST', { id });
                console.log('å•ä¸ªæµ‹é€Ÿç»“æœ:', d);
                if (d.success && d.results && d.results.length > 0) {
                    const result = d.results[0];
                    if (result.status === 'online') {
                        latCell.textContent = result.latency + 'ms';
                        latCell.style.color = result.latency < 200 ? '#48c774' : result.latency < 500 ? '#ffdd57' : '#f14668';
                    } else {
                        latCell.textContent = 'ç¦»çº¿';
                        latCell.style.color = '#f14668';
                        latCell.title = result.error || 'è¿æ¥å¤±è´¥';
                        console.error('SOCKS5ç¦»çº¿:', result);
                    }
                } else {
                    latCell.textContent = 'å¤±è´¥';
                    latCell.style.color = '#f14668';
                    console.error('APIè¿”å›é”™è¯¯:', d);
                }
            } catch (e) {
                latCell.textContent = 'é”™è¯¯';
                latCell.style.color = '#f14668';
                console.error('æµ‹é€Ÿå¼‚å¸¸:', e);
            }
        }

        async function testAllSocks5() {
            const rows = document.querySelectorAll('[id^="proxy-"]');
            const socks5Rows = Array.from(rows).filter(row => {
                const badge = row.querySelector('.badge-info');
                return badge && badge.textContent === 'socks5';
            });
            if (socks5Rows.length === 0) return alert('æ²¡æœ‰ SOCKS5 ç±»å‹çš„ ProxyIP');
            socks5Rows.forEach(row => {
                const latCell = row.querySelector('[id^="lat-"]');
                if (latCell) {
                    latCell.textContent = 'ç­‰å¾…...';
                    latCell.style.color = '#999';
                }
            });
            try {
                const d = await api('/test-socks5', 'POST', {});
                console.log('æ‰¹é‡æµ‹é€Ÿç»“æœ:', d);
                if (d.success && d.results) {
                    d.results.forEach(result => {
                        const latCell = document.getElementById('lat-' + result.id);
                        if (latCell) {
                            if (result.status === 'online') {
                                latCell.textContent = result.latency + 'ms';
                                latCell.style.color = result.latency < 200 ? '#48c774' : result.latency < 500 ? '#ffdd57' : '#f14668';
                            } else {
                                latCell.textContent = 'ç¦»çº¿';
                                latCell.style.color = '#f14668';
                                latCell.title = result.error || 'è¿æ¥å¤±è´¥';
                                console.error('ProxyIP ' + result.id + ' ç¦»çº¿:', result.error);
                            }
                        }
                    });
                }
            } catch (e) {
                alert('æµ‹é€Ÿå¤±è´¥: ' + e.message);
                console.error('æ‰¹é‡æµ‹é€Ÿå¼‚å¸¸:', e);
            }
        }

        async function testSingleOutbound(id) {
            const latCell = document.getElementById('out-lat-' + id);
            const latCardCell = document.getElementById('out-lat-card-' + id);
            const card = document.getElementById('outbound-card-' + id);
            if (!latCell && !latCardCell) return;

            // æ›´æ–°åˆ—è¡¨è§†å›¾
            if (latCell) {
                latCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                latCell.style.color = '#667eea';
            }
            // æ›´æ–°å¡ç‰‡è§†å›¾
            if (latCardCell) {
                latCardCell.innerHTML = '<span style="display:inline-block;width:16px;height:16px;border:3px solid #667eea;border-top:3px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                latCardCell.className = 'card-latency unknown';
                latCardCell.style.cursor = 'pointer';
            }

            try {
                const d = await api('/test-outbound', 'POST', { id });
                if (d.success && d.results && d.results.length > 0) {
                    const result = d.results[0];
                    if (result.status === 'online') {
                        const latency = result.latency;
                        const color = latency < 200 ? '#48c774' : latency < 500 ? '#ffdd57' : '#f14668';
                        const cardClass = latency < 200 ? 'good' : latency < 500 ? 'medium' : 'bad';
                        // æ›´æ–°åˆ—è¡¨è§†å›¾
                        if (latCell) {
                            latCell.textContent = latency + 'ms';
                            latCell.style.color = color;
                        }
                        // æ›´æ–°å¡ç‰‡è§†å›¾
                        if (latCardCell) {
                            latCardCell.textContent = latency + 'ms';
                            latCardCell.className = 'card-latency ' + cardClass;
                            latCardCell.style.cursor = 'pointer';
                            latCardCell.title = 'ç‚¹å‡»é‡æ–°æµ‹é€Ÿ';
                        }
                        // æ›´æ–°å¡ç‰‡è¾¹æ¡†é¢œè‰²ä¸ºç»¿è‰²ï¼ˆé€šï¼‰
                        if (card) {
                            card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-online';
                        }
                    } else {
                        // æ›´æ–°åˆ—è¡¨è§†å›¾
                        if (latCell) {
                            latCell.textContent = 'ç¦»çº¿';
                            latCell.style.color = '#f14668';
                            latCell.title = result.error || 'è¿æ¥å¤±è´¥';
                        }
                        // æ›´æ–°å¡ç‰‡è§†å›¾
                        if (latCardCell) {
                            latCardCell.textContent = 'ç¦»çº¿';
                            latCardCell.className = 'card-latency bad';
                            latCardCell.style.cursor = 'pointer';
                            latCardCell.title = 'ç‚¹å‡»é‡æ–°æµ‹é€Ÿ';
                        }
                        // æ›´æ–°å¡ç‰‡è¾¹æ¡†é¢œè‰²ä¸ºçº¢è‰²ï¼ˆä¸é€šï¼‰
                        if (card) {
                            card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-offline';
                        }
                    }
                } else {
                    if (latCell) {
                        latCell.textContent = 'å¤±è´¥';
                        latCell.style.color = '#f14668';
                    }
                    if (latCardCell) {
                        latCardCell.textContent = 'å¤±è´¥';
                        latCardCell.className = 'card-latency bad';
                        latCardCell.style.cursor = 'pointer';
                        latCardCell.title = 'ç‚¹å‡»é‡æ–°æµ‹é€Ÿ';
                    }
                    // æ›´æ–°å¡ç‰‡è¾¹æ¡†é¢œè‰²ä¸ºçº¢è‰²ï¼ˆä¸é€šï¼‰
                    if (card) {
                        card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-offline';
                    }
                }
            } catch (e) {
                if (latCell) {
                    latCell.textContent = 'é”™è¯¯';
                    latCell.style.color = '#f14668';
                }
                if (latCardCell) {
                    latCardCell.textContent = 'é”™è¯¯';
                    latCardCell.className = 'card-latency bad';
                    latCardCell.style.cursor = 'pointer';
                    latCardCell.title = 'ç‚¹å‡»é‡æ–°æµ‹é€Ÿ';
                }
                // æ›´æ–°å¡ç‰‡è¾¹æ¡†é¢œè‰²ä¸ºçº¢è‰²ï¼ˆä¸é€šï¼‰
                if (card) {
                    card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-offline';
                }
            }
        }

        async function testAllOutbounds() {
            const rows = document.querySelectorAll('[id^="outbound-"]');
            const cards = document.querySelectorAll('[id^="outbound-card-"]');
            if (rows.length === 0 && cards.length === 0) return alert('æ²¡æœ‰å‡ºç«™ä»£ç†');

            // æ›´æ–°åˆ—è¡¨è§†å›¾çš„åŠ è½½çŠ¶æ€
            rows.forEach(row => {
                const latCell = row.querySelector('[id^="out-lat-"]');
                if (latCell) {
                    latCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                    latCell.style.color = '#667eea';
                }
            });

            // æ›´æ–°å¡ç‰‡è§†å›¾çš„åŠ è½½çŠ¶æ€
            cards.forEach(card => {
                const latCell = card.querySelector('[id^="out-lat-card-"]');
                if (latCell) {
                    latCell.innerHTML = '<span style="display:inline-block;width:16px;height:16px;border:3px solid #667eea;border-top:3px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                    latCell.className = 'card-latency unknown';
                }
            });

            try {
                const d = await api('/test-outbound', 'POST', {});
                if (d.success && d.results) {
                    d.results.forEach(result => {
                        const latCell = document.getElementById('out-lat-' + result.id);
                        const latCardCell = document.getElementById('out-lat-card-' + result.id);
                        const card = document.getElementById('outbound-card-' + result.id);
                        const latency = result.latency;
                        const color = latency < 200 ? '#48c774' : latency < 500 ? '#ffdd57' : '#f14668';
                        const cardClass = latency < 200 ? 'good' : latency < 500 ? 'medium' : 'bad';

                        if (result.status === 'online') {
                            // æ›´æ–°åˆ—è¡¨è§†å›¾
                            if (latCell) {
                                latCell.textContent = latency + 'ms';
                                latCell.style.color = color;
                            }
                            // æ›´æ–°å¡ç‰‡è§†å›¾
                            if (latCardCell) {
                                latCardCell.textContent = latency + 'ms';
                                latCardCell.className = 'card-latency ' + cardClass;
                            }
                            // æ›´æ–°å¡ç‰‡è¾¹æ¡†é¢œè‰²ä¸ºç»¿è‰²ï¼ˆé€šï¼‰
                            if (card) {
                                card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-online';
                            }
                        } else {
                            // æ›´æ–°åˆ—è¡¨è§†å›¾
                            if (latCell) {
                                latCell.textContent = 'ç¦»çº¿';
                                latCell.style.color = '#f14668';
                                latCell.title = result.error || 'è¿æ¥å¤±è´¥';
                            }
                            // æ›´æ–°å¡ç‰‡è§†å›¾
                            if (latCardCell) {
                                latCardCell.textContent = 'ç¦»çº¿';
                                latCardCell.className = 'card-latency bad';
                            }
                            // æ›´æ–°å¡ç‰‡è¾¹æ¡†é¢œè‰²ä¸ºçº¢è‰²ï¼ˆä¸é€šï¼‰
                            if (card) {
                                card.className = card.className.replace(/tested-\w+/g, '').trim() + ' tested-offline';
                            }
                        }
                    });
                }
            } catch (e) {
                alert('æµ‹é€Ÿå¤±è´¥: ' + e.message);
                // æ¢å¤æ‰€æœ‰å»¶è¿Ÿæ˜¾ç¤º
                rows.forEach(row => {
                    const latCell = row.querySelector('[id^="out-lat-"]');
                    if (latCell && latCell.innerHTML.includes('spin')) {
                        latCell.textContent = '-';
                        latCell.style.color = '#999';
                    }
                });
                cards.forEach(card => {
                    const latCell = card.querySelector('[id^="out-lat-card-"]');
                    if (latCell && latCell.innerHTML.includes('spin')) {
                        latCell.textContent = 'æœªæµ‹é€Ÿ';
                        latCell.className = 'card-latency unknown';
                    }
                });
            }
        }

        async function updateStatus(type, id, status) {
            showLoading();
            try {
                // Determine enabled boolean for backward compatibility based on status
                const enabled = status === 'enabled';
                await api('/' + type + '/' + id, 'PUT', { status, enabled });
                if (type === 'proxyip') await loadProxyIPs();
                else if (type === 'outbound') await loadOutbounds();
                else await loadCFIPs();
            } finally {
                hideLoading();
            }
        }

        async function toggle(type, id, enabled) {
            showLoading();
            try {
                await api('/' + type + '/' + id, 'PUT', { enabled });
                if (type === 'proxyip') await loadProxyIPs();
                else if (type === 'outbound') await loadOutbounds();
                else await loadCFIPs();
            } finally {
                hideLoading();
            }
        }

        async function del(type, id) {
            if (!confirm('ç¡®å®šåˆ é™¤?')) return;
            showLoading();
            try {
                await api('/' + type + '/' + id, 'DELETE');
                if (type === 'proxyip') await loadProxyIPs();
                else if (type === 'outbound') await loadOutbounds();
                else await loadCFIPs();
            } finally {
                hideLoading();
            }
        }

        function showModal(type, id = null, addr = '', remark = '', port = 443, name = '') {
            modalType = type;
            editId = id;
            const isEdit = id !== null;
            const titles = { 'proxyip': 'ProxyIP(åä»£IP)', 'outbound': 'å…¨å±€å‡ºç«™', 'cfip': 'CFIP(ä¼˜é€‰åŸŸå)' };
            document.getElementById('modalTitle').textContent = (isEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ') + titles[type];
            if (type === 'proxyip') {
                document.getElementById('modalBody').innerHTML = `<div class="form-group"><label>åœ°å€</label><input type="text" id="mAddr" value="${addr}" placeholder="IP/åŸŸå"></div>
<div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="mRemark" value="${remark}"></div>`;
            } else if (type === 'outbound') {
                document.getElementById('modalBody').innerHTML = `<div class="form-group"><label>åœ°å€</label><input type="text" id="mAddr" value="${addr}" placeholder="socks5://host:port æˆ– http://host:port"></div>
<div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="mRemark" value="${remark}"></div>`;
            } else {
                document.getElementById('modalBody').innerHTML = `<div class="form-group"><label>åˆ«å (Name)</label><input type="text" id="mName" value="${name}" placeholder="å¯é€‰ï¼Œç”¨äºè®¢é˜…èŠ‚ç‚¹åç§°"></div>
<div class="form-group"><label>åœ°å€</label><input type="text" id="mAddr" value="${addr}" placeholder="ä¼˜é€‰åŸŸåæˆ–IP"></div>
<div class="form-group"><label>ç«¯å£</label><input type="number" id="mPort" value="${port}"></div>
<div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="mRemark" value="${remark}"></div>`;
            }
            document.getElementById('addModal').classList.remove('hidden');
        }

        function editItem(type, id, addr, remark, port, name) {
            showModal(type, id, addr, remark, port || 443, name || '');
        }

        function closeModal() { document.getElementById('addModal').classList.add('hidden'); editId = null }

        async function submitModal() {
            if (modalType === 'subscribe') {
                const type = document.getElementById('subscribeType').value;
                const uuid = document.getElementById('subUuid').value.trim();
                const domain = document.getElementById('subDomain').value.trim();
                const remark = document.getElementById('subRemark').value.trim();

                if (!uuid || !domain) return alert('è¯·å¡«å†™å¿…å¡«é¡¹');

                // å¤„ç† Path é€»è¾‘
                // VL é»˜è®¤ /?ed=2560
                // SS é»˜è®¤ /uuid
                const path = type === 'ss' ? '/' + uuid : '/?ed=2560';

                const body = { type, uuid, snippetsDomain: domain, proxyPath: path, remark: remark || undefined };
                const method = editId ? 'PUT' : 'POST';
                const apiPath = editId ? `/subscribe/config/${editId}` : '/subscribe/config';

                // æŸ¥é‡é€»è¾‘ (ä»…é™æ–°å¢)
                if (!editId) {
                    // å¯¹äº VLESS/SSï¼Œä½¿ç”¨åŸŸåæŸ¥é‡
                    const checkData = { snippets_domain: domain };

                    if (checkDuplicate(type, checkData)) {
                        return alert('é‡å¤æ·»åŠ ï¼šè¯¥åŸŸåå·²å­˜åœ¨');
                    }
                }

                showLoading();
                try {
                    const d = await api(apiPath, method, body);
                    if (d.success) {
                        closeModal();
                        await loadVlConfig();
                        await loadSSConfig();
                    } else {
                        alert(d.error || 'æ“ä½œå¤±è´¥');
                    }
                } finally {
                    hideLoading();
                }
                return;
            }

            const addr = document.getElementById('mAddr').value.trim();
            const remark = document.getElementById('mRemark').value.trim();
            if (!addr) return alert('è¯·è¾“å…¥åœ°å€');

            let body = { address: addr, remark: remark || undefined };
            if (modalType === 'cfip') {
                body.port = parseInt(document.getElementById('mPort').value) || 443;
                body.name = document.getElementById('mName').value.trim() || undefined;
            }

            const method = editId ? 'PUT' : 'POST';
            const path = editId ? '/' + modalType + '/' + editId : '/' + modalType;

            // æŸ¥é‡é€»è¾‘ (ä»…é™æ–°å¢)
            if (!editId) {
                if (checkDuplicate(modalType, body)) {
                    return alert('é‡å¤æ·»åŠ ï¼šè¯¥æ•°æ®å·²å­˜åœ¨');
                }
            }

            showLoading();
            try {
                const d = await api(path, method, body);
                if (d.success) {
                    closeModal();
                    if (modalType === 'proxyip') await loadProxyIPs();
                    else if (modalType === 'outbound') await loadOutbounds();
                    else await loadCFIPs();
                } else {
                    alert(d.error || 'æ“ä½œå¤±è´¥');
                }
            } finally {
                hideLoading();
            }
        }

        // è®¢é˜…é…ç½®æ“ä½œå‡½æ•°
        function showSubscribeModal(type) {
            modalType = 'subscribe';
            editId = null;
            document.getElementById('modalTitle').textContent = `æ·»åŠ ${type === 'vl' ? 'V<span>LESS</span>' : type.toUpperCase()}è®¢é˜…é…ç½®`;
            const label = type === 'vl' ? 'UUID' : 'å¯†ç ';
            document.getElementById('modalBody').innerHTML = `
<input type="hidden" id="subscribeType" value="${type === 'vl' ? 'vl' + 'ess' : type}">
<div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="subRemark" placeholder="ä¾‹å¦‚ï¼šç¾å›½èŠ‚ç‚¹"></div>
<div class="form-group"><label>${label}</label><input type="text" id="subUuid" placeholder="${type === 'vl' ? '12cbf86b-22bb-45b6-aadb-cb622a538d6a' : 'your-password'}"></div>
<div class="form-group"><label>Snippets/Worker åŸŸå</label><input type="text" id="subDomain" placeholder="your-worker.workers.dev"></div>
`;
            document.getElementById('addModal').classList.remove('hidden');
        }

        async function editSubscribeConfig(type, id) {
            const cfg = type === 'vl' ? 'vl' + 'ess' : type;
            const d = await api(`/subscribe/config?type=${cfg}`);
            if (!d.success) return;
            const item = d.data.find(x => x.id === id);
            if (!item) return alert('é…ç½®ä¸å­˜åœ¨');

            modalType = 'subscribe';
            editId = id;
            document.getElementById('modalTitle').textContent = `ç¼–è¾‘${type === 'vl' ? 'V<span>LESS</span>' : type.toUpperCase()}è®¢é˜…é…ç½®`;
            const label = type === 'vl' ? 'UUID' : 'å¯†ç ';
            document.getElementById('modalBody').innerHTML = `
<input type="hidden" id="subscribeType" value="${cfg}">
<div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="subRemark" value="${item.remark || ''}"></div>
<div class="form-group"><label>${label}</label><input type="text" id="subUuid" value="${item.uuid}"></div>
<div class="form-group"><label>Snippets/Worker åŸŸå</label><input type="text" id="subDomain" value="${item.snippets_domain}"></div>
`;
            document.getElementById('addModal').classList.remove('hidden');
        }

        async function toggleSubscribeEnable(id, enabled) {
            showLoading();
            try {
                const d = await api(`/subscribe/config/${id}`, 'PUT', { enabled });
                if (d.success) {
                    await loadVlConfig();
                    await loadSSConfig();
                } else alert(d.error);
            } finally { hideLoading() }
        }

        async function deleteSubscribeConfig(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤è®¢é˜…é…ç½®ï¼Ÿ')) return;
            showLoading();
            try {
                const d = await api(`/subscribe/config/${id}`, 'DELETE');
                if (d.success) {
                    await loadVlConfig();
                    await loadSSConfig();
                } else alert(d.error);
            } finally { hideLoading() }
        }

        async function resetSubscribeToken(id) {
            if (!confirm('ç¡®å®šé‡ç½®æ­¤è®¢é˜…çš„ Tokenï¼Ÿ\n\né‡ç½®åæ—§çš„è®¢é˜…åœ°å€å°†å¤±æ•ˆï¼Œéœ€è¦ä½¿ç”¨æ–°çš„è®¢é˜…åœ°å€ã€‚')) return;
            showLoading();
            try {
                const d = await api(`/subscribe/config/${id}/reset-token`, 'POST');
                if (d.success) {
                    await loadVlConfig();
                    await loadSSConfig();
                    alert(`Token å·²é‡ç½®\n\næ–° Token: ${d.data.token}`);
                } else alert(d.error);
            } finally { hideLoading() }
        }

        async function generateSS() {
            const password = document.getElementById('ssPasswordInput').value.trim();
            const domain = document.getElementById('ssDomainInput').value.trim();
            let path = document.getElementById('ssPathInput').value.trim();
            if (!path) path = '/' + password;
            if (!password || !domain) return alert('è¯·å¡«å†™å¯†ç å’ŒåŸŸå');

            showLoading();
            try {
                const d = await api('/subscribe/ss/generate', 'POST', { password, snippetsDomain: domain, proxyPath: path });
                if (d.success) {
                    const subUrl = location.origin + '/sub/ss/' + password;
                    // Clashè®¢é˜…åœ°å€å·²æš‚æ—¶æ³¨é‡Šï¼Œå¦‚éœ€ä½¿ç”¨è¯·å–æ¶ˆæ³¨é‡Š
                    // const clashUrl='https://sublink.eooce.com/clash?config='+encodeURIComponent(subUrl);
                    document.getElementById('ssSubUrl').textContent = subUrl;
                    // document.getElementById('ssClashUrl').textContent=clashUrl;
                    document.getElementById('ssResult').classList.remove('hidden');
                    document.getElementById('ssAlert').innerHTML = '<div class="alert alert-success">ä¿å­˜æˆåŠŸï¼Œå…±' + d.data.count + 'æ¡èŠ‚ç‚¹</div>';
                } else { document.getElementById('ssAlert').innerHTML = '<div class="alert alert-error">' + d.error + '</div>' }
            } finally {
                hideLoading();
            }
        }

        function copy(id) { navigator.clipboard.writeText(document.getElementById(id).textContent).then(() => alert('å·²å¤åˆ¶')) }

        function closeExitDetail() { document.getElementById('exitDetailModal').classList.add('hidden') }

        async function showExitDetail(id) {
            showLoading();
            try {
                const d = await api('/outbound');
                if (!d.success) return;
                const outbound = d.data.find(i => i.id === id);
                if (!outbound || (!outbound.entry_info_json && !outbound.exit_info_json)) {
                    alert('æš‚æ— å‡ºå…¥ç«™ä¿¡æ¯ï¼Œè¯·å…ˆè¿›è¡Œæ£€æµ‹');
                    return;
                }
                const entryInfo = outbound.entry_info_json ? JSON.parse(outbound.entry_info_json) : null;
                const exitInfo = outbound.exit_info_json ? JSON.parse(outbound.exit_info_json) : null;

                // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºæ˜¯/å¦æ ‡ç­¾
                const yesNo = (val) => val ? '<span style="background:#48c774;color:#fff;padding:3px 10px;border-radius:4px;font-size:12px">å¦</span>' : '<span style="background:#f14668;color:#fff;padding:3px 10px;border-radius:4px;font-size:12px">æ˜¯</span>';
                // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºç™¾åˆ†æ¯”æ ‡ç­¾
                const percent = (val) => {
                    const v = parseFloat(val) || 0;
                    const color = v < 10 ? '#48c774' : v < 30 ? '#ffdd57' : '#f14668';
                    return `<span style="background:${color};color:${v < 30 ? '#333' : '#fff'};padding:3px 10px;border-radius:4px;font-size:12px;font-weight:bold">${v.toFixed(2)}%</span>`;
                };

                const html = `
<div style="display:flex;gap:20px">
<div style="flex:1;background:#e8f5e9;padding:20px;border-radius:8px">
<h3 style="color:#2e7d32;margin:0 0 16px 0;text-align:center;font-size:18px">å…¥å£ä¿¡æ¯</h3>
<div style="line-height:2.4;font-size:14px">
<p><strong>IPåœ°å€ï¼š</strong>${entryInfo && entryInfo.ip || '-'}</p>
<p><strong>ç½‘ç»œçˆ¬è™«ï¼š</strong>${entryInfo && entryInfo.is_crawler !== undefined ? yesNo(entryInfo.is_crawler) : '-'}</p>
<p><strong>æ•°æ®ä¸­å¿ƒï¼š</strong>${entryInfo && entryInfo.is_datacenter !== undefined ? yesNo(entryInfo.is_datacenter) : '-'}</p>
<p><strong>Torç½‘ç»œï¼š</strong>${entryInfo && entryInfo.is_tor !== undefined ? yesNo(entryInfo.is_tor) : '-'}</p>
<p><strong>ä»£ç†ï¼š</strong>${entryInfo && entryInfo.is_proxy !== undefined ? yesNo(entryInfo.is_proxy) : '-'}</p>
<p><strong>VPNï¼š</strong>${entryInfo && entryInfo.is_vpn !== undefined ? yesNo(entryInfo.is_vpn) : '-'}</p>
<p><strong>æ»¥ç”¨è¡Œä¸ºï¼š</strong>${entryInfo && entryInfo.is_abuser !== undefined ? yesNo(entryInfo.is_abuser) : '-'}</p>
<p><strong>æ»¥ç”¨é£é™©è¯„åˆ†ï¼š</strong>${entryInfo && entryInfo.abuse_score !== undefined ? percent(entryInfo.abuse_score) : '-'}</p>
<p><strong>è‡ªæ²»ç³»ç»Ÿç¼–å·ï¼š</strong>${entryInfo && entryInfo.asn && entryInfo.asn.asn ? 'AS' + entryInfo.asn.asn : '-'}</p>
<p><strong>æ‰€å±ç»„ç»‡ï¼š</strong>${entryInfo && entryInfo.asn && entryInfo.asn.org || '-'}</p>
<p><strong>å›½å®¶ï¼š</strong>${entryInfo && entryInfo.location && entryInfo.location.country || '-'}</p>
<p><strong>åŸå¸‚ï¼š</strong>${entryInfo && entryInfo.location && entryInfo.location.city || '-'}</p>
</div>
</div>
<div style="flex:1;background:#e3f2fd;padding:20px;border-radius:8px">
<h3 style="color:#1976d2;margin:0 0 16px 0;text-align:center;font-size:18px">å‡ºå£ä¿¡æ¯</h3>
<div style="line-height:2.4;font-size:14px">
<p><strong>IPåœ°å€ï¼š</strong>${exitInfo && exitInfo.ip || '-'}</p>
<p><strong>ç½‘ç»œçˆ¬è™«ï¼š</strong>${exitInfo && exitInfo.is_crawler !== undefined ? yesNo(exitInfo.is_crawler) : '-'}</p>
<p><strong>æ•°æ®ä¸­å¿ƒï¼š</strong>${exitInfo && exitInfo.is_datacenter !== undefined ? yesNo(exitInfo.is_datacenter) : '-'}</p>
<p><strong>Torç½‘ç»œï¼š</strong>${exitInfo && exitInfo.is_tor !== undefined ? yesNo(exitInfo.is_tor) : '-'}</p>
<p><strong>ä»£ç†ï¼š</strong>${exitInfo && exitInfo.is_proxy !== undefined ? yesNo(exitInfo.is_proxy) : '-'}</p>
<p><strong>VPNï¼š</strong>${exitInfo && exitInfo.is_vpn !== undefined ? yesNo(exitInfo.is_vpn) : '-'}</p>
<p><strong>æ»¥ç”¨è¡Œä¸ºï¼š</strong>${exitInfo && exitInfo.is_abuser !== undefined ? yesNo(exitInfo.is_abuser) : '-'}</p>
<p><strong>æ»¥ç”¨é£é™©è¯„åˆ†ï¼š</strong>${exitInfo && exitInfo.abuse_score !== undefined ? percent(exitInfo.abuse_score) : '-'}</p>
<p><strong>è‡ªæ²»ç³»ç»Ÿç¼–å·ï¼š</strong>${exitInfo && exitInfo.asn && exitInfo.asn.asn ? 'AS' + exitInfo.asn.asn : '-'}</p>
<p><strong>æ‰€å±ç»„ç»‡ï¼š</strong>${exitInfo && exitInfo.asn && exitInfo.asn.org || '-'}</p>
<p><strong>å›½å®¶ï¼š</strong>${exitInfo && exitInfo.location && exitInfo.location.country || '-'}</p>
<p><strong>åŸå¸‚ï¼š</strong>${exitInfo && exitInfo.location && exitInfo.location.city || '-'}</p>
</div>
</div>
</div>
<div style="text-align:center;margin-top:16px;color:#999;font-size:13px">
æ£€æµ‹æ—¶é—´ï¼š${outbound.checked_at ? new Date(outbound.checked_at).toLocaleString('zh-CN') : '-'}
</div>
`;
                document.getElementById('exitDetailBody').innerHTML = html;
                document.getElementById('exitDetailModal').classList.remove('hidden');
            } finally {
                hideLoading();
            }
        }

        async function checkSingleExit(id) {
            const exitCell = document.getElementById('exit-' + id);
            const exitCardCell = document.getElementById('exit-card-' + id);
            if (!exitCell && !exitCardCell) return;

            // æ›´æ–°åŠ è½½çŠ¶æ€
            if (exitCell) {
                exitCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
            }
            if (exitCardCell) {
                exitCardCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
            }

            try {
                const d = await api('/check-exit', 'POST', { id });
                console.log('æ£€æµ‹ç»“æœ:', d);
                if (d.success && d.results && d.results.length > 0) {
                    const result = d.results[0];
                    console.log('å•ä¸ªç»“æœ:', result);
                    if (result.success) {
                        const country = result.country || '';
                        const city = result.city || '';
                        const exitInfo = country && city ? country + '-' + city : (country || city || 'æœªçŸ¥');
                        const checkTime = new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                        // æ›´æ–°åˆ—è¡¨è§†å›¾
                        if (exitCell) {
                            exitCell.innerHTML = `${exitInfo} <span style="font-size:11px;color:#999">(${checkTime})</span>`;
                            exitCell.className = 'exit-link';
                        }
                        // æ›´æ–°å¡ç‰‡è§†å›¾
                        if (exitCardCell) {
                            exitCardCell.textContent = exitInfo;
                            exitCardCell.className = 'exit-link';
                        }
                    } else {
                        // æ›´æ–°åˆ—è¡¨è§†å›¾
                        if (exitCell) {
                            exitCell.textContent = 'æ£€æµ‹å¤±è´¥';
                            exitCell.style.color = '#f14668';
                            exitCell.className = '';
                            exitCell.title = result.error || 'æœªçŸ¥é”™è¯¯';
                        }
                        // æ›´æ–°å¡ç‰‡è§†å›¾
                        if (exitCardCell) {
                            exitCardCell.textContent = 'æ£€æµ‹å¤±è´¥';
                            exitCardCell.style.color = '#f14668';
                            exitCardCell.className = '';
                        }
                        console.error('æ£€æµ‹å¤±è´¥:', result.error);
                    }
                } else {
                    if (exitCell) {
                        exitCell.textContent = 'æ£€æµ‹å¤±è´¥';
                        exitCell.style.color = '#f14668';
                        exitCell.className = '';
                    }
                    if (exitCardCell) {
                        exitCardCell.textContent = 'æ£€æµ‹å¤±è´¥';
                        exitCardCell.style.color = '#f14668';
                        exitCardCell.className = '';
                    }
                    console.error('APIè¿”å›é”™è¯¯:', d);
                }
            } catch (e) {
                if (exitCell) {
                    exitCell.textContent = 'é”™è¯¯';
                    exitCell.style.color = '#f14668';
                    exitCell.className = '';
                }
                if (exitCardCell) {
                    exitCardCell.textContent = 'é”™è¯¯';
                    exitCardCell.style.color = '#f14668';
                    exitCardCell.className = '';
                }
                console.error('æ£€æµ‹å¼‚å¸¸:', e);
            }
        }

        async function checkAllExits() {
            // è·å–æ‰€æœ‰å‹¾é€‰çš„checkboxï¼ˆåªé€‰æ‹©å¯è§çš„ï¼‰
            const checkedBoxes = Array.from(document.querySelectorAll('.outbound-check:checked')).filter(cb => {
                let el = cb;
                while (el) {
                    if (el.classList && el.classList.contains('hidden')) return false;
                    el = el.parentElement;
                }
                return true;
            });
            if (checkedBoxes.length === 0) return alert('è¯·å…ˆå‹¾é€‰è¦æ£€æµ‹çš„å‡ºç«™ä»£ç†');

            const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

            // æ›´æ–°åŠ è½½çŠ¶æ€
            ids.forEach(id => {
                const exitCell = document.getElementById('exit-' + id);
                const exitCardCell = document.getElementById('exit-card-' + id);
                if (exitCell) {
                    exitCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                }
                if (exitCardCell) {
                    exitCardCell.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite"></span>';
                }
            });

            try {
                const d = await api('/check-exit', 'POST', { ids });
                if (d.success && d.results) {
                    d.results.forEach(result => {
                        const exitCell = document.getElementById('exit-' + result.id);
                        const exitCardCell = document.getElementById('exit-card-' + result.id);
                        if (result.success) {
                            const country = result.country || '';
                            const city = result.city || '';
                            const exitInfo = country && city ? country + '-' + city : (country || city || 'æœªçŸ¥');
                            const checkTime = new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                            // æ›´æ–°åˆ—è¡¨è§†å›¾
                            if (exitCell) {
                                exitCell.innerHTML = `${exitInfo} <span style="font-size:11px;color:#999">(${checkTime})</span>`;
                                exitCell.className = 'exit-link';
                            }
                            // æ›´æ–°å¡ç‰‡è§†å›¾
                            if (exitCardCell) {
                                exitCardCell.textContent = exitInfo;
                                exitCardCell.className = 'exit-link';
                            }
                        } else {
                            // æ›´æ–°åˆ—è¡¨è§†å›¾
                            if (exitCell) {
                                exitCell.textContent = 'æ£€æµ‹å¤±è´¥';
                                exitCell.style.color = '#f14668';
                                exitCell.className = '';
                            }
                            // æ›´æ–°å¡ç‰‡è§†å›¾
                            if (exitCardCell) {
                                exitCardCell.textContent = 'æ£€æµ‹å¤±è´¥';
                                exitCardCell.style.color = '#f14668';
                                exitCardCell.className = '';
                            }
                        }
                    });
                }
            } catch (e) {
                alert('æ£€æµ‹å¤±è´¥: ' + e.message);
                ids.forEach(id => {
                    const exitCell = document.getElementById('exit-' + id);
                    const exitCardCell = document.getElementById('exit-card-' + id);
                    if (exitCell && exitCell.innerHTML.includes('spin')) {
                        exitCell.textContent = '-';
                        exitCell.style.color = '#999';
                        exitCell.className = '';
                    }
                    if (exitCardCell && exitCardCell.innerHTML.includes('spin')) {
                        exitCardCell.textContent = 'æœªæ£€æµ‹';
                        exitCardCell.style.color = '#999';
                        exitCardCell.className = '';
                    }
                });
            }
        }

        function checkAll(type, checked) {
            const className = type === 'proxyip' ? 'proxyip-check' : type === 'outbound' ? 'outbound-check' : type === 'argo' ? 'argo-check' : 'cfip-check';
            document.querySelectorAll('.' + className).forEach(cb => cb.checked = checked);
        }

        let batchType = '';
        function showBatchModal(type) {
            batchType = type;
            const titles = { 'proxyip': 'ProxyIP(åä»£IP)', 'outbound': 'å…¨å±€å‡ºç«™', 'cfip': 'CFIP(ä¼˜é€‰åŸŸå)', 'argo': 'ARGO è®¢é˜…' };
            document.getElementById('batchModalTitle').textContent = 'æ‰¹é‡æ·»åŠ  ' + titles[type];
            document.getElementById('batchInput').value = '';
            document.getElementById('batchAlert').innerHTML = '';
            if (type === 'proxyip') {
                document.getElementById('batchHelp').innerHTML = '<b>æ ¼å¼è¯´æ˜ï¼š</b>æ¯è¡Œä¸€æ¡ï¼Œæ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š<br>â€¢ IP/åŸŸå#å¤‡æ³¨<br>å¤‡æ³¨å¯é€‰ï¼Œæ²¡æœ‰å¤‡æ³¨åˆ™è‡ªåŠ¨ç”Ÿæˆ';
            } else if (type === 'outbound') {
                document.getElementById('batchHelp').innerHTML = '<b>æ ¼å¼è¯´æ˜ï¼š</b>æ¯è¡Œä¸€æ¡ï¼Œæ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š<br>â€¢ socks://base64(user:pass)@host:port#å¤‡æ³¨<br>â€¢ socks5://host:port#å¤‡æ³¨<br>â€¢ socks5://user:pass@host:port#å¤‡æ³¨<br>â€¢ http://host:port#å¤‡æ³¨<br>â€¢ http://user:pass@host:port#å¤‡æ³¨<br>å¤‡æ³¨å¯é€‰ï¼Œæ²¡æœ‰å¤‡æ³¨åˆ™è‡ªåŠ¨ç”Ÿæˆ';
            } else if (type === 'argo') {
                document.getElementById('batchHelp').innerHTML = '<b>æ ¼å¼è¯´æ˜ï¼š</b>æ¯è¡Œä¸€æ¡ V<span>LESS</span> æˆ– V<span>Mess</span> æ¨¡æ¿é“¾æ¥<br><b>V<span>LESS</span>ç¤ºä¾‹ï¼š</b><br><code>v' + 'less://12345678@example.com:443?encryption=none&security=tls&sni=argo.example.com&fp=firefox&type=ws&host=argo.example.com&path=%2Fvless-argo%3Fed%3D2560#ç¾å›½èŠ‚ç‚¹</code><br><b>V<span>Mess</span>ç¤ºä¾‹ï¼š</b><br><code>v' + 'mess://eyAidiI6ICIyIiwgInBzIjogIkFsdGFyZV9TRy1WdWx0ciIsICJhZGQiOiAiY25hbWUuanZ2di5kZSIsICJwb3J0IjogIjQ0MyIsICJpZCI6ICI1ZWZkMDQyMC1lM2MzLTQ1ZjMtYTMyNS00NmRlOTY1MjFhMzYiLCAiYWlkIjogIjAiLCAic2N5IjogIm5vbmUiLCAibmV0IjogIndzIiwgInR5cGUiOiAibm9uZSIsICJob3N0IjogInNlcnZlcjEubGVub2FzLmRlIiwgInBhdGgiOiAiL3ZtZXNzLWFyZ28/ZWQ9MjU2MCIsICJ0bHMiOiAidGxzIiwgInNuaSI6ICJzZXJ2ZXIxLmxlbm9hcy5kZSIsICJhbHBuIjogIiIsICJmcCI6ICJjaHJvbWUifQo=</code>';
            } else {
                document.getElementById('batchHelp').innerHTML = '<b>æ ¼å¼è¯´æ˜ï¼š</b>æ¯è¡Œä¸€æ¡ï¼Œæ ¼å¼ä¸ºï¼š<br>â€¢ IP/åŸŸå#åå­—#å¤‡æ³¨<br>â€¢ IP/åŸŸå:ç«¯å£#åå­—#å¤‡æ³¨<br>åå­—å’Œå¤‡æ³¨å¯é€‰ï¼Œåå­—ä¸è‡ªåŠ¨ç”Ÿæˆï¼Œå¤‡æ³¨é»˜è®¤ä¸ºç©º';
            }
            document.getElementById('batchModal').classList.remove('hidden');
        }

        function closeBatchModal() {
            document.getElementById('batchModal').classList.add('hidden');
            batchType = '';
        }

        async function exportData() {
            showLoading();
            try {
                const [proxyips, outbounds, cfips, argo, vlConfig, ssConfig] = await Promise.all([
                    api('/proxyip'),
                    api('/outbound'),
                    api('/cfip'),
                    api('/argo'),
                    api('/subscribe/v' + 'less/config'),
                    api('/subscribe/ss/config')
                ]);
                const exportData = {
                    version: '1.1',
                    timestamp: new Date().toISOString(),
                    proxyips: proxyips.success ? proxyips.data : [],
                    outbounds: outbounds.success ? outbounds.data : [],
                    cfips: cfips.success ? cfips.data : [],
                    argo: argo.success ? argo.data : [],
                    vlConfig: vlConfig.success ? vlConfig.data : {},
                    ssConfig: ssConfig.success ? ssConfig.data : {}
                };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cf-snippets-extend-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('å¯¼å‡ºæˆåŠŸ');
            } catch (e) {
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        function importData() {
            // ç›´æ¥æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©æ¨¡æ€æ¡†
            document.getElementById('importModeModal').classList.remove('hidden');
        }

        let importFileData = null;
        let importMode = 'append';

        function closeImportModeModal() {
            document.getElementById('importModeModal').classList.add('hidden');
            document.getElementById('importFileInput').value = '';
            importFileData = null;
        }

        async function confirmImportMode(mode) {
            importMode = mode;
            closeImportModeModal();
            // é€‰æ‹©æ¨¡å¼åï¼Œè§¦å‘æ–‡ä»¶é€‰æ‹©
            document.getElementById('importFileInput').click();
        }

        function handleImportFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (importMode === 'replace') {
                if (!confirm('è­¦å‘Šï¼šå®Œå…¨è¦†ç›–å¯¼å…¥å°†åˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®ï¼\\n\\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                    event.target.value = '';
                    return;
                }
            }

            showLoading();
            file.text().then(text => {
                try {
                    const data = JSON.parse(text);
                    if (!data.version || !data.proxyips || !data.outbounds || !data.cfips) {
                        throw new Error('æ— æ•ˆçš„å¯¼å…¥æ–‡ä»¶æ ¼å¼');
                    }
                    executeImport(data, importMode);
                } catch (e) {
                    hideLoading();
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯: ' + e.message);
                    event.target.value = '';
                }
            }).catch(e => {
                hideLoading();
                alert('è¯»å–æ–‡ä»¶å¤±è´¥: ' + e.message);
                event.target.value = '';
            });
        }

        async function executeImport(data, mode) {
            showLoading();
            try {
                if (mode === 'replace') {
                    // å®Œå…¨è¦†ç›–æ¨¡å¼ï¼šå…ˆåˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®
                    const [existingProxyips, existingOutbounds, existingCfips, existingArgo] = await Promise.all([
                        api('/proxyip'),
                        api('/outbound'),
                        api('/cfip'),
                        api('/argo')
                    ]);

                    const deletePromises = [];
                    if (existingProxyips.success) {
                        deletePromises.push(...existingProxyips.data.map(item => api('/proxyip/' + item.id, 'DELETE')));
                    }
                    if (existingOutbounds.success) {
                        deletePromises.push(...existingOutbounds.data.map(item => api('/outbound/' + item.id, 'DELETE')));
                    }
                    if (existingCfips.success) {
                        deletePromises.push(...existingCfips.data.map(item => api('/cfip/' + item.id, 'DELETE')));
                    }
                    if (existingArgo.success) {
                        deletePromises.push(...existingArgo.data.map(item => api('/argo/' + item.id, 'DELETE')));
                    }
                    await Promise.all(deletePromises);
                }

                // å¯¼å…¥æ–°æ•°æ®ï¼ˆä¸¤ç§æ¨¡å¼éƒ½æ‰§è¡Œï¼‰
                const results = await Promise.all([
                    ...data.proxyips.map(item => api('/proxyip', 'POST', { address: item.address, remark: item.remark, enabled: item.enabled })),
                    ...data.outbounds.map(item => api('/outbound', 'POST', { address: item.address, remark: item.remark, enabled: item.enabled })),
                    ...data.cfips.map(item => api('/cfip', 'POST', { address: item.address, port: item.port, remark: item.remark, name: item.name, enabled: item.enabled, fail_count: item.fail_count, status: item.status })),
                    ...(data.argo || []).map(item => api('/argo', 'POST', { template_link: item.template_link, remark: item.remark, enabled: item.enabled }))
                ]);

                // æ›´æ–° V<span>LESS</span> é…ç½®
                if (data.vlConfig && data.vlConfig.uuid) {
                    await api('/subscribe/v' + 'less/generate', 'POST', { uuid: data.vlConfig.uuid, snippetsDomain: data.vlConfig.snippets_domain, proxyPath: data.vlConfig.proxy_path });
                }

                // æ›´æ–° SS é…ç½®
                if (data.ssConfig && data.ssConfig.password) {
                    await api('/subscribe/ss/generate', 'POST', { password: data.ssConfig.password, snippetsDomain: data.ssConfig.snippets_domain, proxyPath: data.ssConfig.proxy_path });
                }

                // å…¼å®¹æ—§ç‰ˆæœ¬å¯¼å‡ºæ ¼å¼ï¼ˆconfig å­—æ®µï¼‰
                if (data.config && data.config.uuid && !data.vlConfig) {
                    await api('/subscribe/v' + 'less/generate', 'POST', { uuid: data.config.uuid, snippetsDomain: data.config.snippets_domain, proxyPath: data.config.proxy_path });
                }

                await load();
                const modeText = mode === 'replace' ? 'è¦†ç›–å¯¼å…¥' : 'æ–°å¢å¯¼å…¥';
                alert(modeText + 'æˆåŠŸï¼');
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥: ' + e.message);
            } finally {
                hideLoading();
                document.getElementById('importFileInput').value = '';
            }
        }


        async function submitBatch() {
            const input = document.getElementById('batchInput').value.trim();
            if (!input) return alert('è¯·è¾“å…¥æ•°æ®');

            const lines = input.split(/\r?\n/).filter(l => l.trim());
            if (lines.length === 0) return alert('æ²¡æœ‰æœ‰æ•ˆæ•°æ®');

            const items = [];
            const errors = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const lineNum = i + 1;

                try {
                    if (batchType === 'proxyip') {
                        // ProxyIP æ ¼å¼ï¼šåœ°å€#å¤‡æ³¨ï¼ˆä¸å…è®¸ socks5/httpï¼‰
                        const parts = line.split('#');
                        const address = parts[0].trim();
                        const remark = parts[1] ? parts[1].trim() : '';
                        if (!address) throw new Error('åœ°å€ä¸èƒ½ä¸ºç©º');
                        if (address.startsWith('socks') || address.startsWith('http')) throw new Error('SOCKS5/HTTP è¯·æ·»åŠ åˆ°å…¨å±€å‡ºç«™');
                        items.push({ address, remark: remark || undefined });
                    } else if (batchType === 'outbound') {
                        // Outbound æ ¼å¼ï¼šsocks5://... æˆ– http://...#å¤‡æ³¨
                        const parts = line.split('#');
                        let address = parts[0].trim();
                        const remark = parts[1] ? parts[1].trim() : '';
                        if (!address) throw new Error('åœ°å€ä¸èƒ½ä¸ºç©º');
                        if (!address.startsWith('socks') && !address.startsWith('http')) throw new Error('å¿…é¡»æ˜¯ socks5:// æˆ– http:// æ ¼å¼');

                        // å¤„ç† socks:// æ ¼å¼ï¼ˆbase64 user infoï¼‰
                        if (address.startsWith('socks://')) {
                            try {
                                const urlStr = address.replace(/^socks:\/\//, 'socks5://');
                                const url = new URL(urlStr);
                                let username = url.username ? decodeURIComponent(url.username) : '';
                                let password = url.password ? decodeURIComponent(url.password) : '';

                                if (username && !password) {
                                    try {
                                        const decoded = atob(username);
                                        if (decoded.includes(':')) {
                                            const parts = decoded.split(':');
                                            username = parts[0];
                                            password = parts.slice(1).join(':');
                                            // é‡æ„ä¸º socks5://user:pass@host:port
                                            address = `socks5://${encodeURIComponent(username)}:${encodeURIComponent(password)}@${url.hostname}:${url.port}`;
                                        }
                                    } catch (e) {
                                        // ignore conversion error
                                    }
                                } else {
                                    // å¦‚æœæ ‡å‡† socks:// ä½†æ²¡æœ‰ base64 è½¬æ¢éœ€æ±‚ï¼Œä¹Ÿè½¬ä¸º socks5:// ä»¥ä¾¿åç«¯ç»Ÿä¸€å¤„ç†
                                    address = urlStr;
                                }
                            } catch (e) {
                                // ignore URL parse error
                            }
                        }

                        items.push({ address, remark: remark || undefined });
                    } else if (batchType === 'argo') {
                        // ARGO æ ¼å¼ï¼švl://... æˆ– vm://...
                        const remarkMatch = line.match(/#(.+)$/);
                        let remark = '';
                        if (line.startsWith('vl' + 'ess://')) {
                            remark = remarkMatch ? decodeURIComponent(remarkMatch[1]) : '';
                        } else if (line.startsWith('vm' + 'ess://')) {
                            // VMæ ¼å¼ï¼Œä»base64è§£ç ä¸­æå–å¤‡æ³¨
                            try {
                                const base64Data = line.substring(8);
                                const jsonStr = atob(base64Data);
                                const vmConfig = JSON.parse(jsonStr);
                                remark = vmConfig.ps || '';
                            } catch (e) {
                                remark = '';
                            }
                        } else {
                            throw new Error('å¿…é¡»æ˜¯ vl' + 'ess:// æˆ– vm' + 'ess:// æ ¼å¼');
                        }
                        items.push({ template_link: line, remark: remark || undefined });
                    } else {
                        // CFIP æ ¼å¼ï¼šåœ°å€#åå­—#å¤‡æ³¨
                        // æˆ– åœ°å€:ç«¯å£#åå­—#å¤‡æ³¨ (ä½†ç«¯å£ç›®å‰ä¸»è¦é€šè¿‡ input æ§åˆ¶ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†)

                        const parts = line.split('#');
                        let address = parts[0].trim();
                        let name = parts[1] ? parts[1].trim() : undefined;
                        let remark = parts[2] ? parts[2].trim() : undefined;

                        if (!address) throw new Error('åœ°å€ä¸èƒ½ä¸ºç©º');

                        let port = 443;
                        if (address.includes(':')) {
                            const ap = address.split(':');
                            address = ap[0].trim();
                            port = parseInt(ap[1]) || 443;
                        }

                        items.push({ address, port, name, remark });
                    }
                } catch (e) {
                    errors.push(`ç¬¬${lineNum}è¡Œ: ${e.message}`);
                }
            }

            // æ‰¹é‡æŸ¥é‡
            const uniqueItems = [];
            // ç”¨äºæ£€æŸ¥æœ¬æ¬¡æ‰¹é‡ä¸­çš„é‡å¤é¡¹
            const currentBatchKeys = new Set();

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                let isDup = false;
                let key = '';

                if (batchType === 'proxyip') {
                    key = item.address;
                } else if (batchType === 'outbound') {
                    key = item.address;
                } else if (batchType === 'cfip') {
                    key = item.address + ':' + item.port;
                } else if (batchType === 'argo') {
                    key = item.template_link;
                }

                if (checkDuplicate(batchType, item)) {
                    errors.push(`é‡å¤æ•°æ®å·²è·³è¿‡: ${key}`);
                    isDup = true;
                } else if (currentBatchKeys.has(key)) {
                    errors.push(`æœ¬æ¬¡æ‰¹é‡é‡å¤å·²è·³è¿‡: ${key}`);
                    isDup = true;
                }

                if (!isDup) {
                    uniqueItems.push(item);
                    currentBatchKeys.add(key);
                }
            }

            // å¦‚æœåªæœ‰é‡å¤é”™è¯¯ï¼Œä¸”æ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œåˆ™åœæ­¢
            if (uniqueItems.length === 0 && errors.length > 0) {
                document.getElementById('batchAlert').innerHTML = '<div class="alert alert-error">æ‰€æœ‰æ•°æ®å‡ä¸ºé‡å¤æˆ–æ ¼å¼é”™è¯¯<br>' + errors.join('<br>') + '</div>';
                return;
            }

            // å¦‚æœæœ‰éƒ¨åˆ†é”™è¯¯ï¼ˆæ ¼å¼é”™è¯¯æˆ–é‡å¤ï¼‰ï¼Œä½†ä¹Ÿæœ‰æœ‰æ•ˆæ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤ºä½†ç»§ç»­æ‰§è¡Œ
            if (errors.length > 0) {
                document.getElementById('batchAlert').innerHTML = '<div class="alert alert-warning">ä»¥ä¸‹æ•°æ®å­˜åœ¨é—®é¢˜è¢«è·³è¿‡ï¼Œå°†ç»§ç»­æ·»åŠ å‰©ä½™æ•°æ®ï¼š<br>' + errors.join('<br>') + '</div>';
            }

            // æ‰¹é‡æ·»åŠ 
            showLoading();
            let success = 0, failed = 0;
            for (const item of uniqueItems) {
                try {
                    const d = await api('/' + batchType, 'POST', item);
                    if (d.success) success++; else failed++;
                } catch (e) {
                    failed++;
                }
            }
            hideLoading();

            document.getElementById('batchAlert').innerHTML = `<div class="alert alert-success">æˆåŠŸæ·»åŠ  ${success} æ¡${failed > 0 ? 'ï¼Œå¤±è´¥ ' + failed + ' æ¡' : ''}</div>`;
            if (batchType === 'proxyip') await loadProxyIPs();
            else if (batchType === 'outbound') await loadOutbounds();
            else if (batchType === 'argo') await loadArgoSubscribes();
            else await loadCFIPs();

            if (failed === 0) {
                setTimeout(() => closeBatchModal(), 1500);
            }
        }

        async function batchEnable(type, enabled) {
            const className = type === 'proxyip' ? 'proxyip-check' : type === 'outbound' ? 'outbound-check' : type === 'argo' ? 'argo-check' : 'cfip-check';
            // åªé€‰æ‹©å¯è§çš„å¤é€‰æ¡†ï¼ˆæ’é™¤éšè—çš„è§†å›¾ï¼‰
            const checks = Array.from(document.querySelectorAll('.' + className + ':checked')).filter(cb => {
                let el = cb;
                while (el) {
                    if (el.classList && el.classList.contains('hidden')) return false;
                    el = el.parentElement;
                }
                return true;
            });
            if (checks.length === 0) return alert('è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„é¡¹');

            if (!confirm(`ç¡®å®š${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}é€‰ä¸­çš„ ${checks.length} é¡¹ï¼Ÿ`)) return;

            showLoading();
            let success = 0, failed = 0;
            for (const cb of checks) {
                try {
                    const d = await api('/' + type + '/' + cb.value, 'PUT', { enabled });
                    if (d.success) success++; else failed++;
                } catch (e) {
                    failed++;
                }
            }
            hideLoading();

            alert(`æ“ä½œå®Œæˆï¼šæˆåŠŸ ${success} æ¡${failed > 0 ? 'ï¼Œå¤±è´¥ ' + failed + ' æ¡' : ''}`);
            if (type === 'proxyip') await loadProxyIPs();
            else if (type === 'outbound') await loadOutbounds();
            else if (type === 'argo') await loadArgoSubscribes();
            else await loadCFIPs();
        }

        async function batchSetStatus(type) {
            const statusSelect = document.getElementById(type + 'BatchStatus');
            const status = statusSelect ? statusSelect.value : 'enabled';
            const className = type === 'proxyip' ? 'proxyip-check' : type === 'outbound' ? 'outbound-check' : type === 'argo' ? 'argo-check' : 'cfip-check';

            // åªé€‰æ‹©å¯è§çš„å¤é€‰æ¡†ï¼ˆæ’é™¤éšè—çš„è§†å›¾ï¼‰
            const checks = Array.from(document.querySelectorAll('.' + className + ':checked')).filter(cb => {
                let el = cb;
                while (el) {
                    if (el.classList && el.classList.contains('hidden')) return false;
                    el = el.parentElement;
                }
                return true;
            });
            if (checks.length === 0) return alert('è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„é¡¹');

            const statusNames = { enabled: 'å¯ç”¨', disabled: 'ç¦ç”¨', invalid: 'å¤±æ•ˆ' };
            if (!confirm(`ç¡®å®šå°†é€‰ä¸­çš„ ${checks.length} é¡¹è®¾ç½®ä¸º"${statusNames[status]}"çŠ¶æ€ï¼Ÿ`)) return;

            showLoading();
            let success = 0, failed = 0;
            const enabled = status === 'enabled';
            for (const cb of checks) {
                try {
                    const d = await api('/' + type + '/' + cb.value, 'PUT', { status, enabled });
                    if (d.success) success++; else failed++;
                } catch (e) {
                    failed++;
                }
            }
            hideLoading();

            alert(`æ“ä½œå®Œæˆï¼šæˆåŠŸ ${success} æ¡${failed > 0 ? 'ï¼Œå¤±è´¥ ' + failed + ' æ¡' : ''}`);
            if (type === 'proxyip') await loadProxyIPs();
            else if (type === 'outbound') await loadOutbounds();
            else if (type === 'argo') await loadArgoSubscribes();
            else await loadCFIPs();
        }

        async function batchDelete(type) {
            const className = type === 'proxyip' ? 'proxyip-check' : type === 'outbound' ? 'outbound-check' : type === 'argo' ? 'argo-check' : 'cfip-check';
            // åªé€‰æ‹©å¯è§çš„å¤é€‰æ¡†ï¼ˆæ’é™¤éšè—çš„è§†å›¾ï¼‰
            const checks = Array.from(document.querySelectorAll('.' + className + ':checked')).filter(cb => {
                let el = cb;
                while (el) {
                    if (el.classList && el.classList.contains('hidden')) return false;
                    el = el.parentElement;
                }
                return true;
            });
            if (checks.length === 0) return alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹');

            if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${checks.length} é¡¹ï¼Ÿ`)) return;

            showLoading();
            let success = 0, failed = 0;
            for (const cb of checks) {
                try {
                    const d = await api('/' + type + '/' + cb.value, 'DELETE');
                    if (d.success) success++; else failed++;
                } catch (e) {
                    failed++;
                }
            }
            hideLoading();

            alert(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${success} æ¡${failed > 0 ? 'ï¼Œå¤±è´¥ ' + failed + ' æ¡' : ''}`);
            if (type === 'proxyip') await loadProxyIPs();
            else if (type === 'outbound') await loadOutbounds();
            else if (type === 'argo') await loadArgoSubscribes();
            else await loadCFIPs();
        }
    </script>
</body>

</html>