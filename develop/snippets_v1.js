import{connect as $c}from'cloudflare:sockets';let $p='';let $u='c92240e7-ecb8-4570-b7a1-23e72eb8690e';function $f(a,o=0){const h=[...a.slice(o,o+16)].map(b=>b.toString(16).padStart(2,'0')).join('');return`${h.substring(0,8)}-${h.substring(8,12)}-${h.substring(12,16)}-${h.substring(16,20)}-${h.substring(20)}`}function $b(s){if(!s)return{e:null};try{const b=atob(s.replace(/-/g,'+').replace(/_/g,'/'));const y=new Uint8Array(b.length);for(let i=0;i<b.length;i++)y[i]=b.charCodeAt(i);return{d:y.buffer,e:null}}catch(e){return{e}}}function $q(s){try{if(s.readyState===WebSocket.OPEN||s.readyState===WebSocket.CLOSING)s.close()}catch(e){}}function $s(h){const d=['speedtest.net','fast.com','speedtest.cn','speed.cloudflare.com','ovo.speedtestcustom.com'];if(d.includes(h))return true;for(const x of d)if(h.endsWith('.'+x)||h===x)return true;return false}function $pp(s){if(!s)return null;s=s.trim();if(s.startsWith('socks://')||s.startsWith('socks5://')){const u=s.replace(/^socks:\/\//,'socks5://');try{const l=new URL(u);return{t:'socks5',h:l.hostname,p:parseInt(l.port)||1080,u:l.username?decodeURIComponent(l.username):'',w:l.password?decodeURIComponent(l.password):''}}catch(e){return null}}if(s.startsWith('http://')||s.startsWith('https://')){try{const l=new URL(s);return{t:'http',h:l.hostname,p:parseInt(l.port)||(s.startsWith('https://')?443:80),u:l.username?decodeURIComponent(l.username):'',w:l.password?decodeURIComponent(l.password):''}}catch(e){return null}}if(s.startsWith('[')){const c=s.indexOf(']');if(c>0){const h=s.substring(1,c);const r=s.substring(c+1);if(r.startsWith(':')){const p=parseInt(r.substring(1),10);if(!isNaN(p)&&p>0&&p<=65535)return{t:'direct',h,p}}return{t:'direct',h,p:443}}}const l=s.lastIndexOf(':');if(l>0){const h=s.substring(0,l);const p=parseInt(s.substring(l+1),10);if(!isNaN(p)&&p>0&&p<=65535)return{t:'direct',h,p}}return{t:'direct',h:s,p:443}}export default{async fetch(r,e,c){try{const u=new URL(r.url);const p=u.pathname;let pp=null;if(p.startsWith('/proxyip=')){try{pp=decodeURIComponent(p.substring(9)).trim()}catch(e){}if(pp&&!r.headers.get('Upgrade')){$p=pp;return new Response(`set proxyIP to: ${$p}\n\n`,{headers:{'Content-Type':'text/plain; charset=utf-8','Cache-Control':'no-store, no-cache, must-revalidate, max-age=0'}})}}if(r.headers.get('Upgrade')==='websocket'){let w=null;if(p.startsWith('/proxyip=')){try{w=decodeURIComponent(p.substring(9)).trim()}catch(e){}}const cp=w||u.searchParams.get('proxyip')||r.headers.get('proxyip');return await $h(r,cp)}return new Response('Worker is running',{status:200})}catch(err){return new Response('Internal Server Error',{status:500})}}};async function $h(r,cp){const w=new WebSocketPair();const[c,s]=Object.values(w);s.accept();let rc={s:null};let id=false;const ed=r.headers.get('sec-websocket-protocol')||'';const rd=$m(s,ed);rd.pipeTo(new WritableStream({async write(k){if(id)return await $u2(k,s,null);if(rc.s){const w=rc.s.writable.getWriter();await w.write(k);w.releaseLock();return}const{e,m,t,p,h,i,v,u}=$pw(k,$u);if(e)throw new Error(m);if($s(h))throw new Error('Speedtest site is blocked');if(u){if(p===53)id=true;else throw new Error('UDP is not supported')}const rh=new Uint8Array([v[0],0]);const raw=k.slice(i);if(id)return $u2(raw,s,rh);await $ft(t,h,p,raw,s,rh,rc,cp)}})).catch((e)=>{});return new Response(null,{status:101,webSocket:c})}async function $c5(pc,th,tp,id){const{h,p,u,w}=pc;let s;try{s=$c({hostname:h,port:p});const wr=s.writable.getWriter();const rd=s.readable.getReader();try{const am=u&&w?new Uint8Array([0x05,0x02,0x00,0x02]):new Uint8Array([0x05,0x01,0x00]);await wr.write(am);const mr=await rd.read();if(mr.done||mr.value.byteLength<2)throw new Error('S5 method selection failed');const sm=new Uint8Array(mr.value)[1];if(sm===0x02){if(!u||!w)throw new Error('S5 requires authentication');const ub=new TextEncoder().encode(u);const pb=new TextEncoder().encode(w);const ap=new Uint8Array(3+ub.length+pb.length);ap[0]=0x01;ap[1]=ub.length;ap.set(ub,2);ap[2+ub.length]=pb.length;ap.set(pb,3+ub.length);await wr.write(ap);const ar=await rd.read();if(ar.done||new Uint8Array(ar.value)[1]!==0x00)throw new Error('S5 authentication failed')}else if(sm!==0x00)throw new Error(`S5 unsupported auth method: ${sm}`);const hb=new TextEncoder().encode(th);const cp=new Uint8Array(7+hb.length);cp[0]=0x05;cp[1]=0x01;cp[2]=0x00;cp[3]=0x03;cp[4]=hb.length;cp.set(hb,5);new DataView(cp.buffer).setUint16(5+hb.length,tp,false);await wr.write(cp);const cr=await rd.read();if(cr.done||new Uint8Array(cr.value)[1]!==0x00)throw new Error('S5 connection failed');await wr.write(id);wr.releaseLock();rd.releaseLock();return s}catch(e){wr.releaseLock();rd.releaseLock();throw e}}catch(e){if(s)try{s.close()}catch(e){}throw e}}async function $ch(pc,th,tp,id){const{h,p,u,w}=pc;let s;try{s=$c({hostname:h,port:p});const wr=s.writable.getWriter();const rd=s.readable.getReader();try{let rq=`CONNECT ${th}:${tp} HTTP/1.1\r\nHost: ${th}:${tp}\r\n`;if(u&&w)rq+=`Proxy-Authorization: Basic ${btoa(`${u}:${w}`)}\r\n`;rq+=`User-Agent: Mozilla/5.0\r\nConnection: keep-alive\r\n\r\n`;await wr.write(new TextEncoder().encode(rq));let rb=new Uint8Array(0);let he=-1;let br=0;const ms=8192,st=Date.now(),tm=10000;while(he===-1&&br<ms){if(Date.now()-st>tm)throw new Error('connection timeout');const{done,value:v}=await rd.read();if(done)throw new Error('Connection closed before receiving HTTP response');const nb=new Uint8Array(rb.length+v.length);nb.set(rb);nb.set(v,rb.length);rb=nb;br=rb.length;for(let i=0;i<rb.length-3;i++){if(rb[i]===0x0d&&rb[i+1]===0x0a&&rb[i+2]===0x0d&&rb[i+3]===0x0a){he=i+4;break}}}if(he===-1)throw new Error('Invalid HTTP response or response too large');const ht=new TextDecoder().decode(rb.slice(0,he));const sl=ht.split('\r\n')[0];const sm=sl.match(/HTTP\/\d\.\d\s+(\d+)/);if(!sm)throw new Error(`Invalid response: ${sl}`);const sc=parseInt(sm[1]);if(sc<200||sc>=300)throw new Error(`Connection failed with status ${sc}: ${sl}`);await wr.write(id);wr.releaseLock();rd.releaseLock();return s}catch(e){try{wr.releaseLock()}catch(e){}try{rd.releaseLock()}catch(e){}throw e}}catch(e){if(s)try{s.close()}catch(e){}throw e}}async function $ft(at,h,pn,rd,ws,rh,rc,cp){async function cd(a,p,d){const rs=$c({hostname:a,port:p});const w=rs.writable.getWriter();await w.write(d);w.releaseLock();return rs}let pc=null,sp=false;if(cp){pc=$pp(cp);if(pc&&(pc.t==='socks5'||pc.t==='http'||pc.t==='https'))sp=true;else if(!pc)pc=$pp($p)||{t:'direct',h:$p,p:443}}else{pc=$pp($p)||{t:'direct',h:$p,p:443};if(pc.t==='socks5'||pc.t==='http'||pc.t==='https')sp=true}async function cwp(){let ns;if(pc.t==='socks5')ns=await $c5(pc,h,pn,rd);else if(pc.t==='http'||pc.t==='https')ns=await $ch(pc,h,pn,rd);else ns=await cd(pc.h,pc.p,rd);rc.s=ns;ns.closed.catch(()=>{}).finally(()=>$q(ws));$cs(ns,ws,rh,null)}if(sp){try{await cwp()}catch(e){throw e}}else{try{const is=await cd(h,pn,rd);rc.s=is;$cs(is,ws,rh,cwp)}catch(e){await cwp()}}}function $pw(c,t){if(c.byteLength<24)return{e:true,m:'Invalid data'};const v=new Uint8Array(c.slice(0,1));if($f(new Uint8Array(c.slice(1,17)))!==t)return{e:true,m:'Invalid uuid'};const o=new Uint8Array(c.slice(17,18))[0];const cm=new Uint8Array(c.slice(18+o,19+o))[0];let u=false;if(cm===1){}else if(cm===2){u=true}else{return{e:true,m:'Invalid cmd'}}const pi=19+o;const p=new DataView(c.slice(pi,pi+2)).getUint16(0);let ai=pi+2,al=0,avi=ai+1,h='';const at=new Uint8Array(c.slice(ai,avi))[0];switch(at){case 1:al=4;h=new Uint8Array(c.slice(avi,avi+al)).join('.');break;case 2:al=new Uint8Array(c.slice(avi,avi+1))[0];avi+=1;h=new TextDecoder().decode(c.slice(avi,avi+al));break;case 3:al=16;const i6=[];const i6v=new DataView(c.slice(avi,avi+al));for(let i=0;i<8;i++)i6.push(i6v.getUint16(i*2).toString(16));h=i6.join(':');break;default:return{e:true,m:`Invalid address type: ${at}`}}if(!h)return{e:true,m:`Invalid address: ${at}`};return{e:false,t:at,p,h,u,i:avi+al,v}}function $m(s,eh){let c=false;return new ReadableStream({start(ct){s.addEventListener('message',(e)=>{if(!c)ct.enqueue(e.data)});s.addEventListener('close',()=>{if(!c){$q(s);ct.close()}});s.addEventListener('error',(e)=>ct.error(e));const{d,e}=$b(eh);if(e)ct.error(e);else if(d)ct.enqueue(d)},cancel(){c=true;$q(s)}})}async function $cs(rs,ws,h,rf){let hd=h,hd2=false;await rs.readable.pipeTo(new WritableStream({async write(c,ct){hd2=true;if(ws.readyState!==WebSocket.OPEN)ct.error('ws.readyState is not open');if(hd){const r=new Uint8Array(hd.length+c.byteLength);r.set(hd,0);r.set(c,hd.length);ws.send(r.buffer);hd=null}else{ws.send(c)}},abort(){}})).catch((e)=>{console.error('Stream pipe error:',e);$q(ws)});if(!hd2&&rf){console.log('No data received, retrying...');await rf()}}async function $u2(c,ws,rh){try{const ts=$c({hostname:'8.8.4.4',port:53});let vh=rh;const w=ts.writable.getWriter();await w.write(c);w.releaseLock();await ts.readable.pipeTo(new WritableStream({async write(c){if(ws.readyState===WebSocket.OPEN){if(vh){const r=new Uint8Array(vh.length+c.byteLength);r.set(vh,0);r.set(c,vh.length);ws.send(r.buffer);vh=null}else{ws.send(c)}}}}))}catch(e){}}